<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SharkFarm</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:         #06080f;
  --bg2:        #0c1020;
  --bg3:        #131928;
  --bg4:        #1a2235;
  --border:     rgba(255,255,255,0.06);
  --accent:     #e63946;
  --accent2:    #ff6b35;
  --green:      #22c55e;
  --gold:       #f59e0b;
  --cyan:       #06b6d4;
  --purple:     #8b5cf6;
  --blue:       #3b82f6;
  --text:       #e2e8f0;
  --text2:      #94a3b8;
  --text3:      #475569;
  --sidebar-w:  248px;
  --topbar-h:   58px;
  --radius:     10px;
  --radius-sm:  7px;
  --transition: 0.15s cubic-bezier(0.4,0,0.2,1);
}

html, body {
  background: var(--bg);
  color: var(--text);
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  height: 100vh;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
}

/* Background */
body::before {
  content: '';
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 60% 50% at 75% 15%, rgba(230,57,70,0.07) 0%, transparent 55%),
    radial-gradient(ellipse 40% 40% at 15% 85%, rgba(255,107,53,0.05) 0%, transparent 50%),
    radial-gradient(ellipse 50% 60% at 50% 50%, rgba(6,182,212,0.03) 0%, transparent 60%);
  pointer-events: none; z-index: 0;
  animation: bgPulse 20s ease-in-out infinite alternate;
}
@keyframes bgPulse { 0%{opacity:.6} 100%{opacity:1} }

body::after {
  content: '';
  position: fixed; inset: 0; pointer-events: none; z-index: 0;
  background-image: linear-gradient(rgba(230,57,70,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(230,57,70,0.015) 1px, transparent 1px);
  background-size: 40px 40px;
}

.layout { display: flex; height: 100vh; position: relative; z-index: 1; }

/* ‚ïê‚ïê SIDEBAR ‚ïê‚ïê */
.sidebar {
  width: var(--sidebar-w);
  height: 100vh;
  background: rgba(10,14,26,0.96);
  border-right: 1px solid rgba(230,57,70,0.1);
  display: flex; flex-direction: column; flex-shrink: 0;
  position: relative; z-index: 10;
  backdrop-filter: blur(24px);
}
.sidebar::after {
  content: '';
  position: absolute; right: -1px; top: 10%; bottom: 10%;
  width: 1px;
  background: linear-gradient(180deg, transparent, rgba(230,57,70,0.6), transparent);
}

.sidebar-logo {
  padding: 18px 18px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  display: flex; align-items: center; gap: 11px;
}
.logo-icon-wrap { position: relative; width: 38px; height: 38px; flex-shrink: 0; }
.logo-ring {
  position: absolute; inset: -2px; border-radius: 11px;
  background: conic-gradient(from 0deg, var(--accent), var(--accent2), #ff1744, var(--accent2), var(--accent));
  animation: spin 4s linear infinite;
}
.logo-ring::after { content:''; position:absolute; inset:2px; border-radius:9px; background:var(--bg2); }
@keyframes spin { to { transform: rotate(360deg); } }
.logo-icon { position:relative; z-index:2; width:38px; height:38px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:18px; }
.logo-name { font-family:'Rajdhani',sans-serif; font-weight:700; font-size:17px; letter-spacing:2px; background:linear-gradient(135deg,#fff 0%,var(--accent) 55%,var(--accent2) 100%); background-size:200%; -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; animation:logoShimmer 5s ease infinite; }
@keyframes logoShimmer { 0%,100%{background-position:0%} 50%{background-position:100%} }
.logo-sub { font-size:9px; color:var(--text3); letter-spacing:2px; text-transform:uppercase; margin-top:1px; }

.sidebar-status {
  margin: 12px 14px;
  padding: 8px 11px;
  border-radius: var(--radius-sm);
  background: rgba(34,197,94,0.07);
  border: 1px solid rgba(34,197,94,0.18);
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; font-weight: 600; color: var(--green);
  cursor: pointer; transition: var(--transition);
}
.sidebar-status.offline { background:rgba(230,57,70,0.07); border-color:rgba(230,57,70,0.18); color:var(--accent); }
.status-dot { width:7px; height:7px; border-radius:50%; background:var(--green); box-shadow:0 0 8px var(--green); animation:pulse 2s ease infinite; flex-shrink:0; }
.offline .status-dot { background:var(--accent); box-shadow:0 0 8px var(--accent); }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.35;transform:scale(.65)} }
.status-text { flex:1; }
.status-ver { font-size:10px; color:var(--text3); font-weight:400; }

.sidebar-nav { flex:1; padding:8px 10px; display:flex; flex-direction:column; gap:1px; overflow-y:auto; }
.nav-section { font-size:9px; font-weight:700; letter-spacing:1.5px; text-transform:uppercase; color:var(--text3); padding:10px 10px 4px; margin-top:4px; }
.nav-item {
  display:flex; align-items:center; gap:9px;
  padding:8px 11px; border-radius:var(--radius-sm);
  cursor:pointer; font-size:13px; font-weight:500; color:var(--text2);
  transition:var(--transition); border:none; background:none; width:100%; text-align:left;
  position:relative;
}
.nav-item:hover { background:rgba(255,255,255,0.04); color:var(--text); }
.nav-item.active { background:linear-gradient(135deg,rgba(230,57,70,0.18),rgba(255,107,53,0.1)); color:var(--accent); }
.nav-item.active::before { content:''; position:absolute; left:0; top:20%; bottom:20%; width:2px; border-radius:0 2px 2px 0; background:var(--accent); box-shadow:0 0 8px var(--accent); }
.nav-icon { font-size:15px; width:18px; text-align:center; }
.nav-badge { margin-left:auto; background:rgba(230,57,70,0.18); color:var(--accent); border-radius:10px; padding:1px 7px; font-size:10px; font-weight:700; }

.sidebar-bottom { padding:10px; border-top:1px solid rgba(255,255,255,0.04); display:flex; flex-direction:column; gap:1px; }

/* ‚ïê‚ïê MAIN ‚ïê‚ïê */
.main { flex:1; display:flex; flex-direction:column; overflow:hidden; min-width:0; }

.topbar {
  height:var(--topbar-h); background:rgba(6,8,15,0.92);
  border-bottom:1px solid rgba(255,255,255,0.04);
  display:flex; align-items:center; padding:0 22px; gap:14px;
  flex-shrink:0; backdrop-filter:blur(20px);
}
.topbar-title { font-family:'Rajdhani',sans-serif; font-size:19px; font-weight:700; background:linear-gradient(135deg,#fff 30%,var(--accent) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.topbar-sub { font-size:11px; color:var(--text3); }
.topbar-spacer { flex:1; }
.topbar-actions { display:flex; align-items:center; gap:8px; }
.topbar-stat { display:flex; align-items:center; gap:5px; padding:5px 11px; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.05); border-radius:var(--radius-sm); font-size:12px; color:var(--text2); }
.topbar-stat strong { font-size:14px; font-weight:700; color:var(--text); }
.ts-green strong { color:var(--green); }
.ts-cyan  strong { color:var(--cyan); }
.ts-gold  strong { color:var(--gold); }

.content { flex:1; overflow-y:auto; overflow-x:hidden; padding:22px; scrollbar-width:thin; scrollbar-color:rgba(230,57,70,0.25) transparent; }
.content::-webkit-scrollbar { width:4px; }
.content::-webkit-scrollbar-thumb { background:rgba(230,57,70,0.3); border-radius:4px; }

.page { display:none; animation:fadeUp .2s ease; }
.page.active { display:block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

/* ‚ïê‚ïê GRID ‚ïê‚ïê */
.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
.grid-4 { display:grid; grid-template-columns:repeat(4,1fr); gap:12px; }
.grid-main-side { display:grid; grid-template-columns:1fr 320px; gap:14px; align-items:start; }

/* ‚ïê‚ïê CARDS ‚ïê‚ïê */
.card { background:rgba(12,16,32,0.85); border:1px solid rgba(255,255,255,0.06); border-radius:var(--radius); overflow:hidden; backdrop-filter:blur(8px); }
.card-header { padding:12px 16px; border-bottom:1px solid rgba(255,255,255,0.04); display:flex; align-items:center; justify-content:space-between; }
.card-title { font-family:'Rajdhani',sans-serif; font-size:13px; font-weight:700; letter-spacing:.5px; color:var(--text); text-transform:uppercase; }
.card-body { padding:14px 16px; }

/* ‚ïê‚ïê STAT CARDS ‚ïê‚ïê */
.stat-card { position:relative; border-radius:var(--radius); padding:16px; overflow:hidden; }
.stat-card::before {
  content:''; position:absolute; inset:0; border-radius:var(--radius); padding:1px;
  background:linear-gradient(135deg,var(--sc-c1,var(--accent)),rgba(255,255,255,0.06),var(--sc-c1,var(--accent)));
  background-size:300%; animation:shimmer 4s linear infinite;
  -webkit-mask:linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
  -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none;
}
@keyframes shimmer { 0%,100%{background-position:0% 50%} 50%{background-position:100% 50%} }
.sc-red    { background:linear-gradient(145deg,rgba(230,57,70,.15) 0%,rgba(12,16,32,.98) 55%); --sc-c1:#e63946; box-shadow:0 2px 16px rgba(230,57,70,.1); }
.sc-green  { background:linear-gradient(145deg,rgba(34,197,94,.15) 0%,rgba(12,16,32,.98) 55%); --sc-c1:#22c55e; box-shadow:0 2px 16px rgba(34,197,94,.1); }
.sc-cyan   { background:linear-gradient(145deg,rgba(6,182,212,.13) 0%,rgba(12,16,32,.98) 55%); --sc-c1:#06b6d4; box-shadow:0 2px 16px rgba(6,182,212,.08); }
.sc-gold   { background:linear-gradient(145deg,rgba(245,158,11,.15) 0%,rgba(12,16,32,.98) 55%); --sc-c1:#f59e0b; box-shadow:0 2px 16px rgba(245,158,11,.1); }
.sc-purple { background:linear-gradient(145deg,rgba(139,92,246,.13) 0%,rgba(12,16,32,.98) 55%); --sc-c1:#8b5cf6; box-shadow:0 2px 16px rgba(139,92,246,.08); }
.sc-blue   { background:linear-gradient(145deg,rgba(59,130,246,.13) 0%,rgba(12,16,32,.98) 55%); --sc-c1:#3b82f6; box-shadow:0 2px 16px rgba(59,130,246,.08); }
.stat-label { font-size:9px; font-weight:700; letter-spacing:1.2px; text-transform:uppercase; color:var(--text3); margin-bottom:8px; }
.stat-val { font-family:'Rajdhani',sans-serif; font-size:36px; font-weight:700; line-height:1; }
.stat-sub { font-size:11px; color:var(--text3); margin-top:4px; }
.sc-red    .stat-val { color:var(--accent); }
.sc-green  .stat-val { color:var(--green); }
.sc-cyan   .stat-val { color:var(--cyan); }
.sc-gold   .stat-val { color:var(--gold); }
.sc-purple .stat-val { color:var(--purple); }
.sc-blue   .stat-val { color:var(--blue); }

/* ‚ïê‚ïê BOT TABLE ‚ïê‚ïê */
.bot-table { width:100%; border-collapse:collapse; }
.bot-table th { text-align:left; padding:9px 13px; font-size:9px; font-weight:700; letter-spacing:1.2px; text-transform:uppercase; color:var(--text3); border-bottom:1px solid rgba(255,255,255,0.04); }
.bot-table td { padding:11px 13px; border-bottom:1px solid rgba(255,255,255,0.03); vertical-align:middle; font-size:13px; }
.bot-table tr:last-child td { border-bottom:none; }
.bot-table tr { transition:var(--transition); }
.bot-table tr:hover td { background:rgba(255,255,255,0.02); }

.bot-avatar-sm { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:15px; position:relative; background:var(--bg3); }
.bot-ring-sm { position:absolute; inset:-2px; border-radius:50%; background:conic-gradient(from 0deg,var(--ring-c,var(--accent)),transparent 180deg,var(--ring-c,var(--accent))); animation:spin 2s linear infinite; }
.bot-ring-sm::after { content:''; position:absolute; inset:2px; border-radius:50%; background:var(--bg2); }
.bot-name-cell { font-family:'Rajdhani',sans-serif; font-size:14px; font-weight:700; }
.bot-game-cell { font-size:11px; color:var(--text2); max-width:180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

.status-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:20px; font-size:10px; font-weight:700; white-space:nowrap; }
.sb-online  { background:rgba(34,197,94,.12); color:#4ade80; border:1px solid rgba(34,197,94,.3); }
.sb-farming { background:rgba(6,182,212,.12); color:var(--cyan); border:1px solid rgba(6,182,212,.3); }
.sb-idle    { background:rgba(245,158,11,.12); color:var(--gold); border:1px solid rgba(245,158,11,.3); }
.sb-offline { background:rgba(71,85,105,.1); color:var(--text3); border:1px solid rgba(71,85,105,.25); }
.ring-online  { --ring-c:var(--green); }
.ring-farming { --ring-c:var(--cyan); }
.ring-idle    { --ring-c:var(--gold); }

.progress-mini { width:75px; height:3px; background:rgba(255,255,255,.05); border-radius:2px; overflow:hidden; }
.progress-mini-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--cyan),#7dd3fc); transition:width .5s ease; }

/* Bot cards grid */
.bots-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:12px; }
.bot-card-full { background:rgba(12,16,32,.9); border-radius:var(--radius); overflow:hidden; position:relative; transition:transform var(--transition),box-shadow var(--transition); border:1px solid transparent; }
.bot-card-full:hover { transform:translateY(-2px); }
.bc-online  { border-color:rgba(34,197,94,.25); box-shadow:0 2px 16px rgba(34,197,94,.08); }
.bc-farming { border-color:rgba(6,182,212,.25); box-shadow:0 2px 16px rgba(6,182,212,.08); }
.bc-idle    { border-color:rgba(245,158,11,.2); }
.bc-offline { border-color:rgba(71,85,105,.2); }
.bot-card-top { height:2px; }
.bc-online  .bot-card-top { background:linear-gradient(90deg,transparent,var(--green),transparent); background-size:200%; animation:shimmer 3s linear infinite; }
.bc-farming .bot-card-top { background:linear-gradient(90deg,transparent,var(--cyan),transparent); background-size:200%; animation:shimmer 3s linear infinite; }
.bc-idle    .bot-card-top { background:var(--gold); opacity:.4; }
.bc-offline .bot-card-top { background:rgba(71,85,105,.3); }
.bot-card-body { padding:13px; display:flex; align-items:center; gap:11px; }
.bot-avatar-lg { width:44px; height:44px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; background:var(--bg3); position:relative; flex-shrink:0; }
.bot-ring-lg { position:absolute; inset:-2px; border-radius:50%; animation:spin 2.5s linear infinite; }
.bc-online  .bot-ring-lg { background:conic-gradient(from 0deg,var(--green),transparent 150deg,var(--green)); }
.bc-farming .bot-ring-lg { background:conic-gradient(from 0deg,var(--cyan),transparent 150deg,var(--cyan)); }
.bc-idle    .bot-ring-lg { background:conic-gradient(from 0deg,var(--gold),transparent 150deg,var(--gold)); }
.bc-offline .bot-ring-lg { display:none; }
.bot-ring-lg::after { content:''; position:absolute; inset:2px; border-radius:50%; background:var(--bg2); }
.bot-info { flex:1; min-width:0; }
.bot-name-lg { font-family:'Rajdhani',sans-serif; font-size:15px; font-weight:700; }
.bc-online  .bot-name-lg { color:#86efac; }
.bc-farming .bot-name-lg { color:#a5f3fc; }
.bc-idle    .bot-name-lg { color:#fde68a; }
.bc-offline .bot-name-lg { color:var(--text2); }
.bot-detail-lg { font-size:11px; color:var(--text2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
.bot-card-stats { display:flex; gap:0; margin:0 13px 0; background:rgba(255,255,255,0.03); border-radius:6px; overflow:hidden; }
.bot-stat-mini { flex:1; padding:7px; text-align:center; border-right:1px solid rgba(255,255,255,0.04); }
.bot-stat-mini:last-child { border-right:none; }
.bot-stat-mini-val { font-family:'Rajdhani',sans-serif; font-size:16px; font-weight:700; color:var(--text); line-height:1; }
.bot-stat-mini-lbl { font-size:9px; color:var(--text3); text-transform:uppercase; letter-spacing:.8px; margin-top:2px; }
.bot-card-footer { padding:0 13px 13px; display:flex; gap:5px; }

/* ‚ïê‚ïê BUTTONS ‚ïê‚ïê */
.btn { display:inline-flex; align-items:center; justify-content:center; gap:5px; padding:7px 13px; border-radius:var(--radius-sm); font-size:12px; font-weight:600; cursor:pointer; border:none; transition:var(--transition); text-decoration:none; white-space:nowrap; font-family:inherit; }
.btn:active { transform:scale(.96); }
.btn-primary { background:linear-gradient(135deg,#b91c1c,var(--accent)); color:#fff; box-shadow:0 2px 12px rgba(230,57,70,.25); }
.btn-primary:hover { box-shadow:0 4px 20px rgba(230,57,70,.45); }
.btn-ghost { background:rgba(255,255,255,.05); color:var(--text2); border:1px solid rgba(255,255,255,.07); }
.btn-ghost:hover { background:rgba(255,255,255,.09); color:var(--text); }
.btn-danger { background:rgba(230,57,70,.12); color:var(--accent); border:1px solid rgba(230,57,70,.25); }
.btn-danger:hover { background:rgba(230,57,70,.22); }
.btn-success { background:rgba(34,197,94,.12); color:var(--green); border:1px solid rgba(34,197,94,.25); }
.btn-success:hover { background:rgba(34,197,94,.22); }
.btn-cyan { background:rgba(6,182,212,.12); color:var(--cyan); border:1px solid rgba(6,182,212,.25); }
.btn-cyan:hover { background:rgba(6,182,212,.22); }
.btn-gold { background:rgba(245,158,11,.12); color:var(--gold); border:1px solid rgba(245,158,11,.25); }
.btn-gold:hover { background:rgba(245,158,11,.22); }
.btn-purple { background:rgba(139,92,246,.18); color:var(--purple); border:1px solid rgba(139,92,246,.35); }
.btn-purple:hover { background:rgba(139,92,246,.28); }
.btn-sm { padding:4px 9px; font-size:11px; }
.btn-icon { padding:6px 8px; }
.btn-full { width:100%; }

/* ‚ïê‚ïê FORMS ‚ïê‚ïê */
.form-group { margin-bottom:13px; }
.form-label { font-size:10px; font-weight:700; letter-spacing:.8px; text-transform:uppercase; color:var(--text3); margin-bottom:5px; display:block; }
.form-input { width:100%; padding:8px 11px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07); border-radius:var(--radius-sm); color:var(--text); font-size:13px; font-family:inherit; transition:var(--transition); outline:none; }
.form-input:focus { border-color:rgba(230,57,70,.45); box-shadow:0 0 0 3px rgba(230,57,70,.08); }
.form-input.small { padding:6px 9px; font-size:12px; }
select.form-input { cursor:pointer; }
option { background:var(--bg2); }
textarea.form-input { resize:vertical; min-height:80px; font-family:'JetBrains Mono',monospace; font-size:12px; }
.form-hint { font-size:10px; color:var(--text3); margin-top:4px; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.form-check { display:flex; align-items:center; gap:8px; padding:8px 11px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius-sm); cursor:pointer; transition:var(--transition); }
.form-check:hover { background:rgba(255,255,255,.06); }
.form-check input { width:14px; height:14px; accent-color:var(--accent); }
.form-check label { font-size:12px; font-weight:500; color:var(--text2); cursor:pointer; }

/* ‚ïê‚ïê LOG ‚ïê‚ïê */
.log-area { font-family:'JetBrains Mono',monospace; font-size:11.5px; line-height:1.65; overflow-y:auto; scrollbar-width:thin; scrollbar-color:rgba(230,57,70,.15) transparent; }
.log-area::-webkit-scrollbar { width:3px; }
.log-area::-webkit-scrollbar-thumb { background:rgba(230,57,70,.25); border-radius:3px; }
.log-line { padding:1px 0; white-space:pre-wrap; word-break:break-all; }
.log-time { color:var(--text3); margin-right:5px; font-size:10px; }
.log-ok   { color:#4ade80; }
.log-err  { color:var(--accent); }
.log-warn { color:var(--gold); }
.log-info { color:var(--text2); }

/* ‚ïê‚ïê CMD BAR ‚ïê‚ïê */
.cmd-bar { display:flex; gap:7px; }
.cmd-input { flex:1; padding:9px 13px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07); border-radius:var(--radius-sm); color:var(--text); font-family:'JetBrains Mono',monospace; font-size:12px; outline:none; transition:var(--transition); }
.cmd-input:focus { border-color:rgba(230,57,70,.4); box-shadow:0 0 0 3px rgba(230,57,70,.07); }
.cmd-pills { display:flex; flex-wrap:wrap; gap:5px; margin-top:10px; }
.cmd-pill { padding:3px 11px; background:rgba(230,57,70,.08); border:1px solid rgba(230,57,70,.18); border-radius:20px; font-size:11px; color:var(--accent); cursor:pointer; transition:var(--transition); font-family:'JetBrains Mono',monospace; }
.cmd-pill:hover { background:rgba(230,57,70,.18); transform:translateY(-1px); }

/* ‚ïê‚ïê SECTION HEADER ‚ïê‚ïê */
.section-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.section-title { font-family:'Rajdhani',sans-serif; font-size:21px; font-weight:700; background:linear-gradient(135deg,#fff 30%,var(--accent) 100%); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; }
.section-sub { font-size:11px; color:var(--text3); margin-top:2px; }
.section-actions { display:flex; align-items:center; gap:7px; }

/* ‚ïê‚ïê MODALS ‚ïê‚ïê */
.modal-overlay { position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.75); backdrop-filter:blur(10px); display:none; align-items:center; justify-content:center; }
.modal-overlay.open { display:flex; animation:fadeIn .18s ease; }
@keyframes fadeIn { from{opacity:0} to{opacity:1} }
.modal { background:linear-gradient(145deg,rgba(18,26,46,.98),rgba(12,16,32,.98)); border:1px solid rgba(230,57,70,.18); border-radius:14px; padding:26px; min-width:360px; max-width:500px; width:92%; box-shadow:0 24px 60px rgba(0,0,0,.65); animation:slideUp .2s ease; }
@keyframes slideUp { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }
.modal-wide { max-width:680px; }
.modal h3 { font-family:'Rajdhani',sans-serif; font-size:19px; font-weight:700; margin-bottom:18px; display:flex; align-items:center; gap:8px; }
.modal-actions { display:flex; gap:8px; margin-top:18px; justify-content:flex-end; }
.modal-close { position:absolute; right:14px; top:14px; background:none; border:none; color:var(--text3); font-size:18px; cursor:pointer; padding:4px; border-radius:4px; transition:var(--transition); }
.modal-close:hover { color:var(--text); background:rgba(255,255,255,.05); }

/* ‚ïê‚ïê TABS ‚ïê‚ïê */
.tabs { display:flex; gap:0; border-bottom:1px solid rgba(255,255,255,.06); margin-bottom:16px; }
.tab { padding:8px 16px; font-size:12px; font-weight:600; color:var(--text3); cursor:pointer; border-bottom:2px solid transparent; transition:var(--transition); }
.tab:hover { color:var(--text2); }
.tab.active { color:var(--accent); border-bottom-color:var(--accent); }

/* ‚ïê‚ïê TABLE GENERIC ‚ïê‚ïê */
.data-table { width:100%; border-collapse:collapse; }
.data-table th { text-align:left; padding:8px 12px; font-size:9px; font-weight:700; letter-spacing:1.2px; text-transform:uppercase; color:var(--text3); border-bottom:1px solid rgba(255,255,255,.05); }
.data-table td { padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.03); font-size:12px; vertical-align:middle; }
.data-table tr:last-child td { border-bottom:none; }
.data-table tr:hover td { background:rgba(255,255,255,.02); }

/* ‚ïê‚ïê TOASTS ‚ïê‚ïê */
.toast-wrap { position:fixed; bottom:22px; right:22px; z-index:2000; display:flex; flex-direction:column; gap:7px; }
.toast { padding:9px 15px; border-radius:var(--radius-sm); font-size:12px; font-weight:600; animation:slideIn .25s ease; backdrop-filter:blur(16px); box-shadow:0 4px 20px rgba(0,0,0,.4); }
@keyframes slideIn { from{opacity:0;transform:translateX(16px)} to{opacity:1;transform:translateX(0)} }
.t-ok  { background:rgba(34,197,94,.12); color:var(--green); border:1px solid rgba(34,197,94,.25); }
.t-err { background:rgba(230,57,70,.12); color:var(--accent); border:1px solid rgba(230,57,70,.25); }
.t-inf { background:rgba(6,182,212,.1); color:var(--cyan); border:1px solid rgba(6,182,212,.2); }
.t-warn{ background:rgba(245,158,11,.1); color:var(--gold); border:1px solid rgba(245,158,11,.2); }

/* ‚ïê‚ïê MISC ‚ïê‚ïê */
.loading-state { display:flex; align-items:center; justify-content:center; gap:9px; padding:28px; color:var(--text3); font-size:13px; }
.spinner { width:16px; height:16px; border:2px solid rgba(230,57,70,.15); border-top-color:var(--accent); border-radius:50%; animation:rotate .65s linear infinite; }
@keyframes rotate { to{transform:rotate(360deg)} }
.empty-state { text-align:center; padding:40px 20px; color:var(--text3); }
.empty-state-icon { font-size:40px; margin-bottom:12px; opacity:.5; }
.empty-state-text { font-size:13px; }

.hero-stats-bar { display:flex; background:rgba(255,255,255,.03); border-radius:var(--radius-sm); overflow:hidden; border:1px solid rgba(255,255,255,.05); }
.hero-stat { flex:1; padding:11px 14px; border-right:1px solid rgba(255,255,255,.05); text-align:center; }
.hero-stat:last-child { border-right:none; }
.hero-stat-val { font-family:'Rajdhani',sans-serif; font-size:26px; font-weight:700; line-height:1; }
.hero-stat-lbl { font-size:9px; color:var(--text3); text-transform:uppercase; letter-spacing:.8px; margin-top:3px; }
.col-green { color:var(--green); } .col-blue { color:var(--cyan); } .col-gold { color:var(--gold); } .col-red { color:var(--accent); } .col-purple { color:var(--purple); }

.error-banner { display:flex; align-items:center; gap:11px; padding:13px 15px; background:rgba(230,57,70,.07); border:1px solid rgba(230,57,70,.18); border-radius:var(--radius-sm); font-size:12px; color:var(--text2); }
.error-banner-icon { font-size:18px; flex-shrink:0; }

.about-logo-big { position:relative; width:64px; height:64px; margin:0 auto 14px; }
.about-logo-ring { position:absolute; inset:-3px; border-radius:18px; background:conic-gradient(from 0deg,var(--accent),var(--accent2),#ff1744,var(--accent2),var(--accent)); animation:spin 4s linear infinite; }
.about-logo-ring::after { content:''; position:absolute; inset:2px; border-radius:16px; background:var(--bg2); }
.about-logo-inner { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:28px; z-index:2; }

.divider { height:1px; background:rgba(255,255,255,.05); margin:14px 0; }
.mb-12 { margin-bottom:12px; } .mb-16 { margin-bottom:16px; } .mb-20 { margin-bottom:20px; }
.gap-8 { gap:8px; } .flex { display:flex; align-items:center; }
* { scrollbar-width:thin; scrollbar-color:rgba(230,57,70,.15) transparent; }

/* Games farming progress */
.game-row { display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.04); }
.game-row:last-child { border-bottom:none; }
.game-name { flex:1; font-size:12px; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.game-cards { font-family:'JetBrains Mono',monospace; font-size:11px; color:var(--gold); min-width:60px; text-align:right; }
.game-progress { width:80px; height:3px; background:rgba(255,255,255,.06); border-radius:2px; overflow:hidden; }
.game-progress-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--gold),#fde68a); }

/* Keys/Redeem */
.key-result { display:flex; align-items:center; gap:8px; padding:7px 10px; border-radius:6px; margin-bottom:5px; font-size:12px; }
.key-ok   { background:rgba(34,197,94,.08); border:1px solid rgba(34,197,94,.2); color:#4ade80; }
.key-err  { background:rgba(230,57,70,.08); border:1px solid rgba(230,57,70,.2); color:var(--accent); }
.key-dup  { background:rgba(245,158,11,.08); border:1px solid rgba(245,158,11,.2); color:var(--gold); }

/* Config editor */
.config-section { margin-bottom:20px; }
.config-section-title { font-family:'Rajdhani',sans-serif; font-size:13px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; color:var(--text2); margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid rgba(255,255,255,.05); }

/* Trade offers */
.trade-card { background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:var(--radius-sm); padding:12px; margin-bottom:8px; }
.trade-card:last-child { margin-bottom:0; }

/* 2FA */
.twofa-code { font-family:'JetBrains Mono',monospace; font-size:36px; font-weight:700; letter-spacing:8px; color:var(--cyan); text-align:center; padding:20px; background:rgba(6,182,212,.05); border:1px solid rgba(6,182,212,.15); border-radius:var(--radius); position:relative; overflow:hidden; }
.twofa-timer { width:100%; height:3px; background:rgba(255,255,255,.06); border-radius:2px; overflow:hidden; margin-top:12px; }
.twofa-timer-fill { height:100%; border-radius:2px; background:linear-gradient(90deg,var(--cyan),#a5f3fc); transition:width 1s linear; }

/* FAB */
#fab { display:none; position:fixed; bottom:22px; right:22px; width:50px; height:50px; border-radius:50%; font-size:20px; box-shadow:0 4px 20px rgba(230,57,70,.45); z-index:100; }

/* ‚ïê‚ïê SEARCH BAR ‚ïê‚ïê */
.search-bar { display:flex; gap:8px; margin-bottom:16px; align-items:center; }
.search-input { flex:1; padding:8px 12px 8px 36px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.07); border-radius:var(--radius-sm); color:var(--text); font-size:13px; font-family:inherit; outline:none; transition:var(--transition); position:relative; }
.search-input:focus { border-color:rgba(230,57,70,.4); box-shadow:0 0 0 3px rgba(230,57,70,.07); }
.search-wrap { position:relative; flex:1; }
.search-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--text3); font-size:14px; pointer-events:none; }
.filter-btn { padding:7px 13px; border-radius:var(--radius-sm); font-size:12px; font-weight:600; cursor:pointer; border:1px solid rgba(255,255,255,.07); background:rgba(255,255,255,.04); color:var(--text2); transition:var(--transition); white-space:nowrap; }
.filter-btn:hover, .filter-btn.active { background:rgba(230,57,70,.15); border-color:rgba(230,57,70,.3); color:var(--accent); }

/* ‚ïê‚ïê AUTO-REFRESH INDICATOR ‚ïê‚ïê */
.refresh-indicator { display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text3); }
.refresh-dot { width:5px; height:5px; border-radius:50%; background:var(--green); animation:pulse 2s ease infinite; }
.refresh-dot.loading { background:var(--gold); animation:rotate .8s linear infinite; border-radius:0; width:10px; height:10px; border:2px solid rgba(245,158,11,.2); border-top-color:var(--gold); }

/* ‚ïê‚ïê NOTIFICATION BANNER ‚ïê‚ïê */
.notif-banner { position:fixed; top:70px; right:16px; z-index:500; display:flex; flex-direction:column; gap:6px; max-width:320px; }
.notif-item { background:rgba(12,16,32,.96); border:1px solid rgba(230,57,70,.25); border-radius:var(--radius); padding:12px 14px; display:flex; align-items:flex-start; gap:10px; animation:slideIn .3s ease; box-shadow:0 8px 24px rgba(0,0,0,.5); backdrop-filter:blur(16px); }
.notif-icon { font-size:20px; flex-shrink:0; }
.notif-body { flex:1; }
.notif-title { font-weight:600; font-size:13px; margin-bottom:2px; }
.notif-sub { font-size:11px; color:var(--text3); }
.notif-close { color:var(--text3); cursor:pointer; font-size:16px; padding:0 2px; flex-shrink:0; }
.notif-close:hover { color:var(--text); }

/* ‚ïê‚ïê STATS PAGE ‚ïê‚ïê */
.chart-container { position:relative; width:100%; }
canvas { width:100% !important; }
.chart-legend { display:flex; flex-wrap:wrap; gap:10px; margin-top:12px; }
.chart-legend-item { display:flex; align-items:center; gap:6px; font-size:11px; color:var(--text2); }
.chart-legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.stat-mini-row { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; margin-bottom:16px; }
.stat-mini { background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.05); border-radius:var(--radius-sm); padding:12px; text-align:center; }
.stat-mini-val { font-family:'Rajdhani',sans-serif; font-size:24px; font-weight:700; line-height:1; }
.stat-mini-lbl { font-size:10px; color:var(--text3); text-transform:uppercase; letter-spacing:.8px; margin-top:3px; }

/* ‚ïê‚ïê DASH STATS BAR ‚ïê‚ïê */
.dash-stats-bar {
  display: flex; align-items: center; gap: 0;
  background: rgba(12,16,32,.9); border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--radius); padding: 14px 20px;
  backdrop-filter: blur(8px);
}
.dash-stat { display: flex; align-items: center; gap: 10px; padding: 0 20px; }
.dash-stat:first-child { padding-left: 0; }
.dash-stat-icon { font-size: 20px; }
.dash-stat-val {
  font-family: 'Rajdhani', sans-serif; font-size: 28px; font-weight: 700;
  line-height: 1; color: var(--green);
}
.dash-stat-lbl { font-size: 11px; color: var(--text3); margin-top: 1px; }
.dash-stat-divider { width: 1px; height: 36px; background: rgba(255,255,255,.06); flex-shrink: 0; }

/* ‚ïê‚ïê IDLE PAGE ‚ïê‚ïê */
.idle-game-pill {
  padding: 5px 13px; background: rgba(245,158,11,.08);
  border: 1px solid rgba(245,158,11,.22); border-radius: 20px;
  font-size: 12px; color: var(--gold); cursor: pointer;
  transition: var(--transition); font-weight: 600;
}
.idle-game-pill:hover { background: rgba(245,158,11,.2); transform: translateY(-1px); }

.idle-bot-card {
  background: rgba(12,16,32,.9); border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--radius); overflow: hidden;
}
.idle-bot-card-header {
  padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,.05);
  display: flex; align-items: center; gap: 12px;
}
.idle-game-tag {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px; background: rgba(245,158,11,.1);
  border: 1px solid rgba(245,158,11,.2); border-radius: 20px;
  font-size: 11px; color: var(--gold); font-family: 'JetBrains Mono', monospace;
}
.idle-game-tag .remove-tag {
  cursor: pointer; color: var(--text3); font-size: 13px; line-height: 1;
  margin-left: 2px; transition: var(--transition);
}
.idle-game-tag .remove-tag:hover { color: var(--accent); }

/* ‚ïê‚ïê HOURS PAGE ‚ïê‚ïê */
.hours-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 14px;
  align-items: start;
}
@media (max-width: 1100px) { .hours-grid { grid-template-columns: repeat(2,1fr); } }
@media (max-width: 600px)  { .hours-grid { grid-template-columns: 1fr; } }

.hours-col {
  border-radius: var(--radius);
  overflow: hidden;
  background: rgba(12,16,32,.85);
  border: 1px solid rgba(255,255,255,.06);
}
.hours-col-header {
  padding: 12px 14px;
  border-bottom: 1px solid rgba(255,255,255,.05);
  position: relative;
  overflow: hidden;
}
.hours-col-header::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--hc, var(--accent));
}
.hours-col-title {
  font-family: 'Rajdhani', sans-serif;
  font-size: 14px; font-weight: 700;
  color: var(--hc, var(--text));
}
.hours-col-sub { font-size: 10px; color: var(--text3); margin-top: 1px; }
.hours-col-count {
  font-family: 'Rajdhani', sans-serif;
  font-size: 22px; font-weight: 700;
  color: var(--hc, var(--accent));
  float: right; line-height: 1;
}
.hours-col-body { padding: 8px; display: flex; flex-direction: column; gap: 5px; }

.hours-bot-item {
  display: flex; align-items: center; gap: 8px;
  padding: 8px 10px;
  border-radius: 7px;
  background: rgba(255,255,255,.03);
  border: 1px solid rgba(255,255,255,.05);
  transition: var(--transition);
  cursor: default;
}
.hours-bot-item:hover { background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.1); }
.hours-bot-name { flex: 1; font-family: 'Rajdhani',sans-serif; font-weight: 700; font-size: 13px; }
.hours-bot-val {
  font-family: 'JetBrains Mono', monospace; font-size: 11px;
  color: var(--hc, var(--text3)); font-weight: 700;
  background: rgba(255,255,255,.04); padding: 2px 7px; border-radius: 10px;
}
.hours-progress {
  width: 100%; height: 2px; background: rgba(255,255,255,.05);
  border-radius: 2px; overflow: hidden; margin-top: 4px;
}
.hours-progress-fill { height: 100%; border-radius: 2px; background: var(--hc, var(--accent)); transition: width .5s ease; }

.hours-legend-item {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px;
  background: rgba(12,16,32,.85); border: 1px solid rgba(255,255,255,.06);
  border-radius: var(--radius-sm);
  flex: 1; min-width: 150px;
}
.hours-legend-dot {
  width: 10px; height: 10px; border-radius: 50%;
  background: var(--hc, var(--accent));
  box-shadow: 0 0 8px var(--hc, var(--accent));
  flex-shrink: 0;
}
.hours-legend-title { font-size: 13px; font-weight: 700; color: var(--text); }
.hours-legend-sub { font-size: 10px; color: var(--text3); }

/* ‚ïê‚ïê COMPACT MODE ‚ïê‚ïê */
body.compact .bot-card-body { padding: 8px 10px; }
body.compact .bot-avatar-lg { width: 34px; height: 34px; font-size: 15px; }
body.compact .bot-name-lg { font-size: 13px; }
body.compact .bot-detail-lg { display: none; }
body.compact .bot-card-stats { display: none; }
body.compact .bot-card-footer { padding: 0 10px 10px; gap: 4px; }
body.compact .bot-card-footer .btn { padding: 3px 7px; font-size: 10px; }
body.compact .bots-grid { grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 8px; }
body.compact .card-body { padding: 10px 12px; }

/* ‚ïê‚ïê FAVORITES ‚ïê‚ïê */
.bot-card-full.is-favorite { border-color: rgba(245,158,11,.45) !important; }
.bot-card-full.is-favorite .bot-card-top { background: linear-gradient(90deg,transparent,var(--gold),transparent) !important; background-size:200%; animation:shimmer 3s linear infinite !important; }
.fav-btn { position: absolute; top: 8px; right: 8px; background: none; border: none; cursor: pointer; font-size: 15px; opacity: .3; transition: var(--transition); z-index: 3; padding: 2px; line-height:1; }
.fav-btn:hover, .fav-btn.on { opacity: 1; }

/* ‚ïê‚ïê MASS SELECT ‚ïê‚ïê */
.bot-card-full { position: relative; }
.bot-select-check {
  position: absolute; top: 10px; left: 10px; z-index: 5;
  width: 16px; height: 16px; accent-color: var(--accent); cursor: pointer;
  opacity: 0; transition: opacity .15s; pointer-events: none;
}
body.select-mode .bot-select-check { opacity: 1; pointer-events: auto; }
body.select-mode .bot-card-full.selected { border-color: rgba(230,57,70,.55) !important; box-shadow: 0 0 0 2px rgba(230,57,70,.2); }

.mass-toolbar {
  position: fixed; bottom: 22px; left: 50%; transform: translateX(-50%);
  background: rgba(14,20,38,.97); border: 1px solid rgba(230,57,70,.35);
  border-radius: 14px; padding: 10px 18px;
  display: none; align-items: center; gap: 10px;
  box-shadow: 0 8px 40px rgba(0,0,0,.7); backdrop-filter: blur(20px);
  z-index: 500; animation: slideUp .2s ease; white-space: nowrap;
}
.mass-toolbar.visible { display: flex; }
.mass-count { font-family:'Rajdhani',sans-serif; font-size:16px; font-weight:700; color:var(--accent); min-width:90px; }
.mass-divider { width:1px; height:24px; background:rgba(255,255,255,.08); }

/* ‚ïê‚ïê GROUPS ‚ïê‚ïê */
.group-chip {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 600;
  cursor: pointer; transition: var(--transition); border: 1px solid transparent;
}
.group-chip:hover { filter: brightness(1.2); }
.group-card {
  background: rgba(12,16,32,.9); border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--radius); overflow: hidden; margin-bottom: 12px;
}
.group-card-header {
  padding: 12px 16px; border-bottom: 1px solid rgba(255,255,255,.05);
  display: flex; align-items: center; gap: 10px;
}
.group-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }

/* ‚ïê‚ïê WS STATUS ‚ïê‚ïê */
.ws-indicator {
  display: flex; align-items: center; gap: 5px; font-size: 10px; color: var(--text3);
  padding: 3px 9px; background: rgba(255,255,255,.03); border-radius: 10px;
  border: 1px solid rgba(255,255,255,.05); cursor: default;
}
.ws-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--text3); flex-shrink: 0; transition: .3s; }
.ws-dot.live { background: var(--green); box-shadow: 0 0 7px var(--green); animation: pulse 2s ease infinite; }
.ws-dot.wait { background: var(--gold); animation: pulse .9s ease infinite; }

/* ‚ïê‚ïê AUTO-RESTART BADGE ‚ïê‚ïê */
.ar-badge { font-size:9px; font-weight:700; letter-spacing:.5px; text-transform:uppercase; padding:1px 6px; border-radius:10px; background:rgba(139,92,246,.12); color:var(--purple); border:1px solid rgba(139,92,246,.25); }

/* ‚ïê‚ïê DISABLED BUTTONS ‚ïê‚ïê */
.btn:disabled { opacity: 0.35; cursor: not-allowed; pointer-events: none; }

/* ‚ïê‚ïê ACCOUNT CARDS ‚ïê‚ïê */
.account-card {
  background: rgba(12,16,32,.9);
  border: 1px solid rgba(255,255,255,.07);
  border-radius: var(--radius);
  padding: 16px;
  display: flex;
  align-items: center;
  gap: 14px;
  transition: var(--transition);
  position: relative;
  overflow: hidden;
}
.account-card::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
  opacity: 0;
  transition: var(--transition);
}
.account-card:hover { border-color: rgba(230,57,70,.25); background: rgba(18,25,40,.95); }
.account-card:hover::before { opacity: 1; }
.account-avatar {
  width: 46px; height: 46px; border-radius: 50%;
  background: linear-gradient(135deg, rgba(230,57,70,.25), rgba(255,107,53,.15));
  border: 2px solid rgba(230,57,70,.3);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.account-info { flex: 1; min-width: 0; }
.account-name { font-family: 'Rajdhani', sans-serif; font-size: 16px; font-weight: 700; color: var(--text); }
.account-login { font-size: 11px; color: var(--text3); font-family: 'JetBrains Mono', monospace; margin-top: 1px; }
.account-meta { display: flex; gap: 6px; margin-top: 5px; flex-wrap: wrap; }
.account-tag {
  font-size: 9px; font-weight: 700; letter-spacing: .8px; text-transform: uppercase;
  padding: 2px 7px; border-radius: 10px;
}
.tag-2fa  { background: rgba(6,182,212,.12); color: var(--cyan); border: 1px solid rgba(6,182,212,.25); }
.tag-pass { background: rgba(34,197,94,.1); color: var(--green); border: 1px solid rgba(34,197,94,.2); }
.tag-bot  { background: rgba(139,92,246,.1); color: var(--purple); border: 1px solid rgba(139,92,246,.2); }
.tag-nopass { background: rgba(245,158,11,.1); color: var(--gold); border: 1px solid rgba(245,158,11,.2); }

/* Login modal overlay */
.login-flow-step {
  display: flex; align-items: flex-start; gap: 12px; padding: 12px;
  border-radius: 8px; margin-bottom: 8px;
  background: rgba(255,255,255,.03); border: 1px solid rgba(255,255,255,.06);
}
.login-step-icon { font-size: 18px; width: 26px; text-align: center; flex-shrink: 0; margin-top: 1px; }
.login-step-text { flex: 1; }
.login-step-title { font-size: 13px; font-weight: 600; color: var(--text); }
.login-step-sub { font-size: 11px; color: var(--text3); margin-top: 2px; }
.step-ok    { border-color: rgba(34,197,94,.25); background: rgba(34,197,94,.06); }
.step-err   { border-color: rgba(230,57,70,.25); background: rgba(230,57,70,.06); }
.step-spin  { border-color: rgba(6,182,212,.25); background: rgba(6,182,212,.06); }

/* ‚ïê‚ïê MOBILE ‚ïê‚ïê */
.mob-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:8; backdrop-filter:blur(4px); }
#mobMenuBtn { display:none; background:none; border:none; color:var(--text); font-size:22px; cursor:pointer; padding:4px; }
#mobCloseBtn { display:none; }

@media (max-width: 768px) {
  :root { --sidebar-w: 260px; }
  html, body { overflow: auto; height: auto; }
  .layout { flex-direction: column; height: auto; min-height: 100vh; }

  .sidebar {
    position: fixed; left: -280px; top: 0; bottom: 0; z-index: 20;
    transition: left .25s cubic-bezier(.4,0,.2,1);
    height: 100vh;
  }
  .sidebar.mob-open { left: 0; }
  .mob-overlay.mob-open { display: block; }

  .main { flex: 1; min-height: 100vh; }

  .topbar { padding: 0 14px; position: sticky; top: 0; z-index: 15; }
  #mobMenuBtn { display: block; }
  .topbar-stat { display: none; }
  .topbar-actions .btn { display: none; }
  #addBotTopBtn { display: flex !important; }

  .content { padding: 14px; overflow-y: auto; height: auto; }
  .page { display: none; }
  .page.active { display: block; }

  .grid-2, .grid-3, .grid-4, .grid-main-side { grid-template-columns: 1fr !important; }
  .bots-grid { grid-template-columns: 1fr !important; }

  #fab { bottom: 16px; right: 16px; width: 46px; height: 46px; font-size: 18px; }

  .topbar-title { font-size: 16px; }
  .section-header { flex-direction: column; align-items: flex-start; gap: 10px; }
  .section-actions { width: 100%; justify-content: flex-start; flex-wrap: wrap; }
}
</style>
</head>
<body>

<div class="layout">

<!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon-wrap">
      <div class="logo-ring"></div>
      <div class="logo-icon">ü¶à</div>
    </div>
    <div>
      <div class="logo-name">SHARKFARM</div>
      <div class="logo-sub">Steam Farmer</div>
    </div>
  </div>

  <div class="sidebar-status" id="sidebarStatus" onclick="showPage('settings')">
    <div class="status-dot"></div>
    <div>
      <div class="status-text" id="statusText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ‚Ä¶</div>
      <div class="status-ver" id="statusVer">v‚Äî</div>
    </div>
  </div>

  <nav class="sidebar-nav">
    <div class="nav-section">–û–±–∑–æ—Ä</div>
    <button class="nav-item active" id="nav-dash" onclick="showPage('dash')">
      <span class="nav-icon">üìä</span> Dashboard
    </button>
    <button class="nav-item" id="nav-stats" onclick="showPage('stats')">
      <span class="nav-icon">üìà</span> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </button>

    <div class="nav-section">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
    <button class="nav-item" id="nav-bots" onclick="showPage('bots')">
      <span class="nav-icon">ü§ñ</span> –ë–æ—Ç—ã
      <span class="nav-badge" id="botBadge" style="display:none">0</span>
    </button>
    <button class="nav-item" id="nav-groups" onclick="showPage('groups')">
      <span class="nav-icon">üë•</span> –ì—Ä—É–ø–ø—ã
    </button>
    <button class="nav-item" id="nav-farming" onclick="showPage('farming')">
      <span class="nav-icon">üåæ</span> –§–∞—Ä–º–∏–Ω–≥
    </button>
    <button class="nav-item" id="nav-keys" onclick="showPage('keys')">
      <span class="nav-icon">üîë</span> –ö–ª—é—á–∏
    </button>
    <button class="nav-item" id="nav-trades" onclick="showPage('trades')">
      <span class="nav-icon">üîÑ</span> –û–±–º–µ–Ω—ã
    </button>
    <button class="nav-item" id="nav-loot" onclick="showPage('loot')">
      <span class="nav-icon">üí∞</span> –õ—É—Ç
    </button>
    <button class="nav-item" id="nav-idle" onclick="showPage('idle')">
      <span class="nav-icon">üéÆ</span> Idle / –ß–∞—Å—ã
    </button>
    <button class="nav-item" id="nav-hours" onclick="showPage('hours')">
      <span class="nav-icon">‚è∞</span> –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–∞—Å–æ–≤
    </button>

    <div class="nav-section">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</div>
    <button class="nav-item" id="nav-accounts" onclick="showPage('accounts')">
      <span class="nav-icon">üë§</span> –ê–∫–∫–∞—É–Ω—Ç—ã
    </button>
    <button class="nav-item" id="nav-twofa" onclick="showPage('twofa')">
      <span class="nav-icon">üîê</span> 2FA Auth
    </button>
    <button class="nav-item" id="nav-cmd" onclick="showPage('cmd')">
      <span class="nav-icon">‚å®Ô∏è</span> –ö–æ–Ω—Å–æ–ª—å
    </button>
    <button class="nav-item" id="nav-logs" onclick="showPage('logs')">
      <span class="nav-icon">üìã</span> –õ–æ–≥–∏
    </button>

    <div class="nav-section">–°–∏—Å—Ç–µ–º–∞</div>
    <button class="nav-item" id="nav-config" onclick="showPage('config')">
      <span class="nav-icon">üìù</span> –ö–æ–Ω—Ñ–∏–≥
    </button>
    <button class="nav-item" id="nav-settings" onclick="showPage('settings')">
      <span class="nav-icon">‚öôÔ∏è</span> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
    </button>
  </nav>

  <div class="sidebar-bottom">
    <button class="nav-item" onclick="refreshAll()">
      <span class="nav-icon">üîÑ</span> –û–±–Ω–æ–≤–∏—Ç—å
    </button>
    <button class="nav-item" onclick="confirmShutdown()" style="color:var(--accent);">
      <span class="nav-icon">‚èª</span> Shutdown
    </button>
  </div>
</aside>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<div class="main">

  <!-- TOPBAR -->
  <div class="topbar">
    <button id="mobMenuBtn" onclick="toggleMobMenu()">‚ò∞</button>
    <div>
      <div class="topbar-title" id="topbarTitle">Dashboard</div>
      <div class="topbar-sub" id="topbarSub">–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</div>
    </div>
    <div class="topbar-spacer"></div>
    <div class="topbar-actions">
      <div class="ws-indicator" id="wsIndicator" title="WebSocket —Å—Ç–∞—Ç—É—Å">
        <div class="ws-dot" id="wsDot"></div>
        <span id="wsLabel">Polling</span>
      </div>
      <div class="refresh-indicator" id="refreshIndicator">
        <div class="refresh-dot" id="refreshDot"></div>
        <span id="refreshTime">‚Äî</span>
      </div>
      <button class="btn btn-ghost btn-sm" id="compactToggle" onclick="toggleCompact()" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">‚äü</button>
      <button class="btn btn-primary btn-sm" id="addBotTopBtn" onclick="showPage('bots');openAddBot()">+ –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞</button>
    </div>
  </div>

  <div class="content">

    <!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
    <div class="page active" id="page-dash">

      <!-- Single unified stats bar -->
      <div class="dash-stats-bar mb-16">
        <div class="dash-stat">
          <div class="dash-stat-icon" style="color:var(--green);">üü¢</div>
          <div>
            <div class="dash-stat-val" id="st-online">‚Äî</div>
            <div class="dash-stat-lbl">–û–Ω–ª–∞–π–Ω / <span id="st-total">‚Äî</span> –≤—Å–µ–≥–æ</div>
          </div>
        </div>
        <div class="dash-stat-divider"></div>
        <div class="dash-stat">
          <div class="dash-stat-icon" style="color:var(--cyan);">üéÆ</div>
          <div>
            <div class="dash-stat-val" style="color:var(--cyan);" id="st-farming">‚Äî</div>
            <div class="dash-stat-lbl">–§–∞—Ä–º–∏—Ç —Å–µ–π—á–∞—Å</div>
          </div>
        </div>
        <div class="dash-stat-divider"></div>
        <div class="dash-stat">
          <div class="dash-stat-icon" style="color:var(--gold);">üÉè</div>
          <div>
            <div class="dash-stat-val" style="color:var(--gold);" id="st-cards">‚Äî</div>
            <div class="dash-stat-lbl">–ö–∞—Ä—Ç–æ—á–µ–∫ –æ—Å—Ç–∞–ª–æ—Å—å</div>
          </div>
        </div>
        <div class="dash-stat-divider"></div>
        <div class="dash-stat">
          <div class="dash-stat-icon" style="color:var(--text3);">‚è±</div>
          <div>
            <div class="dash-stat-val" style="color:var(--text2);font-size:20px;" id="st-uptime">‚Äî</div>
            <div class="dash-stat-lbl">–ê–ø—Ç–∞–π–º UI</div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;gap:7px;align-items:center;">
          <button class="btn btn-success btn-sm" onclick="startAllBots()">‚ñ∂ –í—Å–µ</button>
          <button class="btn btn-danger btn-sm" onclick="stopAllBots()">‚èπ –°—Ç–æ–ø</button>
          <button class="btn btn-gold btn-sm" onclick="lootAll()">üí∞ Loot</button>
          <button class="btn btn-ghost btn-sm" onclick="refreshAll()">üîÑ</button>
        </div>
      </div>

      <div class="grid-main-side">
        <div>
          <!-- Bot table -->
          <div class="card mb-16">
            <div class="card-header">
              <div class="card-title">ü§ñ –ë–æ—Ç—ã</div>
              <button class="btn btn-ghost btn-sm" onclick="showPage('bots')">–í—Å–µ ‚Üí</button>
            </div>
            <div style="overflow-x:auto;">
              <table class="bot-table">
                <thead><tr>
                  <th style="width:42px;"></th>
                  <th>–ê–∫–∫–∞—É–Ω—Ç</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                  <th>–ò–≥—Ä–∞</th>
                  <th>–ö–∞—Ä—Ç–æ—á–∫–∏</th>
                  <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                  <th style="width:130px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr></thead>
                <tbody id="dashBotTable">
                  <tr><td colspan="7"><div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div></td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Log -->
          <div class="card">
            <div class="card-header">
              <div class="card-title">üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏</div>
              <div class="flex gap-8">
                <button class="btn btn-ghost btn-sm" onclick="clearLog()">üóë</button>
                <button class="btn btn-ghost btn-sm" onclick="showPage('logs')">–í—Å–µ ‚Üí</button>
              </div>
            </div>
            <div class="card-body" style="padding:10px;">
              <div class="log-area" id="dashLog" style="height:200px;"></div>
            </div>
          </div>
        </div>

        <!-- Sidebar: quick command only -->
        <div>
          <div class="card mb-16">
            <div class="card-header"><div class="card-title">‚ö° –ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞</div></div>
            <div class="card-body">
              <div class="cmd-bar mb-12">
                <input class="cmd-input" id="quickCmd" placeholder="status, farm, loot‚Ä¶" onkeydown="if(event.key==='Enter')sendQuickCmd()">
                <button class="btn btn-primary btn-icon" onclick="sendQuickCmd()">‚Üµ</button>
              </div>
              <div class="cmd-pills">
                <div class="cmd-pill" onclick="setQuickCmd('status')">status</div>
                <div class="cmd-pill" onclick="setQuickCmd('farm')">farm</div>
                <div class="cmd-pill" onclick="setQuickCmd('loot')">loot</div>
                <div class="cmd-pill" onclick="setQuickCmd('2fa')">2fa</div>
                <div class="cmd-pill" onclick="setQuickCmd('stop')">stop</div>
                <div class="cmd-pill" onclick="setQuickCmd('restart')">restart</div>
              </div>
              <div class="log-area" id="quickOut" style="height:120px;margin-top:10px;"></div>
            </div>
          </div>

          <!-- Version info ‚Äî compact, no duplicated stats -->
          <div class="card">
            <div class="card-body" style="padding:14px 16px;">
              <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div class="about-logo-big" style="width:38px;height:38px;flex-shrink:0;">
                  <div class="about-logo-ring"></div>
                  <div class="about-logo-inner" style="font-size:18px;">ü¶à</div>
                </div>
                <div style="flex:1;min-width:0;">
                  <div style="font-family:'Rajdhani',sans-serif;font-size:17px;font-weight:700;background:linear-gradient(135deg,#fff,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">SharkFarm</div>
                  <div style="font-size:11px;color:var(--text3);" id="aboutVer">v‚Äî</div>
                </div>
                <a class="btn btn-ghost btn-sm" href="https://github.com/sistemkol1/SharkFarm" target="_blank">GitHub</a>
              </div>
              <div style="height:1px;background:rgba(255,255,255,.05);margin-bottom:12px;"></div>
              <a href="https://t.me/CsPrimeSeller_bot" target="_blank" style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:linear-gradient(135deg,rgba(41,182,246,.12),rgba(6,182,212,.08));border:1px solid rgba(41,182,246,.25);border-radius:var(--radius-sm);text-decoration:none;transition:var(--transition);" onmouseover="this.style.borderColor='rgba(41,182,246,.5)'" onmouseout="this.style.borderColor='rgba(41,182,246,.25)'">
                <div style="width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,#229ed9,#1a7bbf);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">‚úàÔ∏è</div>
                <div style="flex:1;min-width:0;">
                  <div style="font-size:13px;font-weight:700;color:#e2e8f0;">@CsPrimeSeller_bot</div>
                  <div style="font-size:10px;color:rgba(41,182,246,.8);margin-top:1px;">üõí –ú–∞–≥–∞–∑–∏–Ω Steam –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
                </div>
                <div style="font-size:10px;color:var(--text3);">‚Üí</div>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê BOTS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-bots">
      <div class="section-header">
        <div>
          <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞–º–∏</div>
          <div class="section-sub" id="botsSubtitle">–ó–∞–ø—É—Å–∫, –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost btn-sm" id="selectModeBtn" onclick="toggleSelectMode()" title="–í—ã–±—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ">‚òë –í—ã–±—Ä–∞—Ç—å</button>
          <button class="btn btn-ghost btn-sm" onclick="showPage('groups')" title="–ì—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤">üë• –ì—Ä—É–ø–ø—ã</button>
          <button class="btn btn-success" onclick="startAllBots()">‚ñ∂ –í—Å–µ</button>
          <button class="btn btn-danger" onclick="stopAllBots()">‚èπ –°—Ç–æ–ø</button>
          <button class="btn btn-primary" onclick="openAddBot()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
      </div>
      <!-- Search & Filter -->
      <div class="search-bar">
        <div class="search-wrap">
          <span class="search-icon">üîç</span>
          <input class="search-input" id="botSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –±–æ—Ç–∞‚Ä¶" oninput="filterBots()">
        </div>
        <button class="filter-btn active" id="filter-all" onclick="setFilter('all',this)">–í—Å–µ</button>
        <button class="filter-btn" id="filter-fav" onclick="setFilter('fav',this)">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω—ã–µ</button>
        <button class="filter-btn" id="filter-online" onclick="setFilter('online',this)">üü¢ –û–Ω–ª–∞–π–Ω</button>
        <button class="filter-btn" id="filter-farming" onclick="setFilter('farming',this)">üéÆ –§–∞—Ä–º–∏—Ç</button>
        <button class="filter-btn" id="filter-offline" onclick="setFilter('offline',this)">‚ö´ –û—Ñ–ª–∞–π–Ω</button>
        <!-- Group filter chips -->
        <div id="groupFilterChips" style="display:flex;gap:5px;flex-wrap:wrap;"></div>
      </div>
      <div class="bots-grid" id="fullBotList">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–æ–≤‚Ä¶</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê HOURS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-hours">
      <div class="section-header">
        <div>
          <div class="section-title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–∞—Å–æ–≤</div>
          <div class="section-sub">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤ –ø–æ –Ω–∞–∏–≥—Ä–∞–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadHoursPage()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- Category legend -->
      <div style="display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;">
        <div class="hours-legend-item" style="--hc:var(--accent);">
          <div class="hours-legend-dot"></div>
          <div><div class="hours-legend-title">üÜï –ù–æ–≤—ã–µ</div><div class="hours-legend-sub">0 ‚Äì 99 —á–∞—Å–æ–≤</div></div>
        </div>
        <div class="hours-legend-item" style="--hc:var(--gold);">
          <div class="hours-legend-dot"></div>
          <div><div class="hours-legend-title">ü•â –°—Ä–µ–¥–Ω–∏–µ</div><div class="hours-legend-sub">100 ‚Äì 499 —á–∞—Å–æ–≤</div></div>
        </div>
        <div class="hours-legend-item" style="--hc:var(--cyan);">
          <div class="hours-legend-dot"></div>
          <div><div class="hours-legend-title">ü•à –û–ø—ã—Ç–Ω—ã–µ</div><div class="hours-legend-sub">500 ‚Äì 999 —á–∞—Å–æ–≤</div></div>
        </div>
        <div class="hours-legend-item" style="--hc:var(--green);">
          <div class="hours-legend-dot"></div>
          <div><div class="hours-legend-title">ü•á –í–µ—Ç–µ—Ä–∞–Ω—ã</div><div class="hours-legend-sub">1000+ —á–∞—Å–æ–≤</div></div>
        </div>
        <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
          <div style="font-size:11px;color:var(--text3);">–ß–∞—Å—ã –≤–≤–æ–¥—è—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –±–µ—Ä—É—Ç—Å—è –∏–∑ idle-–∫–æ–Ω—Ñ–∏–≥–∞</div>
          <button class="btn btn-cyan btn-sm" onclick="openHoursEditor()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–∞—Å—ã</button>
        </div>
      </div>

      <!-- 4 category columns -->
      <div class="hours-grid" id="hoursGrid">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê GROUPS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-groups">
      <div class="section-header">
        <div>
          <div class="section-title">–ì—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤</div>
          <div class="section-sub">–û–±—ä–µ–¥–∏–Ω—è–π –±–æ—Ç–æ–≤ –∏ —É–ø—Ä–∞–≤–ª—è–π –∏–º–∏ –≤–º–µ—Å—Ç–µ</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="showPage('bots')">‚Üê –ù–∞–∑–∞–¥</button>
          <button class="btn btn-primary" onclick="openAddGroup()">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
        </div>
      </div>
      <div id="groupsList">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê FARMING PAGE ‚ïê‚ïê -->
    <div class="page" id="page-farming">
      <div class="section-header">
        <div>
          <div class="section-title">–°—Ç–∞—Ç—É—Å —Ñ–∞—Ä–º–∏–Ω–≥–∞</div>
          <div class="section-sub">–ò–≥—Ä—ã –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤ –æ—á–µ—Ä–µ–¥–∏</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadFarming()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div id="farmingContent">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê KEYS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-keys">
      <div class="section-header">
        <div>
          <div class="section-title">–ê–∫—Ç–∏–≤–∞—Ü–∏—è –∫–ª—é—á–µ–π</div>
          <div class="section-sub">Redeem Steam –∫–ª—é—á–µ–π —á–µ—Ä–µ–∑ API</div>
        </div>
      </div>
      <div class="grid-2" style="align-items:start;">
        <div>
          <div class="card mb-16">
            <div class="card-header"><div class="card-title">üîë –í–≤–æ–¥ –∫–ª—é—á–µ–π</div></div>
            <div class="card-body">
              <div class="form-group">
                <div class="form-label">–¶–µ–ª–µ–≤–æ–π –±–æ—Ç</div>
                <select class="form-input" id="keyBotSel">
                  <option value="">‚Äî –í—Å–µ –±–æ—Ç—ã ‚Äî</option>
                </select>
              </div>
              <div class="form-group">
                <div class="form-label">–ö–ª—é—á–∏ (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)</div>
                <textarea class="form-input" id="keysInput" placeholder="XXXXX-XXXXX-XXXXX&#10;XXXXX-XXXXX-XXXXX" style="height:140px;"></textarea>
              </div>
              <button class="btn btn-primary btn-full" style="height:42px;" onclick="redeemKeys()">üîë –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</div></div>
            <div class="card-body">
              <div class="form-check mb-12">
                <input type="checkbox" id="keyDistribute" checked>
                <label for="keyDistribute">Distribute ‚Äî —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è—Ç—å –ø–æ –±–æ—Ç–∞–º</label>
              </div>
              <div class="form-check mb-12">
                <input type="checkbox" id="keyKeepMissingGames">
                <label for="keyKeepMissingGames">KeepMissingGames ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ</label>
              </div>
              <div class="form-check">
                <input type="checkbox" id="keySkipMissingGames">
                <label for="keySkipMissingGames">SkipMissingGames ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞—Ç—å</label>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç</div>
            <button class="btn btn-ghost btn-sm" onclick="document.getElementById('keyResults').innerHTML=''">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
          </div>
          <div class="card-body" id="keyResults" style="min-height:300px;">
            <div class="empty-state">
              <div class="empty-state-icon">üîë</div>
              <div class="empty-state-text">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê TRADES PAGE ‚ïê‚ïê -->
    <div class="page" id="page-trades">
      <div class="section-header">
        <div>
          <div class="section-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ–±–º–µ–Ω–∞–º–∏</div>
          <div class="section-sub">–í—Ö–æ–¥—è—â–∏–µ, –∏—Å—Ö–æ–¥—è—â–∏–µ —Ç—Ä–µ–π–¥—ã –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadTrades()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="switchTradeTab('incoming',this)">üì• –í—Ö–æ–¥—è—â–∏–µ</div>
        <div class="tab" onclick="switchTradeTab('outgoing',this)">üì§ –ò—Å—Ö–æ–¥—è—â–∏–µ</div>
        <div class="tab" onclick="switchTradeTab('send',this)">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–π–¥</div>
        <div class="tab" onclick="switchTradeTab('blacklist',this)">üö´ –ß—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫</div>
      </div>
      <div id="tradesIncoming">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–±–º–µ–Ω–æ–≤‚Ä¶</div>
      </div>
      <div id="tradesOutgoing" style="display:none;"></div>
      <div id="tradesSend" style="display:none;">
        <div class="grid-2" style="align-items:start;">
          <div class="card">
            <div class="card-header"><div class="card-title">üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–µ–π–¥ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç</div></div>
            <div class="card-body">
              <div class="form-group">
                <div class="form-label">–ë–æ—Ç-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</div>
                <select class="form-input" id="tradeFromBot">
                  <option value="ASF">‚Äî –í—Å–µ –±–æ—Ç—ã (ASF) ‚Äî</option>
                </select>
              </div>
              <div class="form-group">
                <div class="form-label">SteamID –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
                <input class="form-input" id="tradeToId" placeholder="76561198XXXXXXXXX">
              </div>
              <div class="form-group">
                <div class="form-label">–¢–æ–∫–µ–Ω —Ç—Ä–µ–π–¥–∞ (–µ—Å–ª–∏ –Ω–µ –≤ –¥—Ä—É–∑—å—è—Ö)</div>
                <input class="form-input" id="tradeToken" placeholder="XXXXXXXX (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)">
              </div>
              <div class="divider"></div>
              <div class="form-label" style="margin-bottom:10px;">–ß—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º:</div>
              <div style="display:flex;flex-direction:column;gap:7px;">
                <button class="btn btn-cyan btn-full" onclick="sendTradeByGame('730')">üî´ CS2 ‚Äî –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
                <button class="btn btn-cyan btn-full" onclick="sendTradeByGame('440')">üé© TF2 ‚Äî –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
                <button class="btn btn-cyan btn-full" onclick="sendTradeByGame('570')">‚öîÔ∏è Dota 2 ‚Äî –≤—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
                <button class="btn btn-cyan btn-full" onclick="sendTradeByGame('753')">üÉè Steam ‚Äî –∫–∞—Ä—Ç–æ—á–∫–∏ (753)</button>
                <button class="btn btn-gold btn-full" onclick="sendTradeAll()">üí∞ –í–µ—Å—å –ª—É—Ç (–≤—Å–µ –∏–≥—Ä—ã)</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-header"><div class="card-title">üí¨ –°—Ç–∞—Ç—É—Å –æ—Ç–ø—Ä–∞–≤–∫–∏</div></div>
            <div class="card-body" style="padding:10px;">
              <div class="log-area" id="tradeLog" style="height:380px;">
                <div class="log-line"><span class="log-ok">[Trade]</span> –ì–æ—Ç–æ–≤ –∫ –æ—Ç–ø—Ä–∞–≤–∫–µ.</div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="tradesBlacklist" style="display:none;"></div>
    </div>

    <!-- ‚ïê‚ïê IDLE PAGE ‚ïê‚ïê -->
    <div class="page" id="page-idle">
      <div class="section-header">
        <div>
          <div class="section-title">Idle / –ù–∞–∫—Ä—É—Ç–∫–∞ —á–∞—Å–æ–≤</div>
          <div class="section-sub">–ò–≥—Ä—ã –∫–æ—Ç–æ—Ä—ã–µ –±–æ—Ç—ã –∑–∞–ø—É—Å–∫–∞—é—Ç –≤ —Ñ–æ–Ω–µ –¥–ª—è –Ω–∞–∫—Ä—É—Ç–∫–∏ —á–∞—Å–æ–≤</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadIdlePage()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-primary" onclick="saveAllIdleGames()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ—Ö</button>
        </div>
      </div>

      <!-- Info -->
      <div class="error-banner" style="background:rgba(245,158,11,.06);border-color:rgba(245,158,11,.2);color:var(--gold);margin-bottom:16px;">
        <div class="error-banner-icon">üí°</div>
        <div style="font-size:12px;line-height:1.7;">
          –ü–∞—Ä–∞–º–µ—Ç—Ä <code style="font-family:'JetBrains Mono',monospace;background:rgba(255,255,255,.06);padding:1px 5px;border-radius:4px;">GamesPlayedWhileIdle</code> ‚Äî –±–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç —ç—Ç–∏ –∏–≥—Ä—ã –∫–æ–≥–¥–∞ <strong>–Ω–µ —Ñ–∞—Ä–º–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏</strong>.
          –≠—Ç–æ –Ω–∞–∫—Ä—É—á–∏–≤–∞–µ—Ç —á–∞—Å—ã –≤ Steam. –£–∫–∞–∂–∏ AppID –∏–≥—Ä —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –∏–ª–∏ –ø—Ä–æ–±–µ–ª.
        </div>
      </div>

      <!-- Quick game picker -->
      <div class="card mb-16">
        <div class="card-header"><div class="card-title">üéØ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∏–≥—Ä—ã (–±—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä)</div></div>
        <div class="card-body">
          <div style="display:flex;flex-wrap:wrap;gap:7px;" id="idleGamePills">
            <div class="idle-game-pill" onclick="addIdleGameQuick(730,'CS2')">üî´ CS2 (730)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(440,'TF2')">üé© TF2 (440)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(570,'Dota 2')">‚öîÔ∏è Dota 2 (570)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(271590,'GTA V')">üöó GTA V (271590)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(1091500,'Cyberpunk')">üåÜ Cyberpunk (1091500)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(1172470,'Apex')">üéØ Apex (1172470)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(578080,'PUBG')">ü™ñ PUBG (578080)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(252490,'Rust')">ü™µ Rust (252490)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(304930,'Unturned')">üßü Unturned (304930)</div>
            <div class="idle-game-pill" onclick="addIdleGameQuick(346110,'ARK')">ü¶ï ARK (346110)</div>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:10px;">
            –ù–∞–∂–º–∏ –Ω–∞ –∏–≥—Ä—É —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –µ—ë –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–∏–∂–µ. –ü–æ—Ç–æ–º –≤—ã–±–µ—Ä–∏ –±–æ—Ç—É –∏ –Ω–∞–∂–º–∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å.
          </div>
        </div>
      </div>

      <!-- Per-bot idle settings -->
      <div id="idleBotList" style="display:flex;flex-direction:column;gap:12px;">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –±–æ—Ç–æ–≤‚Ä¶</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê ACCOUNTS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-accounts">
      <div class="section-header">
        <div>
          <div class="section-title">–ê–∫–∫–∞—É–Ω—Ç—ã</div>
          <div class="section-sub">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ Steam –∞–∫–∫–∞—É–Ω—Ç—ã ‚Äî –±—ã—Å—Ç—Ä—ã–π –≤—Ö–æ–¥ –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadAccountsPage()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-primary" onclick="openAddAccount()">+ –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        </div>
      </div>

      <!-- Info banner -->
      <div class="error-banner" style="background:rgba(6,182,212,.06);border-color:rgba(6,182,212,.2);color:var(--cyan);margin-bottom:16px;">
        <div class="error-banner-icon">‚ÑπÔ∏è</div>
        <div style="font-size:12px;line-height:1.7;">
          –î–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —Ö—Ä–∞–Ω—è—Ç—Å—è <strong>–ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ</strong> (localStorage). –ü–∞—Ä–æ–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è –Ω–∏–∫—É–¥–∞, –∫—Ä–æ–º–µ –∫–∞–∫ –Ω–∞–ø—Ä—è–º—É—é –≤ SharkFarm API –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ –≤—Ö–æ–¥–∞.
          –î–ª—è –≤—Ö–æ–¥–∞ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω –≤ ASF –∑–∞—Ä–∞–Ω–µ–µ.
        </div>
      </div>

      <div id="accountsList" style="display:flex;flex-direction:column;gap:10px;">
        <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
      </div>
    </div>

    <!-- ‚ïê‚ïê LOOT PAGE ‚ïê‚ïê -->
    <div class="page" id="page-loot">
      <div class="section-header">
        <div>
          <div class="section-title">–õ—É—Ç</div>
          <div class="section-sub">–°–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadLootPage()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- Send to account block -->
      <div class="card mb-16">
        <div class="card-header"><div class="card-title">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ª—É—Ç –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç</div></div>
        <div class="card-body">
          <div class="form-row" style="align-items:flex-end;gap:10px;margin-bottom:14px;">
            <div class="form-group" style="margin-bottom:0;flex:1;">
              <div class="form-label">SteamID –∏–ª–∏ —Ç—Ä–µ–π–¥-—Å—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
              <input class="form-input" id="lootTargetId" placeholder="76561198XXXXXXXXX –∏–ª–∏ https://steamcommunity.com/tradeoffer/new/?partner=‚Ä¶">
            </div>
            <div class="form-group" style="margin-bottom:0;width:180px;">
              <div class="form-label">–ë–æ—Ç-–∏—Å—Ç–æ—á–Ω–∏–∫</div>
              <select class="form-input" id="lootSourceBot">
                <option value="ASF">‚Äî –í—Å–µ –±–æ—Ç—ã (ASF) ‚Äî</option>
              </select>
            </div>
          </div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <button class="btn btn-gold" onclick="sendLootGame('730')">üî´ CS2 / –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
            <button class="btn btn-gold" onclick="sendLootGame('440')">üé© TF2 / –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
            <button class="btn btn-gold" onclick="sendLootGame('570')">‚öîÔ∏è Dota 2 / –í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã</button>
            <button class="btn btn-cyan" onclick="sendLootCards()">üÉè –¢–æ–ª—å–∫–æ –∫–∞—Ä—Ç–æ—á–∫–∏</button>
            <button class="btn btn-primary" onclick="sendLootAll()">üí∞ –í–µ—Å—å –ª—É—Ç (–≤—Å–µ –∏–≥—Ä—ã)</button>
          </div>
          <div style="font-size:11px;color:var(--text3);margin-top:10px;">
            ‚ö†Ô∏è –£–±–µ–¥–∏—Å—å —á—Ç–æ –±–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –¥—Ä—É–∑—å—è –∫ –ø–æ–ª—É—á–∞—Ç–µ–ª—é –∏ —É –Ω–µ–≥–æ –µ—Å—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Ç—Ä–µ–π–¥—ã.
          </div>
        </div>
      </div>

      <!-- Per-bot loot buttons -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">ü§ñ –õ—É—Ç –ø–æ –±–æ—Ç–∞–º</div>
          <div style="display:flex;gap:7px;">
            <button class="btn btn-gold btn-sm" onclick="lootAll()">üí∞ Loot –≤—Å–µ—Ö</button>
            <button class="btn btn-ghost btn-sm" onclick="loadLootPage()">üîÑ</button>
          </div>
        </div>
        <div id="lootBotList" style="padding:14px 16px;">
          <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê 2FA PAGE ‚ïê‚ïê -->
    <div class="page" id="page-twofa">
      <div class="section-header">
        <div>
          <div class="section-title">2FA –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä</div>
          <div class="section-sub">–ö–æ–¥—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è Steam Guard</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="load2FA()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- Sub-tabs -->
      <div class="tabs" style="margin-bottom:18px;">
        <div class="tab active" id="twofa-tab-codes" onclick="switch2FATab('codes',this)">üîê –ö–æ–¥—ã 2FA</div>
        <div class="tab" id="twofa-tab-login" onclick="switch2FATab('login',this)">üîë –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —Å 2FA</div>
      </div>

      <!-- Codes panel -->
      <div id="twofa-panel-codes">
        <div id="twoFAContent">
          <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
        </div>
      </div>

      <!-- Login with 2FA panel -->
      <div id="twofa-panel-login" style="display:none;">
        <div class="grid-2" style="align-items:start;">
          <div class="card">
            <div class="card-header"><div class="card-title">üîë –ë—ã—Å—Ç—Ä–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞</div></div>
            <div class="card-body">
              <div class="form-group">
                <div class="form-label">–ò–º—è –±–æ—Ç–∞ (–¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏)</div>
                <select class="form-input" id="loginBotSel">
                  <option value="">‚Äî –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî</option>
                </select>
              </div>
              <div class="form-group">
                <div class="form-label">Steam –ª–æ–≥–∏–Ω</div>
                <input class="form-input" id="loginUser" placeholder="steam_username" autocomplete="username">
              </div>
              <div class="form-group">
                <div class="form-label">–ü–∞—Ä–æ–ª—å Steam</div>
                <input class="form-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
              </div>
              <div class="form-group">
                <div class="form-label">2FA –∫–æ–¥ (Steam Guard)</div>
                <input class="form-input" id="login2FACode" placeholder="XXXXX" maxlength="10" style="font-family:'JetBrains Mono',monospace;font-size:20px;letter-spacing:6px;text-align:center;">
                <div class="form-hint">–í–≤–µ–¥–∏ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥ –∏–∑ –º–æ–±–∏–ª—å–Ω–æ–≥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∏–ª–∏ email</div>
              </div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-primary btn-full" style="height:42px;" onclick="doLoginWith2FA()">üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
                <button class="btn btn-ghost" style="height:42px;padding:0 14px;" onclick="autoFill2FACode()" title="–í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –∏–∑ –±—É—Ñ–µ—Ä–∞">üìã</button>
              </div>
              <div style="margin-top:10px;" id="loginStatus"></div>
            </div>
          </div>

          <div>
            <div class="card mb-16">
              <div class="card-header"><div class="card-title">‚ÑπÔ∏è –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div></div>
              <div class="card-body" style="font-size:12px;color:var(--text2);line-height:1.8;">
                <div style="margin-bottom:8px;">1. –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ (–∏–ª–∏ –æ—Å—Ç–∞–≤—å –ø—É—Å—Ç—ã–º –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ)</div>
                <div style="margin-bottom:8px;">2. –í–≤–µ–¥–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –∞–∫–∫–∞—É–Ω—Ç–∞ Steam</div>
                <div style="margin-bottom:8px;">3. –í–≤–µ–¥–∏ —Ç–µ–∫—É—â–∏–π 2FA –∫–æ–¥ –∏–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞</div>
                <div style="margin-bottom:8px;">4. –ù–∞–∂–º–∏ <strong style="color:var(--text);">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</strong></div>
                <div class="divider"></div>
                <div style="color:var(--text3);">SharkFarm –æ—Ç–ø—Ä–∞–≤–∏—Ç –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ ASF API. –ö–æ–¥ 2FA –¥–µ–π—Å—Ç–≤—É–µ—Ç ~30 —Å–µ–∫—É–Ω–¥ ‚Äî –≤–≤–æ–¥–∏ –±—ã—Å—Ç—Ä–æ.</div>
              </div>
            </div>

            <div class="card">
              <div class="card-header"><div class="card-title">‚è± –¢–µ–∫—É—â–∏–π 2FA –∫–æ–¥</div></div>
              <div class="card-body">
                <div id="loginCurrentBotCode" style="text-align:center;color:var(--text3);font-size:12px;padding:10px;">
                  –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–¥
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CONSOLE PAGE ‚ïê‚ïê -->
    <div class="page" id="page-cmd">
      <div class="section-header">
        <div>
          <div class="section-title">–ö–æ–º–∞–Ω–¥–Ω–∞—è –∫–æ–Ω—Å–æ–ª—å</div>
          <div class="section-sub">–ü—Ä—è–º–æ–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å SharkFarm API</div>
        </div>
        <button class="btn btn-ghost" onclick="document.getElementById('cmdOut').innerHTML=''">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
      </div>
      <div class="grid-2" style="align-items:start;">
        <div>
          <div class="card mb-16">
            <div class="card-header"><div class="card-title">‚å®Ô∏è –ö–æ–º–∞–Ω–¥–∞</div></div>
            <div class="card-body">
              <div class="form-group">
                <div class="form-label">–¶–µ–ª–µ–≤–æ–π –±–æ—Ç</div>
                <select class="form-input" id="cmdBotSel">
                  <option value="">‚Äî SharkFarm (–≤—Å–µ) ‚Äî</option>
                </select>
              </div>
              <div class="cmd-bar mb-12">
                <input class="cmd-input" id="cmdInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É‚Ä¶" onkeydown="if(event.key==='Enter')sendCmd()">
                <button class="btn btn-primary" style="padding:0 16px;height:40px;" onclick="sendCmd()">‚Üµ</button>
              </div>
              <div class="cmd-pills">
                <div class="cmd-pill" onclick="setCmd('status')">status</div>
                <div class="cmd-pill" onclick="setCmd('farm')">farm</div>
                <div class="cmd-pill" onclick="setCmd('stop')">stop</div>
                <div class="cmd-pill" onclick="setCmd('restart')">restart</div>
                <div class="cmd-pill" onclick="setCmd('2fa')">2fa</div>
                <div class="cmd-pill" onclick="setCmd('loot')">loot</div>
                <div class="cmd-pill" onclick="setCmd('exit')">exit</div>
                <div class="cmd-pill" onclick="setCmd('redeem')">redeem</div>
                <div class="cmd-pill" onclick="setCmd('addlicense')">addlicense</div>
                <div class="cmd-pill" onclick="setCmd('rejoinchat')">rejoinchat</div>
                <div class="cmd-pill" onclick="setCmd('level')">level</div>
                <div class="cmd-pill" onclick="setCmd('nickname')">nickname</div>
                <div class="cmd-pill" onclick="setCmd('owns')">owns</div>
                <div class="cmd-pill" onclick="setCmd('play')">play</div>
                <div class="cmd-pill" onclick="setCmd('reset')">reset</div>
                <div class="cmd-pill" onclick="setCmd('unpack')">unpack</div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">üí¨ –í—ã–≤–æ–¥</div></div>
          <div class="card-body" style="padding:10px;">
            <div class="log-area" id="cmdOut" style="height:480px;">
              <div class="log-line"><span class="log-ok">[SF]</span> –ö–æ–Ω—Å–æ–ª—å –≥–æ—Ç–æ–≤–∞. –í–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê LOGS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-logs">
      <div class="section-header">
        <div>
          <div class="section-title">–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</div>
          <div class="section-sub">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 200 —Å—Ç—Ä–æ–∫ –ª–æ–≥–∞ SharkFarm</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="scrollLog()">‚Üì –í –∫–æ–Ω–µ—Ü</button>
          <button class="btn btn-ghost" onclick="clearLog()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
      <div class="card">
        <div class="card-body" style="padding:10px;">
          <div class="log-area" id="fullLog" style="height:calc(100vh - 210px);"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CONFIG PAGE ‚ïê‚ïê -->
    <div class="page" id="page-config">
      <div class="section-header">
        <div>
          <div class="section-title">–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏</div>
          <div class="section-sub">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ ASF –∏ –±–æ—Ç–æ–≤</div>
        </div>
        <div class="section-actions">
          <select class="form-input small" id="configBotSel" onchange="loadBotConfig()" style="width:180px;">
            <option value="__asf">ASF (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)</option>
          </select>
        </div>
      </div>
      <div class="grid-2" style="align-items:start;">
        <div>
          <div class="card mb-16">
            <div class="card-header"><div class="card-title">‚öôÔ∏è –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div></div>
            <div class="card-body" id="configMain">
              <div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>
            </div>
          </div>
        </div>
        <div>
          <div class="card mb-16">
            <div class="card-header"><div class="card-title">üìÑ JSON —Ä–µ–¥–∞–∫—Ç–æ—Ä</div></div>
            <div class="card-body">
              <textarea class="form-input" id="configJson" style="height:320px;font-size:11px;" placeholder="{}"></textarea>
              <div style="display:flex;gap:7px;margin-top:10px;">
                <button class="btn btn-primary" onclick="saveConfig()" style="flex:1;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn-ghost" onclick="loadBotConfig()">‚Ü∫ –°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê SETTINGS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-settings">
      <div class="section-header">
        <div>
          <div class="section-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
          <div class="section-sub">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
        </div>
      </div>
      <div class="grid-2" style="align-items:start;">
        <div>
          <div class="card mb-16">
            <div class="card-header"><div class="card-title">üîå API –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</div></div>
            <div class="card-body">
              <div class="form-group">
                <div class="form-label">–•–æ—Å—Ç</div>
                <input class="form-input" id="sHost" placeholder="localhost">
              </div>
              <div class="form-group">
                <div class="form-label">–ü–æ—Ä—Ç</div>
                <input class="form-input" id="sPort" type="number" placeholder="1242">
              </div>
              <div class="form-group">
                <div class="form-label">IPCPassword (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω)</div>
                <input class="form-input" id="sPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>
              <button class="btn btn-primary btn-full" style="height:42px;" onclick="saveSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
          </div>

          <div class="card">
            <div class="card-header"><div class="card-title">‚ö° –û–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞</div></div>
            <div class="card-body" style="display:flex;flex-direction:column;gap:8px;">
              <button class="btn btn-gold btn-full" onclick="restartASF()">üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å SharkFarm</button>
              <button class="btn btn-danger btn-full" onclick="confirmShutdown()">‚èª –í—ã–∫–ª—é—á–∏—Ç—å SharkFarm</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header"><div class="card-title">ü¶à –û –ø—Ä–æ–≥—Ä–∞–º–º–µ</div></div>
          <div class="card-body" style="text-align:center;">
            <div class="about-logo-big">
              <div class="about-logo-ring"></div>
              <div class="about-logo-inner">ü¶à</div>
            </div>
            <div style="font-family:'Rajdhani',sans-serif;font-size:24px;font-weight:700;">SharkFarm</div>
            <div style="font-size:12px;color:var(--text3);margin:5px 0 16px;" id="aboutVer2">Desktop WebUI</div>
            <div class="divider"></div>
            <div style="font-size:12px;color:var(--text2);line-height:1.8;text-align:left;">
              <div>ü¶à –§–æ—Ä–∫ ArchiSteamFarm</div>
              <div>üé® –ö–∞—Å—Ç–æ–º–Ω—ã–π WebUI</div>
              <div>‚ö° .NET 10 ¬∑ win-x64</div>
              <div style="margin-top:10px;">
                <span id="aboutBuildInfo" style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);"></span>
              </div>
            </div>
            <div class="divider"></div>
            <div style="display:flex;gap:8px;justify-content:center;">
              <a class="btn btn-ghost" href="https://github.com/sistemkol1/SharkFarm" target="_blank">GitHub</a>
              <a class="btn btn-cyan" href="https://github.com/sistemkol1/SharkFarm/releases" target="_blank">–†–µ–ª–∏–∑—ã</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê STATS PAGE ‚ïê‚ïê -->
    <div class="page" id="page-stats">
      <div class="section-header">
        <div>
          <div class="section-title">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
          <div class="section-sub">–î–∞–Ω–Ω—ã–µ —Ñ–∞—Ä–º–∏–Ω–≥–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±–æ—Ç–æ–≤</div>
        </div>
        <div class="section-actions">
          <button class="btn btn-ghost" onclick="loadStats()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <!-- Mini stats row -->
      <div class="stat-mini-row" id="statsMiniRow">
        <div class="stat-mini"><div class="stat-mini-val col-gold" id="sTotal-cards">‚Äî</div><div class="stat-mini-lbl">–ö–∞—Ä—Ç–æ—á–µ–∫ –≤—Å–µ–≥–æ</div></div>
        <div class="stat-mini"><div class="stat-mini-val col-blue" id="sTotal-games">‚Äî</div><div class="stat-mini-lbl">–ò–≥—Ä –≤ –æ—á–µ—Ä–µ–¥–∏</div></div>
        <div class="stat-mini"><div class="stat-mini-val col-green" id="sTotal-online">‚Äî</div><div class="stat-mini-lbl">–ë–æ—Ç–æ–≤ –æ–Ω–ª–∞–π–Ω</div></div>
        <div class="stat-mini"><div class="stat-mini-val col-red" id="sTotal-bots">‚Äî</div><div class="stat-mini-lbl">–ë–æ—Ç–æ–≤ –≤—Å–µ–≥–æ</div></div>
        <div class="stat-mini"><div class="stat-mini-val col-purple" id="sTotal-farming">‚Äî</div><div class="stat-mini-lbl">–§–∞—Ä–º–∏—Ç —Å–µ–π—á–∞—Å</div></div>
        <div class="stat-mini"><div class="stat-mini-val" id="sTotal-uptime">‚Äî</div><div class="stat-mini-lbl">–ê–ø—Ç–∞–π–º UI</div></div>
      </div>

      <div class="grid-2 mb-16">
        <!-- Cards per bot chart -->
        <div class="card">
          <div class="card-header"><div class="card-title">üÉè –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–æ –±–æ—Ç–∞–º</div></div>
          <div class="card-body">
            <div class="chart-container" style="height:220px;">
              <canvas id="chartCards"></canvas>
            </div>
          </div>
        </div>
        <!-- Bot status pie -->
        <div class="card">
          <div class="card-header"><div class="card-title">ü§ñ –°—Ç–∞—Ç—É—Å—ã –±–æ—Ç–æ–≤</div></div>
          <div class="card-body">
            <div class="chart-container" style="height:220px;">
              <canvas id="chartStatus"></canvas>
            </div>
            <div class="chart-legend" id="statusLegend"></div>
          </div>
        </div>
      </div>

      <!-- Games per bot -->
      <div class="card mb-16">
        <div class="card-header"><div class="card-title">üéÆ –ò–≥—Ä –≤ –æ—á–µ—Ä–µ–¥–∏ –ø–æ –±–æ—Ç–∞–º</div></div>
        <div class="card-body">
          <div class="chart-container" style="height:180px;">
            <canvas id="chartGames"></canvas>
          </div>
        </div>
      </div>

      <!-- Bot activity table -->
      <div class="card">
        <div class="card-header"><div class="card-title">üìã –î–µ—Ç–∞–ª–∏ –ø–æ –±–æ—Ç–∞–º</div></div>
        <div style="overflow-x:auto;">
          <table class="data-table">
            <thead><tr>
              <th>–ë–æ—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ö–∞—Ä—Ç–æ—á–µ–∫</th><th>–ò–≥—Ä</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>SteamID</th>
            </tr></thead>
            <tbody id="statsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->
</div><!-- /layout -->

<!-- Mobile overlay -->
<div class="mob-overlay" id="mobOverlay" onclick="closeMobMenu()"></div>

<!-- Notification banners -->
<div class="notif-banner" id="notifBanner"></div>

<!-- FAB -->
<button class="btn btn-primary" id="fab" onclick="openAddBot()">+</button>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- Add Bot -->
<div class="modal-overlay" id="modalAddBot" onclick="if(event.target===this)closeModal('modalAddBot')">
  <div class="modal modal-wide">
    <h3>ü§ñ –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞</h3>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">–ò–º—è –±–æ—Ç–∞ *</div>
        <input class="form-input" id="nb-name" placeholder="MyBot">
      </div>
      <div class="form-group">
        <div class="form-label">Steam –ª–æ–≥–∏–Ω *</div>
        <input class="form-input" id="nb-login" placeholder="steam_username">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">–ü–∞—Ä–æ–ª—å Steam</div>
        <input class="form-input" id="nb-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <div class="form-group">
        <div class="form-label">–ê–∫—Ç–∏–≤–µ–Ω</div>
        <select class="form-input" id="nb-en">
          <option value="true">–î–∞</option>
          <option value="false">–ù–µ—Ç</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">SteamParentalCode</div>
        <input class="form-input" id="nb-parental" placeholder="0000 (–µ—Å–ª–∏ –µ—Å—Ç—å)">
      </div>
      <div class="form-group">
        <div class="form-label">Loot –ø—Ä–∏ –ø—Ä–æ—Å—Ç–æ–µ</div>
        <select class="form-input" id="nb-loot">
          <option value="false">–ù–µ—Ç</option>
          <option value="true">–î–∞</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddBot')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="addBot()">ü§ñ –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Bot Details -->
<div class="modal-overlay" id="modalBotDetails" onclick="if(event.target===this)closeModal('modalBotDetails')">
  <div class="modal modal-wide">
    <h3 id="botDetailTitle">ü§ñ –ë–æ—Ç</h3>
    <div id="botDetailContent"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalBotDetails')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Add / Edit Account -->
<div class="modal-overlay" id="modalAddAccount" onclick="if(event.target===this)closeModal('modalAddAccount')">
  <div class="modal modal-wide">
    <h3 id="addAccountTitle">üë§ –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h3>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è *</div>
        <input class="form-input" id="acc-label" placeholder="–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç">
      </div>
      <div class="form-group">
        <div class="form-label">–ü—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –±–æ—Ç ASF *</div>
        <select class="form-input" id="acc-bot">
          <option value="">‚Äî –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">Steam –ª–æ–≥–∏–Ω</div>
        <input class="form-input" id="acc-login" placeholder="steam_username" autocomplete="off">
      </div>
      <div class="form-group">
        <div class="form-label">–ü–∞—Ä–æ–ª—å Steam</div>
        <div style="position:relative;">
          <input class="form-input" id="acc-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" style="padding-right:36px;">
          <button onclick="togglePassVis('acc-pass',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:2px;">üëÅ</button>
        </div>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <div class="form-label">Shared Secret (–¥–ª—è –∞–≤—Ç–æ-2FA)</div>
        <div style="position:relative;">
          <input class="form-input" id="acc-secret" placeholder="base64= (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" autocomplete="off" style="padding-right:36px;font-family:'JetBrains Mono',monospace;font-size:11px;">
          <button onclick="togglePassVis('acc-secret',this)" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:2px;">üëÅ</button>
        </div>
        <div class="form-hint">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω ‚Äî 2FA –∫–æ–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –≤—Ö–æ–¥–µ</div>
      </div>
      <div class="form-group">
        <div class="form-label">SteamParentalCode (PIN)</div>
        <input class="form-input" id="acc-parental" placeholder="0000 (–µ—Å–ª–∏ –µ—Å—Ç—å)" maxlength="8">
      </div>
    </div>
    <input type="hidden" id="acc-edit-idx" value="">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddAccount')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveAccount()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Login Flow Modal -->
<div class="modal-overlay" id="modalLoginFlow" onclick="if(event.target===this&&!loginFlowRunning)closeModal('modalLoginFlow')">
  <div class="modal modal-wide">
    <h3 id="loginFlowTitle">üîê –í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3>
    <div id="loginFlowSteps" style="margin-bottom:14px;"></div>

    <!-- Manual 2FA input (shown when no shared secret) -->
    <div id="loginFlowManual2FA" style="display:none;">
      <div class="form-group">
        <div class="form-label">–í–≤–µ–¥–∏ 2FA –∫–æ–¥ –≤—Ä—É—á–Ω—É—é</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="form-input" id="loginFlow2FAInput" placeholder="XXXXX" maxlength="10"
            style="font-family:'JetBrains Mono',monospace;font-size:26px;letter-spacing:8px;text-align:center;height:52px;"
            oninput="this.value=this.value.toUpperCase()" onkeydown="if(event.key==='Enter')submitManual2FA()">
          <button class="btn btn-ghost" style="height:52px;padding:0 12px;" onclick="pasteClipboard2FA()" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">üìã</button>
        </div>
        <div class="form-hint" id="loginFlow2FAHint">–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω ~30 —Å–µ–∫—É–Ω–¥</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" style="flex:1;height:42px;" onclick="submitManual2FA()">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        <button class="btn btn-ghost" style="height:42px;" onclick="closeModal('modalLoginFlow')">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>

    <div id="loginFlowDone" style="display:none;margin-top:4px;">
      <button class="btn btn-ghost btn-full" onclick="closeModal('modalLoginFlow')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

<!-- Mass action toolbar -->
<div class="mass-toolbar" id="massToolbar">
  <div class="mass-count"><span id="massCount">0</span> –≤—ã–±—Ä–∞–Ω–æ</div>
  <div class="mass-divider"></div>
  <button class="btn btn-success btn-sm" onclick="massAction('start')">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
  <button class="btn btn-ghost btn-sm" onclick="massAction('pause')">‚è∏ –°—Ç–æ–ø</button>
  <button class="btn btn-gold btn-sm" onclick="massAction('loot')">üí∞ Loot</button>
  <button class="btn btn-cyan btn-sm" onclick="massAction('2fa')">üîê 2FA</button>
  <div class="mass-divider"></div>
  <button class="btn btn-ghost btn-sm" onclick="massAssignGroup()">üë• –í –≥—Ä—É–ø–ø—É</button>
  <div class="mass-divider"></div>
  <button class="btn btn-danger btn-sm" onclick="massAction('delete')">üóë –£–¥–∞–ª–∏—Ç—å</button>
  <div class="mass-divider"></div>
  <button class="btn btn-ghost btn-sm" onclick="exitSelectMode()">‚úï –û—Ç–º–µ–Ω–∞</button>
</div>

<!-- Add Group Modal -->
<div class="modal-overlay" id="modalAddGroup" onclick="if(event.target===this)closeModal('modalAddGroup')">
  <div class="modal">
    <h3 id="addGroupTitle">üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
    <div class="form-group">
      <div class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</div>
      <input class="form-input" id="grp-name" placeholder="–û—Å–Ω–æ–≤–Ω—ã–µ, VIP, –¢–µ—Å—Ç‚Ä¶">
    </div>
    <div class="form-group">
      <div class="form-label">–¶–≤–µ—Ç</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;" id="grpColorPicker">
        <div class="grp-color" data-c="#e63946" style="width:24px;height:24px;border-radius:50%;background:#e63946;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#e63946')"></div>
        <div class="grp-color" data-c="#06b6d4" style="width:24px;height:24px;border-radius:50%;background:#06b6d4;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#06b6d4')"></div>
        <div class="grp-color" data-c="#22c55e" style="width:24px;height:24px;border-radius:50%;background:#22c55e;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#22c55e')"></div>
        <div class="grp-color" data-c="#f59e0b" style="width:24px;height:24px;border-radius:50%;background:#f59e0b;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#f59e0b')"></div>
        <div class="grp-color" data-c="#8b5cf6" style="width:24px;height:24px;border-radius:50%;background:#8b5cf6;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#8b5cf6')"></div>
        <div class="grp-color" data-c="#3b82f6" style="width:24px;height:24px;border-radius:50%;background:#3b82f6;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#3b82f6')"></div>
        <div class="grp-color" data-c="#ff6b35" style="width:24px;height:24px;border-radius:50%;background:#ff6b35;cursor:pointer;border:2px solid transparent;" onclick="selectGroupColor(this,'#ff6b35')"></div>
      </div>
      <input type="hidden" id="grp-color" value="#e63946">
    </div>
    <div class="form-group">
      <div class="form-label">–ë–æ—Ç—ã –≤ –≥—Ä—É–ø–ø–µ</div>
      <div id="grpBotCheckboxes" style="display:flex;flex-direction:column;gap:5px;max-height:200px;overflow-y:auto;"></div>
    </div>
    <input type="hidden" id="grp-edit-idx" value="">
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalAddGroup')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="saveGroup()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Hours Editor Modal -->
<div class="modal-overlay" id="modalHoursEditor" onclick="if(event.target===this)closeModal('modalHoursEditor')">
  <div class="modal modal-wide">
    <h3>‚è∞ –ß–∞—Å—ã –±–æ—Ç–æ–≤</h3>
    <div style="font-size:12px;color:var(--text2);margin-bottom:14px;line-height:1.7;">
      –£–∫–∞–∂–∏ —Å–∫–æ–ª—å–∫–æ —á–∞—Å–æ–≤ –Ω–∞–∏–≥—Ä–∞–ª –∫–∞–∂–¥—ã–π –±–æ—Ç. –ó–Ω–∞—á–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∑–∞—Ü–∏–∏.<br>
      –ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ (100 / 500 / 1000 —á) –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Å–ª–µ–¥—É—é—â—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é.
    </div>
    <div id="hoursEditorList" style="display:flex;flex-direction:column;gap:8px;max-height:420px;overflow-y:auto;"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalHoursEditor')">–ó–∞–∫—Ä—ã—Ç—å</button>
      <button class="btn btn-primary" onclick="saveHoursAll()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ</button>
    </div>
  </div>
</div>

<!-- Mass assign group modal -->
<div class="modal-overlay" id="modalMassGroup" onclick="if(event.target===this)closeModal('modalMassGroup')">
  <div class="modal">
    <h3>üë• –î–æ–±–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É</h3>
    <div class="form-group">
      <div class="form-label">–í—ã–±–µ—Ä–∏ –≥—Ä—É–ø–ø—É</div>
      <select class="form-input" id="massGroupSel"></select>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalMassGroup')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-primary" onclick="doMassAssignGroup()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Shutdown -->
<div class="modal-overlay" id="modalShutdown" onclick="if(event.target===this)closeModal('modalShutdown')">
  <div class="modal">
    <h3>‚èª –í—ã–∫–ª—é—á–∏—Ç—å SharkFarm?</h3>
    <p style="font-size:13px;color:var(--text2);">–í—Å–µ –±–æ—Ç—ã –±—É–¥—É—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalShutdown')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-danger" onclick="doShutdown()">–í—ã–∫–ª—é—á–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- Restart -->
<div class="modal-overlay" id="modalRestart" onclick="if(event.target===this)closeModal('modalRestart')">
  <div class="modal">
    <h3>üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å SharkFarm?</h3>
    <p style="font-size:13px;color:var(--text2);">SharkFarm –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?</p>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal('modalRestart')">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn btn-gold" onclick="doRestart()">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
    </div>
  </div>
</div>

<div class="toast-wrap" id="toastWrap"></div>

<script>
// ‚ïê‚ïê CONFIG ‚ïê‚ïê
let API_HOST = localStorage.getItem('sf_host') || 'localhost';
let API_PORT = localStorage.getItem('sf_port') || '1242';
let API_PASS = localStorage.getItem('sf_pass') || '';
let BASE = () => `http://${API_HOST}:${API_PORT}/Api`;
let startTs = Date.now();
let botsCache = {};
let connected = false;
let twoFAInterval = null;
let botFilter = 'all';
let lastRefresh = null;
let prevFarmingBots = new Set();
let notifEnabled = false;

const PAGE_TITLES = {
  dash:     ['Dashboard', '–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã'],
  stats:    ['–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', '–î–∞–Ω–Ω—ã–µ —Ñ–∞—Ä–º–∏–Ω–≥–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏'],
  bots:     ['–ë–æ—Ç—ã', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞–º–∏'],
  farming:  ['–§–∞—Ä–º–∏–Ω–≥', '–ò–≥—Ä—ã –∏ –∫–∞—Ä—Ç–æ—á–∫–∏'],
  keys:     ['–ö–ª—é—á–∏', '–ê–∫—Ç–∏–≤–∞—Ü–∏—è Steam –∫–ª—é—á–µ–π'],
  accounts: ['–ê–∫–∫–∞—É–Ω—Ç—ã', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –≤—Ö–æ–¥ –≤ Steam –∞–∫–∫–∞—É–Ω—Ç—ã'],
  idle:     ['Idle / –ß–∞—Å—ã', '–ù–∞–∫—Ä—É—Ç–∫–∞ —á–∞—Å–æ–≤ –≤ –∏–≥—Ä–∞—Ö'],
  hours:    ['–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —á–∞—Å–æ–≤', '–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±–æ—Ç–æ–≤ –ø–æ –Ω–∞–∏–≥—Ä–∞–Ω–Ω–æ–º—É –≤—Ä–µ–º–µ–Ω–∏'],
  groups:   ['–ì—Ä—É–ø–ø—ã –±–æ—Ç–æ–≤', '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø–∞–º–∏'],
  loot:     ['–õ—É—Ç', '–°–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤ —Å –∞–∫–∫–∞—É–Ω—Ç–æ–≤'],
  trades:   ['–û–±–º–µ–Ω—ã', '–¢—Ä–µ–π–¥-–æ—Ñ—Ñ–µ—Ä—ã'],
  twofa:    ['2FA Auth', 'Steam Guard –∫–æ–¥—ã'],
  cmd:      ['–ö–æ–Ω—Å–æ–ª—å', '–ö–æ–º–∞–Ω–¥–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å'],
  logs:     ['–õ–æ–≥–∏', '–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π'],
  config:   ['–ö–æ–Ω—Ñ–∏–≥', '–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏'],
  settings: ['–ù–∞—Å—Ç—Ä–æ–π–∫–∏', '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'],
};

// ‚ïê‚ïê MOBILE MENU ‚ïê‚ïê
function toggleMobMenu() {
  document.querySelector('.sidebar').classList.toggle('mob-open');
  document.getElementById('mobOverlay').classList.toggle('mob-open');
}
function closeMobMenu() {
  document.querySelector('.sidebar').classList.remove('mob-open');
  document.getElementById('mobOverlay').classList.remove('mob-open');
}

// ‚ïê‚ïê NAV ‚ïê‚ïê
function showPage(id) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
  document.getElementById('page-' + id)?.classList.add('active');
  document.getElementById('nav-' + id)?.classList.add('active');
  document.getElementById('fab').style.display = id === 'bots' ? 'flex' : 'none';
  const [title, sub] = PAGE_TITLES[id] || [id, ''];
  document.getElementById('topbarTitle').textContent = title;
  document.getElementById('topbarSub').textContent = sub;
  if (id === 'settings') fillSettings();
  if (id === 'logs') { loadLog(); setTimeout(scrollLog, 100); }
  if (id === 'farming') loadFarming();
  if (id === 'trades') loadTrades();
  if (id === 'accounts') loadAccountsPage();
  if (id === 'hours') loadHoursPage();
  if (id === 'groups') loadGroupsPage();
  if (id === 'idle') loadIdlePage();
  if (id === 'loot') loadLootPage();
  if (id === 'twofa') load2FA();
  if (id === 'config') { loadConfigBotList(); loadBotConfig(); }
  if (id === 'stats') loadStats();
  if (twoFAInterval && id !== 'twofa') { clearInterval(twoFAInterval); twoFAInterval = null; }
  closeMobMenu();
}

// ‚ïê‚ïê API ‚ïê‚ïê
async function api(path, method = 'GET', body = null) {
  const h = { 'Content-Type': 'application/json' };
  if (API_PASS) h['Authentication'] = API_PASS;
  const opts = { method, headers: h };
  if (body) opts.body = JSON.stringify(body);
  const res = await fetch(BASE() + path, opts);
  if (!res.ok) throw new Error('HTTP ' + res.status);
  return res.json();
}

// ‚ïê‚ïê STATUS ‚ïê‚ïê
function setConnected(ok) {
  connected = ok;
  const s = document.getElementById('sidebarStatus');
  s.className = 'sidebar-status' + (ok ? '' : ' offline');
  document.getElementById('statusText').textContent = ok ? 'Online' : 'Offline';
}

// ‚ïê‚ïê REFRESH INDICATOR ‚ïê‚ïê
function setRefreshLoading(loading) {
  const dot = document.getElementById('refreshDot');
  if (!dot) return;
  dot.className = 'refresh-dot' + (loading ? ' loading' : '');
}
function updateRefreshTime() {
  const el = document.getElementById('refreshTime');
  if (!el || !lastRefresh) return;
  const s = Math.floor((Date.now() - lastRefresh) / 1000);
  el.textContent = s < 60 ? `${s}—Å –Ω–∞–∑–∞–¥` : `${Math.floor(s/60)}–º –Ω–∞–∑–∞–¥`;
}

// ‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê
async function requestNotifications() {
  if (!('Notification' in window)) return;
  if (Notification.permission === 'default') {
    const perm = await Notification.requestPermission();
    notifEnabled = perm === 'granted';
  } else {
    notifEnabled = Notification.permission === 'granted';
  }
}

function showNotif(title, body, icon = 'ü¶à') {
  // In-app notification banner
  const banner = document.getElementById('notifBanner');
  const item = document.createElement('div');
  item.className = 'notif-item';
  item.innerHTML = `<div class="notif-icon">${icon}</div><div class="notif-body"><div class="notif-title">${esc(title)}</div><div class="notif-sub">${esc(body)}</div></div><div class="notif-close" onclick="this.parentElement.remove()">√ó</div>`;
  banner.appendChild(item);
  setTimeout(() => item.remove(), 8000);

  // Browser notification
  if (notifEnabled && document.hidden) {
    new Notification('SharkFarm: ' + title, { body, icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg"><text y="14" font-size="14">ü¶à</text></svg>' });
  }
}

function checkFarmingNotifications(names) {
  // Detect bots that stopped farming
  const currentFarming = new Set(names.filter(n => (botsCache[n]?.CardsFarmer?.CurrentGamesFarming?.length || 0) > 0));
  prevFarmingBots.forEach(name => {
    if (!currentFarming.has(name) && botsCache[name]) {
      const cards = cardsRemaining(botsCache[name]);
      if (cards === 0) {
        showNotif('–§–∞—Ä–º–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω!', `–ë–æ—Ç ${name} –∑–∞–∫–æ–Ω—á–∏–ª —Ñ–∞—Ä–º–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏`, 'üéâ');
      }
    }
  });
  prevFarmingBots = currentFarming;
}

// ‚ïê‚ïê BOT SEARCH & FILTER ‚ïê‚ïê
let currentBotFilter = 'all';

function setFilter(filter, btn) {
  currentBotFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderFilteredBots();
}

function filterBots() { renderFilteredBots(); }

let groupFilter = null; // group id or null

function renderFilteredBots() {
  const search = (document.getElementById('botSearch')?.value || '').toLowerCase();
  const names = Object.keys(botsCache);
  const favs  = getFavorites();
  const filtered = names.filter(n => {
    if (search && !n.toLowerCase().includes(search)) return false;
    const bot = botsCache[n];
    const cls = botClass(bot);
    if (currentBotFilter === 'fav'     && !favs.includes(n)) return false;
    if (currentBotFilter === 'online'  && cls !== 'bc-online' && cls !== 'bc-farming') return false;
    if (currentBotFilter === 'farming' && cls !== 'bc-farming') return false;
    if (currentBotFilter === 'offline' && cls !== 'bc-offline' && cls !== 'bc-idle') return false;
    if (groupFilter) {
      const grp = getGroups().find(g => g.id === groupFilter);
      if (!grp || !grp.bots.includes(n)) return false;
    }
    return true;
  });

  // Sort: favorites first, then by online status
  filtered.sort((a, b) => {
    const af = favs.includes(a) ? 0 : 1;
    const bf = favs.includes(b) ? 0 : 1;
    if (af !== bf) return af - bf;
    const statusOrder = { 'bc-farming': 0, 'bc-online': 1, 'bc-idle': 2, 'bc-offline': 3 };
    return (statusOrder[botClass(botsCache[a])] || 3) - (statusOrder[botClass(botsCache[b])] || 3);
  });

  const el = document.getElementById('fullBotList');
  if (!el) return;
  if (!filtered.length) {
    el.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üîç</div><div class="empty-state-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div>`;
  } else {
    el.innerHTML = filtered.map(n => renderBotCard(n, botsCache[n])).join('');
    // Restore checkbox states
    selectedBots.forEach(name => {
      const chk = document.getElementById(`chk-${name}`);
      if (chk) chk.checked = true;
    });
  }
  // Update group filter chips
  renderGroupFilterChips();
}

// ‚ïê‚ïê BOT HELPERS ‚ïê‚ïê
function botClass(bot) {
  if (!bot.KeepRunning) return 'bc-offline';
  if ((bot.CardsFarmer?.CurrentGamesFarming?.length || 0) > 0) return 'bc-farming';
  if (bot.IsConnectedAndLoggedOn) return 'bc-online';
  return 'bc-idle';
}
function botStatusBadge(bot) {
  const c = botClass(bot);
  const map = { 'bc-online':['sb-online','üü¢ –û–Ω–ª–∞–π–Ω'], 'bc-farming':['sb-farming','üéÆ –§–∞—Ä–º–∏—Ç'], 'bc-idle':['sb-idle','üü° –û–∂–∏–¥–∞–Ω–∏–µ'], 'bc-offline':['sb-offline','‚ö´ –û—Ñ—Ñ–ª–∞–π–Ω'] };
  const [cls, label] = map[c];
  return `<span class="status-badge ${cls}">${label}</span>`;
}
function botRingClass(bot) {
  return { 'bc-online':'ring-online','bc-farming':'ring-farming','bc-idle':'ring-idle','bc-offline':'' }[botClass(bot)];
}
function cardsRemaining(bot) {
  return bot.CardsFarmer?.GamesToFarm?.reduce((a, g) => a + (g.CardsRemaining || 0), 0) || 0;
}
function currentGame(bot) {
  const g = bot.CardsFarmer?.CurrentGamesFarming;
  if (!g || g.length === 0) return '‚Äî';
  return g.map(x => x.GameName || `App ${x.AppID}`).join(', ');
}

// ‚ïê‚ïê RENDER BOT ROW ‚ïê‚ïê
// Helper: find saved account linked to this bot
function getLinkedAccount(botName) {
  return getAccounts().find(a => a.bot === botName) || null;
}

function renderBotRow(name, bot) {
  const cls = botClass(bot);
  const ring = botRingClass(bot);
  const cards = cardsRemaining(bot);
  const game = currentGame(bot);
  const maxCards = bot.CardsFarmer?.GamesToFarm?.reduce((a,g)=>a+(g.CardsRemaining||0)+(g.CardsDropped||0),0)||0;
  const pct = maxCards > 0 ? Math.round((1 - cards/maxCards)*100) : 0;
  const linked = getLinkedAccount(name);
  const loginBtn = linked
    ? `<button class="btn btn-sm" style="background:linear-gradient(135deg,rgba(230,57,70,.18),rgba(255,107,53,.12));color:var(--accent);border:1px solid rgba(230,57,70,.3);padding:3px 8px;" onclick="quickLoginBot('${esc(name)}')" title="–í–æ–π—Ç–∏: ${esc(linked.label||linked.login)}">üîê</button>`
    : '';
  return `<tr>
    <td><div class="bot-avatar-sm">
      ${ring ? `<div class="bot-ring-sm ${ring}"></div>` : ''}
      <span style="position:relative;z-index:2;">ü§ñ</span>
    </div></td>
    <td><div class="bot-name-cell">${esc(name)}</div>${linked?`<div style="font-size:9px;color:var(--accent);margin-top:1px;letter-spacing:.5px;">üîó ${esc(linked.label||linked.login)}</div>`:''}</td>
    <td>${botStatusBadge(bot)}</td>
    <td><div class="bot-game-cell">${esc(game)}</div></td>
    <td><span style="font-family:'JetBrains Mono',monospace;color:var(--gold);font-size:12px;">${cards || '‚Äî'}</span></td>
    <td><div class="progress-mini"><div class="progress-mini-fill" style="width:${pct}%"></div></div></td>
    <td>
      <div class="flex gap-8">
        ${loginBtn}
        <button class="btn btn-success btn-sm btn-icon" onclick="resumeBot('${esc(name)}')" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å">‚ñ∂</button>
        <button class="btn btn-ghost btn-sm btn-icon" onclick="pauseBot('${esc(name)}')" title="–ü–∞—É–∑–∞">‚è∏</button>
        <button class="btn btn-cyan btn-sm btn-icon" onclick="showBotDetails('${esc(name)}')" title="–î–µ—Ç–∞–ª–∏">üîç</button>
      </div>
    </td>
  </tr>`;
}

// ‚ïê‚ïê RENDER BOT CARD ‚ïê‚ïê
function renderBotCard(name, bot) {
  const cls = botClass(bot);
  const ring = botRingClass(bot);
  const cards = cardsRemaining(bot);
  const game = currentGame(bot);
  const linked = getLinkedAccount(name);
  const isFav = getFavorites().includes(name);
  const isAR  = getAutoRestart().includes(name);
  const grp   = getBotGroup(name);
  return `<div class="bot-card-full ${cls}${isFav?' is-favorite':''}${isSelected(name)?' selected':''}" id="botcard-${esc(name)}">
    <input type="checkbox" class="bot-select-check" id="chk-${esc(name)}" onchange="toggleBotSelect('${esc(name)}',this.checked)">
    <button class="fav-btn${isFav?' on':''}" onclick="toggleFav('${esc(name)}')" title="${isFav?'–£–±—Ä–∞—Ç—å –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ':'–î–æ–±–∞–≤–∏—Ç—å –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ'}">‚≠ê</button>
    <div class="bot-card-top"></div>
    <div class="bot-card-body">
      <div class="bot-avatar-lg">
        <div class="bot-ring-lg"></div>
        <span style="position:relative;z-index:2;">ü§ñ</span>
      </div>
      <div class="bot-info">
        <div class="bot-name-lg">${esc(name)}</div>
        <div class="bot-detail-lg">${esc(game)}</div>
        <div style="margin-top:5px;display:flex;align-items:center;gap:5px;flex-wrap:wrap;">
          ${botStatusBadge(bot)}
          ${isAR ? '<span class="ar-badge">‚ü≥ –ê–≤—Ç–æ-—Ä–µ—Å—Ç–∞—Ä—Ç</span>' : ''}
          ${grp ? `<span class="group-chip" style="background:${grp.color}22;color:${grp.color};border-color:${grp.color}44;">${esc(grp.name)}</span>` : ''}
          ${linked ? `<span style="font-size:9px;color:var(--accent);background:rgba(230,57,70,.1);border:1px solid rgba(230,57,70,.22);padding:1px 6px;border-radius:10px;">üîó ${esc(linked.label||linked.login)}</span>` : ''}
        </div>
      </div>
    </div>
    <div class="bot-card-stats">
      <div class="bot-stat-mini">
        <div class="bot-stat-mini-val" style="color:var(--gold);">${cards || '0'}</div>
        <div class="bot-stat-mini-lbl">–ö–∞—Ä—Ç–æ—á–µ–∫</div>
      </div>
      <div class="bot-stat-mini">
        <div class="bot-stat-mini-val" style="color:var(--cyan);">${(bot.CardsFarmer?.GamesToFarm?.length || 0)}</div>
        <div class="bot-stat-mini-lbl">–ò–≥—Ä</div>
      </div>
      <div class="bot-stat-mini">
        <div class="bot-stat-mini-val" style="color:var(--purple);">${bot.SteamLevel || '‚Äî'}</div>
        <div class="bot-stat-mini-lbl">–£—Ä–æ–≤–µ–Ω—å</div>
      </div>
    </div>
    <div class="bot-card-footer" style="margin-top:10px;">
      ${linked ? `<button class="btn btn-sm" style="background:linear-gradient(135deg,rgba(230,57,70,.22),rgba(255,107,53,.15));color:#fff;border:1px solid rgba(230,57,70,.4);flex:1.2;" onclick="quickLoginBot('${esc(name)}')" title="–í–æ–π—Ç–∏ –≤ ${esc(linked.label||linked.login)}">üîê –í–æ–π—Ç–∏</button>` : ''}
      <button class="btn btn-success btn-sm" style="flex:1;" onclick="resumeBot('${esc(name)}')">‚ñ∂ –°—Ç–∞—Ä—Ç</button>
      <button class="btn btn-ghost btn-sm" style="flex:1;" onclick="pauseBot('${esc(name)}')">‚è∏ –ü–∞—É–∑–∞</button>
      <button class="btn btn-gold btn-sm btn-icon" onclick="openBotIdle('${esc(name)}')" title="Idle —á–∞—Å—ã">üéÆ</button>
      <button class="btn btn-cyan btn-sm btn-icon" onclick="showBotDetails('${esc(name)}')">üîç</button>
      <button class="btn btn-danger btn-sm btn-icon" onclick="deleteBot('${esc(name)}')">üóë</button>
    </div>
  </div>`;
}

// ‚ïê‚ïê LOAD BOTS ‚ïê‚ïê
async function loadBots() {
  setRefreshLoading(true);
  try {
    const res = await api('/Bot/ASF');
    if (!res?.Result) { setConnected(false); return; }
    setConnected(true);
    botsCache = res.Result;
    lastRefresh = Date.now();
    const names = Object.keys(botsCache);
    const active  = names.filter(n => botsCache[n].IsConnectedAndLoggedOn).length;
    const farming = names.filter(n => (botsCache[n].CardsFarmer?.CurrentGamesFarming?.length||0)>0).length;
    const cards   = names.reduce((a,n)=>a+cardsRemaining(botsCache[n]),0);

    document.getElementById('st-online').textContent  = active;
    document.getElementById('st-total').textContent   = names.length;
    document.getElementById('st-farming').textContent = farming;
    document.getElementById('st-cards').textContent   = cards || '‚Äî';

    // Stats page mini counters
    const se = id => document.getElementById(id);
    if(se('sTotal-cards'))   se('sTotal-cards').textContent  = cards || '0';
    if(se('sTotal-games'))   se('sTotal-games').textContent  = names.reduce((a,n)=>a+(botsCache[n].CardsFarmer?.GamesToFarm?.length||0),0);
    if(se('sTotal-online'))  se('sTotal-online').textContent = active;
    if(se('sTotal-bots'))    se('sTotal-bots').textContent   = names.length;
    if(se('sTotal-farming')) se('sTotal-farming').textContent= farming;

    const badge = document.getElementById('botBadge');
    badge.textContent = names.length;
    badge.style.display = names.length ? 'inline' : 'none';

    const noBots = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ü§ñ</div><div class="empty-state-text">–ù–µ—Ç –±–æ—Ç–æ–≤. –ù–∞–∂–º–∏ + —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å.</div></div></td></tr>`;
    document.getElementById('dashBotTable').innerHTML = names.length ? names.map(n=>renderBotRow(n,botsCache[n])).join('') : noBots;

    renderFilteredBots();

    const botOptions = '<option value="">‚Äî SharkFarm (–≤—Å–µ) ‚Äî</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    ['cmdBotSel','keyBotSel'].forEach(id => { const el=document.getElementById(id); if(el) el.innerHTML=botOptions; });

    const lootBotOpts = '<option value="ASF">‚Äî –í—Å–µ –±–æ—Ç—ã (ASF) ‚Äî</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    ['lootSourceBot','tradeFromBot','loginBotSel'].forEach(id => { const el=document.getElementById(id); if(el) el.innerHTML=(id==='loginBotSel'?'<option value="">‚Äî –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî</option>':'')+lootBotOpts.replace('<option value="ASF">‚Äî –í—Å–µ –±–æ—Ç—ã (ASF) ‚Äî</option>','<option value="ASF">‚Äî –í—Å–µ –±–æ—Ç—ã (ASF) ‚Äî</option>'); });

    checkFarmingNotifications(names);
    checkAutoRestart(names);

  } catch {
    setConnected(false);
    const err = `<tr><td colspan="7"><div class="error-banner" style="margin:10px;"><div class="error-banner-icon">‚ö°</div><div>–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ SharkFarm.<br><span style="font-size:10px;">–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ SharkFarm –∑–∞–ø—É—â–µ–Ω –Ω–∞ ${API_HOST}:${API_PORT}</span></div><button class="btn btn-ghost btn-sm" onclick="showPage('settings')" style="margin-left:auto;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button></div></td></tr>`;
    document.getElementById('dashBotTable').innerHTML = err;
  } finally {
    setRefreshLoading(false);
  }
}

// ‚ïê‚ïê STATS ‚ïê‚ïê
let chartsInitialized = false;
let chartCards, chartStatus, chartGames;

async function loadStats() {
  const names = Object.keys(botsCache);
  if (!names.length) return;

  // Update stats table
  const tbody = document.getElementById('statsTable');
  if (tbody) {
    tbody.innerHTML = names.map(n => {
      const bot = botsCache[n];
      return `<tr>
        <td><strong style="font-family:'Rajdhani',sans-serif;">${esc(n)}</strong></td>
        <td>${botStatusBadge(bot)}</td>
        <td style="color:var(--gold);font-family:'JetBrains Mono',monospace;">${cardsRemaining(bot)}</td>
        <td style="color:var(--cyan);">${bot.CardsFarmer?.GamesToFarm?.length||0}</td>
        <td style="color:var(--purple);">${bot.SteamLevel||'‚Äî'}</td>
        <td style="font-family:'JetBrains Mono',monospace;font-size:10px;color:var(--text3);">${bot.SteamID||'‚Äî'}</td>
      </tr>`;
    }).join('');
  }

  // Draw charts using Canvas API (no external libs)
  drawBarChart('chartCards', names, names.map(n=>cardsRemaining(botsCache[n])), '#f59e0b', '–ö–∞—Ä—Ç–æ—á–µ–∫');
  drawBarChart('chartGames', names, names.map(n=>botsCache[n].CardsFarmer?.GamesToFarm?.length||0), '#06b6d4', '–ò–≥—Ä');

  // Status pie
  const online  = names.filter(n=>botClass(botsCache[n])==='bc-online').length;
  const farming = names.filter(n=>botClass(botsCache[n])==='bc-farming').length;
  const idle    = names.filter(n=>botClass(botsCache[n])==='bc-idle').length;
  const offline = names.filter(n=>botClass(botsCache[n])==='bc-offline').length;
  drawPieChart('chartStatus', ['–û–Ω–ª–∞–π–Ω','–§–∞—Ä–º–∏—Ç','–û–∂–∏–¥–∞–Ω–∏–µ','–û—Ñ–ª–∞–π–Ω'], [online,farming,idle,offline], ['#22c55e','#06b6d4','#f59e0b','#475569']);

  const legend = document.getElementById('statusLegend');
  if (legend) {
    legend.innerHTML = [
      {l:'–û–Ω–ª–∞–π–Ω',c:'#22c55e',v:online},
      {l:'–§–∞—Ä–º–∏—Ç',c:'#06b6d4',v:farming},
      {l:'–û–∂–∏–¥–∞–Ω–∏–µ',c:'#f59e0b',v:idle},
      {l:'–û—Ñ–ª–∞–π–Ω',c:'#475569',v:offline}
    ].map(x=>`<div class="chart-legend-item"><div class="chart-legend-dot" style="background:${x.c}"></div>${x.l}: <strong>${x.v}</strong></div>`).join('');
  }
}

function drawBarChart(canvasId, labels, values, color, label) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 400;
  const H = canvas.offsetHeight || 220;
  canvas.width = W * devicePixelRatio;
  canvas.height = H * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);

  const pad = { t:20, r:16, b:40, l:44 };
  const chartW = W - pad.l - pad.r;
  const chartH = H - pad.t - pad.b;
  const max = Math.max(...values, 1);
  const barW = Math.max(8, chartW / Math.max(labels.length, 1) - 6);

  ctx.clearRect(0, 0, W, H);

  // Grid lines
  ctx.strokeStyle = 'rgba(255,255,255,0.04)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.t + chartH - (chartH * i / 4);
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(pad.l + chartW, y); ctx.stroke();
    ctx.fillStyle = 'rgba(148,163,184,0.5)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'right';
    ctx.fillText(Math.round(max * i / 4), pad.l - 6, y + 3);
  }

  // Bars
  labels.forEach((lbl, i) => {
    const v = values[i] || 0;
    const x = pad.l + (chartW / labels.length) * i + (chartW / labels.length - barW) / 2;
    const barH = (v / max) * chartH;
    const y = pad.t + chartH - barH;

    // Bar gradient
    const grad = ctx.createLinearGradient(0, y, 0, y + barH);
    grad.addColorStop(0, color);
    grad.addColorStop(1, color + '44');
    ctx.fillStyle = grad;
    ctx.beginPath();
    ctx.roundRect(x, y, barW, barH, [3, 3, 0, 0]);
    ctx.fill();

    // Value on top
    if (v > 0) {
      ctx.fillStyle = color;
      ctx.font = 'bold 10px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(v, x + barW/2, y - 4);
    }

    // Label
    ctx.fillStyle = 'rgba(148,163,184,0.7)';
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    const shortLbl = lbl.length > 8 ? lbl.slice(0, 7) + '‚Ä¶' : lbl;
    ctx.fillText(shortLbl, x + barW/2, H - pad.b + 14);
  });
}

function drawPieChart(canvasId, labels, values, colors) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth || 280;
  const H = canvas.offsetHeight || 220;
  canvas.width = W * devicePixelRatio;
  canvas.height = H * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);

  const total = values.reduce((a,b) => a+b, 0) || 1;
  const cx = W/2, cy = H/2, r = Math.min(W, H) / 2 - 20;
  let startAngle = -Math.PI / 2;

  ctx.clearRect(0, 0, W, H);

  values.forEach((v, i) => {
    if (!v) return;
    const slice = (v / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, startAngle, startAngle + slice);
    ctx.closePath();
    ctx.fillStyle = colors[i];
    ctx.fill();
    ctx.strokeStyle = 'rgba(6,8,15,0.8)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Label
    const midAngle = startAngle + slice / 2;
    const lx = cx + Math.cos(midAngle) * r * 0.65;
    const ly = cy + Math.sin(midAngle) * r * 0.65;
    if (v / total > 0.08) {
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 11px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(v, lx, ly);
    }
    startAngle += slice;
  });

  // Center hole
  ctx.beginPath();
  ctx.arc(cx, cy, r * 0.45, 0, Math.PI * 2);
  ctx.fillStyle = '#0c1020';
  ctx.fill();

  // Center text
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 20px Rajdhani';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(total, cx, cy - 6);
  ctx.fillStyle = 'rgba(148,163,184,0.6)';
  ctx.font = '9px Inter';
  ctx.fillText('–ë–û–¢–û–í', cx, cy + 10);
}

// ‚ïê‚ïê VERSION ‚ïê‚ïê
async function loadVersion() {
  try {
    const res = await api('/ASF');
    const v = res?.Result?.Version;
    if (v) {
      const ver = 'v' + [v.Major,v.Minor,v.Build,v.Revision].join('.');
      document.getElementById('statusVer').textContent = ver;
      document.getElementById('aboutVer').textContent  = ver;
      document.getElementById('aboutVer2').textContent = ver + ' ¬∑ Desktop UI';
    }
    const build = res?.Result?.BuildVariant;
    if (build) document.getElementById('aboutBuildInfo').textContent = build;
  } catch {}
}

// ‚ïê‚ïê BOT ACTIONS ‚ïê‚ïê
async function resumeBot(name) {
  try { await api(`/Bot/${name}/Resume`,'POST'); toast('‚ñ∂ '+name+' –∑–∞–ø—É—â–µ–Ω','t-ok'); setTimeout(loadBots,1200); }
  catch { toast('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞','t-err'); }
}
async function pauseBot(name) {
  try { await api(`/Bot/${name}/Pause`,'POST',{Permanent:false}); toast('‚è∏ '+name+' –ø–∞—É–∑–∞','t-ok'); setTimeout(loadBots,1200); }
  catch { toast('–û—à–∏–±–∫–∞','t-err'); }
}
async function deleteBot(name) {
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞ "${name}"?`)) return;
  try { await api(`/Bot/${name}`,'DELETE'); toast('üóë '+name+' —É–¥–∞–ª—ë–Ω','t-inf'); setTimeout(loadBots,1200); }
  catch { toast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è','t-err'); }
}
async function startAllBots() {
  for (const n of Object.keys(botsCache)) { try { await api(`/Bot/${n}/Resume`,'POST'); } catch {} }
  toast('‚ñ∂ –í—Å–µ –±–æ—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã','t-ok'); setTimeout(loadBots,2000);
}
async function stopAllBots() {
  for (const n of Object.keys(botsCache)) { try { await api(`/Bot/${n}/Pause`,'POST',{Permanent:false}); } catch {} }
  toast('‚èπ –í—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã','t-inf'); setTimeout(loadBots,2000);
}
async function lootAll() {
  try { await api('/Bot/ASF/Loot','POST'); toast('üí∞ Loot –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω','t-ok'); }
  catch { toast('–û—à–∏–±–∫–∞ loot','t-err'); }
}

// ‚ïê‚ïê ADD BOT ‚ïê‚ïê
function openAddBot() { closeAllModals(); document.getElementById('modalAddBot').classList.add('open'); }
async function addBot() {
  const name   = document.getElementById('nb-name').value.trim();
  const login  = document.getElementById('nb-login').value.trim();
  const pass   = document.getElementById('nb-pass').value;
  const en     = document.getElementById('nb-en').value === 'true';
  if (!name || !login) { toast('–ó–∞–ø–æ–ª–Ω–∏ –∏–º—è –∏ –ª–æ–≥–∏–Ω','t-err'); return; }
  const body = { SteamLogin:login, SteamPassword:pass, Enabled:en };
  const p = document.getElementById('nb-parental').value.trim();
  if (p) body.SteamParentalCode = p;
  try {
    await api(`/Bot/${name}`,'POST',body);
    toast('‚úÖ –ë–æ—Ç –¥–æ–±–∞–≤–ª–µ–Ω','t-ok');
    closeModal('modalAddBot');
    setTimeout(loadBots,1200);
  } catch { toast('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è','t-err'); }
}

// ‚ïê‚ïê BOT DETAILS ‚ïê‚ïê
function showBotDetails(name) {
  const bot = botsCache[name];
  if (!bot) return;
  const games = bot.CardsFarmer?.GamesToFarm || [];
  const currentGames = bot.CardsFarmer?.CurrentGamesFarming || [];
  document.getElementById('botDetailTitle').innerHTML = `ü§ñ ${esc(name)} ${botStatusBadge(bot)}`;
  document.getElementById('botDetailContent').innerHTML = `
    <div class="grid-2 mb-16">
      <div class="stat-card sc-gold" style="padding:12px;">
        <div class="stat-label">–ö–∞—Ä—Ç–æ—á–µ–∫ –æ—Å—Ç–∞–ª–æ—Å—å</div>
        <div class="stat-val" style="font-size:28px;">${cardsRemaining(bot) || '0'}</div>
      </div>
      <div class="stat-card sc-cyan" style="padding:12px;">
        <div class="stat-label">–ò–≥—Ä –≤ –æ—á–µ—Ä–µ–¥–∏</div>
        <div class="stat-val" style="font-size:28px;">${games.length}</div>
      </div>
    </div>
    ${currentGames.length ? `
    <div class="card mb-16">
      <div class="card-header"><div class="card-title">üéÆ –°–µ–π—á–∞—Å —Ñ–∞—Ä–º–∏—Ç</div></div>
      <div class="card-body">
        ${currentGames.map(g=>`<div class="game-row">
          <div class="game-name">${esc(g.GameName||'App '+g.AppID)}</div>
          <div class="game-cards">üÉè ${g.CardsRemaining||0}</div>
        </div>`).join('')}
      </div>
    </div>` : ''}
    <div class="card mb-16">
      <div class="card-header"><div class="card-title">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div></div>
      <div class="card-body">
        <table class="data-table"><tbody>
          <tr><td style="color:var(--text3);width:140px;">SteamID</td><td style="font-family:'JetBrains Mono',monospace;font-size:11px;">${bot.SteamID||'‚Äî'}</td></tr>
          <tr><td style="color:var(--text3);">–£—Ä–æ–≤–µ–Ω—å</td><td>${bot.SteamLevel||'‚Äî'}</td></tr>
          <tr><td style="color:var(--text3);">KeepRunning</td><td>${bot.KeepRunning?'‚úÖ':'‚ùå'}</td></tr>
          <tr><td style="color:var(--text3);">Connected</td><td>${bot.IsConnectedAndLoggedOn?'‚úÖ':'‚ùå'}</td></tr>
        </tbody></table>
      </div>
    </div>
    <div style="display:flex;gap:7px;flex-wrap:wrap;">
      <button class="btn btn-success" onclick="resumeBot('${esc(name)}');closeModal('modalBotDetails')">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <button class="btn btn-ghost" onclick="pauseBot('${esc(name)}');closeModal('modalBotDetails')">‚è∏ –ü–∞—É–∑–∞</button>
      <button class="btn btn-gold" onclick="lootBot('${esc(name)}')">üí∞ Loot</button>
      <button class="btn ${getAutoRestart().includes(name)?'btn-purple':'btn-ghost'}" onclick="toggleAutoRestart('${esc(name)}');closeModal('modalBotDetails')">${getAutoRestart().includes(name)?'‚ü≥ AR –≤–∫–ª':'‚ü≥ –ê–≤—Ç–æ-—Ä–µ—Å—Ç–∞—Ä—Ç'}</button>
      <button class="btn btn-danger" onclick="deleteBot('${esc(name)}');closeModal('modalBotDetails')">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  `;
  document.getElementById('modalBotDetails').classList.add('open');
}

async function lootBot(name) {
  try { await api(`/Bot/${name}/Loot`,'POST'); toast('üí∞ Loot '+name,'t-ok'); }
  catch { toast('–û—à–∏–±–∫–∞','t-err'); }
}

// ‚ïê‚ïê FARMING ‚ïê‚ïê
async function loadFarming() {
  const el = document.getElementById('farmingContent');
  el.innerHTML = '<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  const names = Object.keys(botsCache);
  if (!names.length) { el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üåæ</div><div class="empty-state-text">–ù–µ—Ç –±–æ—Ç–æ–≤</div></div>'; return; }
  let html = '';
  for (const name of names) {
    const bot = botsCache[name];
    const games = bot.CardsFarmer?.GamesToFarm || [];
    const current = bot.CardsFarmer?.CurrentGamesFarming || [];
    const totalCards = cardsRemaining(bot);
    html += `<div class="card mb-16">
      <div class="card-header">
        <div class="card-title">ü§ñ ${esc(name)} ${botStatusBadge(bot)}</div>
        <div style="font-size:11px;color:var(--text3);">üÉè ${totalCards} –∫–∞—Ä—Ç–æ—á–µ–∫ ¬∑ üéÆ ${games.length} –∏–≥—Ä</div>
      </div>
      <div class="card-body">
        ${games.length === 0 ? '<div style="color:var(--text3);font-size:12px;text-align:center;padding:10px;">–ù–µ—Ç –∏–≥—Ä –¥–ª—è —Ñ–∞—Ä–º–∏–Ω–≥–∞</div>' :
          games.map(g => {
            const maxC = (g.CardsRemaining||0)+(g.CardsDropped||0);
            const pct = maxC > 0 ? Math.round((g.CardsDropped||0)/maxC*100) : 0;
            const isCurrent = current.some(c=>c.AppID===g.AppID);
            return `<div class="game-row">
              ${isCurrent ? '<span style="color:var(--cyan);">‚ñ∂</span>' : '<span style="color:var(--text3);">¬∑</span>'}
              <div class="game-name">${esc(g.GameName||'App '+g.AppID)}</div>
              <div class="game-cards">üÉè ${g.CardsRemaining||0}</div>
              <div class="game-progress"><div class="game-progress-fill" style="width:${pct}%"></div></div>
              <div style="font-size:10px;color:var(--text3);min-width:30px;">${pct}%</div>
            </div>`;
          }).join('')}
      </div>
    </div>`;
  }
  el.innerHTML = html;
}

// ‚ïê‚ïê KEYS ‚ïê‚ïê
async function redeemKeys() {
  const bot = document.getElementById('keyBotSel').value;
  const raw = document.getElementById('keysInput').value.trim();
  if (!raw) { toast('–í–≤–µ–¥–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∫–ª—é—á','t-err'); return; }
  const keys = raw.split('\n').map(k=>k.trim()).filter(k=>k);
  const resultsEl = document.getElementById('keyResults');
  resultsEl.innerHTML = '<div class="loading-state"><div class="spinner"></div>–ê–∫—Ç–∏–≤–∞—Ü–∏—è‚Ä¶</div>';
  const results = [];
  for (const key of keys) {
    try {
      const ep = bot ? `/Bot/${bot}/GamesToRedeemInBackground` : '/Bot/ASF/GamesToRedeemInBackground';
      await api(ep, 'POST', { KeyToRedeem: key });
      results.push({ key, status:'ok', msg:'–î–æ–±–∞–≤–ª–µ–Ω –≤ –æ—á–µ—Ä–µ–¥—å' });
    } catch(e) {
      results.push({ key, status:'err', msg:'–û—à–∏–±–∫–∞: '+e.message });
    }
  }
  resultsEl.innerHTML = results.map(r=>`
    <div class="key-result key-${r.status}">
      <span style="font-family:'JetBrains Mono',monospace;flex:1;">${esc(r.key)}</span>
      <span>${r.status==='ok'?'‚úÖ':'‚ùå'} ${esc(r.msg)}</span>
    </div>`).join('');
  toast(`‚úÖ ${results.filter(r=>r.status==='ok').length}/${results.length} –¥–æ–±–∞–≤–ª–µ–Ω–æ`,'t-ok');
}

// ‚ïê‚ïê TRADES ‚ïê‚ïê
async function loadTrades() {
  const el = document.getElementById('tradesIncoming');
  el.innerHTML = '<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  try {
    const res = await api('/Bot/ASF/TradeOffer');
    const trades = res?.Result || [];
    if (!trades.length) { el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîÑ</div><div class="empty-state-text">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –æ–±–º–µ–Ω–æ–≤</div></div>'; return; }
    el.innerHTML = trades.map(t=>`
      <div class="trade-card">
        <div class="flex gap-8 mb-12">
          <div style="font-weight:600;flex:1;">–¢—Ä–µ–π–¥ #${t.TradeOfferID}</div>
          <div class="status-badge sb-idle">${t.State||'Pending'}</div>
        </div>
        <div style="font-size:11px;color:var(--text3);">–û—Ç: ${t.SteamID||'‚Äî'} ¬∑ –ü–æ–ª—É—á–∞–µ–º: ${t.ItemsToReceive?.length||0} ¬∑ –û—Ç–¥–∞—ë–º: ${t.ItemsToGive?.length||0}</div>
        <div style="display:flex;gap:7px;margin-top:10px;">
          <button class="btn btn-success btn-sm">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
          <button class="btn btn-danger btn-sm">‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
        </div>
      </div>`).join('');
  } catch { el.innerHTML = '<div class="error-banner"><div class="error-banner-icon">‚ö°</div><div>–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ API</div></div>'; }
}

function switchTradeTab(tab, el) {
  document.querySelectorAll('#page-trades .tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  ['tradesIncoming','tradesOutgoing','tradesSend','tradesBlacklist'].forEach(id=>{ const e=document.getElementById(id); if(e) e.style.display='none'; });
  const key = 'trades'+tab.charAt(0).toUpperCase()+tab.slice(1);
  const panel = document.getElementById(key);
  if(panel) panel.style.display='block';
}

// ‚ïê‚ïê 2FA ‚ïê‚ïê
async function load2FA() {
  const el = document.getElementById('twoFAContent');
  el.innerHTML = '<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  const names = Object.keys(botsCache).filter(n=>botsCache[n].IsConnectedAndLoggedOn);
  if (!names.length) { el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üîê</div><div class="empty-state-text">–ù–µ—Ç –æ–Ω–ª–∞–π–Ω –±–æ—Ç–æ–≤ —Å 2FA</div></div>'; return; }
  const codes = {};
  for (const name of names) {
    try { const res = await api(`/Bot/${name}/TwoFactorAuthentication/Token`); codes[name] = res?.Result || null; }
    catch { codes[name] = null; }
  }
  el.innerHTML = `<div class="grid-3">` + names.map(n=>`
    <div class="card">
      <div class="card-header"><div class="card-title">ü§ñ ${esc(n)}</div></div>
      <div class="card-body" style="text-align:center;">
        <div class="twofa-code" id="code-${esc(n)}">${codes[n]?.Token || '‚Äî'}</div>
        <div class="twofa-timer"><div class="twofa-timer-fill" id="timer-${esc(n)}" style="width:${codes[n]?.SteamTimeLeft!=null?(codes[n].SteamTimeLeft/30*100):0}%"></div></div>
        <div style="font-size:11px;color:var(--text3);margin-top:8px;" id="timeleft-${esc(n)}">${codes[n]?.SteamTimeLeft!=null?codes[n].SteamTimeLeft+'—Å':''}</div>
        <div style="display:flex;gap:7px;justify-content:center;margin-top:12px;">
          <button class="btn btn-cyan btn-sm" onclick="refresh2FA('${esc(n)}')">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-ghost btn-sm" onclick="confirm2FA('${esc(n)}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
      </div>
    </div>`).join('') + '</div>';
  if (twoFAInterval) clearInterval(twoFAInterval);
  twoFAInterval = setInterval(() => update2FATimers(names, codes), 1000);
}

function update2FATimers(names, codes) {
  names.forEach(n => {
    const timerEl = document.getElementById(`timer-${n}`);
    const leftEl  = document.getElementById(`timeleft-${n}`);
    if (!codes[n] || !timerEl) return;
    const left = Math.max(0, codes[n].SteamTimeLeft - 1);
    codes[n].SteamTimeLeft = left;
    timerEl.style.width = (left / 30 * 100) + '%';
    if (leftEl) leftEl.textContent = left + '—Å';
    if (left === 0) refresh2FA(n, codes);
  });
}

async function refresh2FA(name, codesRef) {
  try {
    const res = await api(`/Bot/${name}/TwoFactorAuthentication/Token`);
    const data = res?.Result;
    if (data) {
      const el = document.getElementById(`code-${name}`);
      if (el) el.textContent = data.Token || '‚Äî';
      if (codesRef) codesRef[name] = data;
    }
  } catch {}
}

async function confirm2FA(name) {
  try { await api(`/Bot/${name}/TwoFactorAuthentication/Confirmations`,'POST'); toast('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø—Ä–∏–Ω—è—Ç—ã –¥–ª—è '+name,'t-ok'); }
  catch { toast('–û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è','t-err'); }
}

// ‚ïê‚ïê CONFIG ‚ïê‚ïê
async function loadConfigBotList() {
  const sel = document.getElementById('configBotSel');
  const names = Object.keys(botsCache);
  sel.innerHTML = '<option value="__asf">ASF (–≥–ª–æ–±–∞–ª—å–Ω—ã–π)</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
}

async function loadBotConfig() {
  const sel = document.getElementById('configBotSel');
  const val = sel?.value;
  const mainEl = document.getElementById('configMain');
  const jsonEl = document.getElementById('configJson');
  if (!mainEl || !jsonEl) return;
  mainEl.innerHTML = '<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</div>';
  try {
    let data;
    if (val === '__asf') { const res = await api('/ASF'); data = res?.Result?.GlobalConfig || {}; }
    else { const res = await api(`/Bot/${val}`); data = res?.Result?.[val] || {}; }
    jsonEl.value = JSON.stringify(data, null, 2);
    mainEl.innerHTML = val === '__asf' ? `
      <div class="form-group"><div class="form-label">AutoRestart</div><select class="form-input"><option value="true" ${data.AutoRestart?'selected':''}>–î–∞</option><option value="false">–ù–µ—Ç</option></select></div>
      <div class="form-group"><div class="form-label">Headless</div><select class="form-input"><option value="true" ${data.Headless?'selected':''}>–î–∞</option><option value="false">–ù–µ—Ç</option></select></div>
      <div class="form-group"><div class="form-label">IPCPassword</div><input class="form-input" value="${esc(data.IPCPassword||'')}" placeholder="–ü—É—Å—Ç–æ = –±–µ–∑ –ø–∞—Ä–æ–ª—è"></div>` :
      `<div class="form-group"><div class="form-label">Enabled</div><select class="form-input"><option value="true" ${data.Enabled?'selected':''}>–î–∞</option><option value="false">–ù–µ—Ç</option></select></div>
      <div class="form-group"><div class="form-label">FarmingOrder</div><select class="form-input"><option value="0">Unordered</option><option value="3" ${data.FarmingOrder===3?'selected':''}>CardDropsAscending</option><option value="4" ${data.FarmingOrder===4?'selected':''}>CardDropsDescending</option></select></div>
      <div class="form-group"><div class="form-label">OnlineStatus</div><select class="form-input"><option value="0">Offline</option><option value="1" ${!data.OnlineStatus||data.OnlineStatus===1?'selected':''}>Online</option></select></div>
      <div class="divider"></div>
      <div class="config-section-title">üéÆ –ù–∞–∫—Ä—É—Ç–∫–∞ —á–∞—Å–æ–≤</div>
      <div class="form-group">
        <div class="form-label">GamesPlayedWhileIdle (AppID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</div>
        <input class="form-input" id="cfgIdleGames" value="${esc((data.GamesPlayedWhileIdle||[]).join(', '))}" placeholder="730, 440, 570‚Ä¶" style="font-family:'JetBrains Mono',monospace;">
        <div class="form-hint">–ò–≥—Ä—ã –∑–∞–ø—É—Å–∫–∞—é—Ç—Å—è –≤ —Ñ–æ–Ω–µ –∫–æ–≥–¥–∞ –±–æ—Ç –Ω–µ —Ñ–∞—Ä–º–∏—Ç –∫–∞—Ä—Ç–æ—á–∫–∏</div>
      </div>
      <button class="btn btn-gold btn-full" onclick="saveIdleFromConfig('${esc(val)}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å idle –∏–≥—Ä—ã</button>`;
  } catch { mainEl.innerHTML = '<div class="error-banner"><div class="error-banner-icon">‚ö°</div><div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ñ–∏–≥–∞</div></div>'; }
}

async function saveIdleFromConfig(botName) {
  const raw = document.getElementById('cfgIdleGames')?.value || '';
  const ids = raw.split(/[\s,;]+/).map(s => parseInt(s)).filter(n => !isNaN(n) && n > 0);
  try {
    const res = await api(`/Bot/${botName}`);
    const current = res?.Result?.[botName] || {};
    await api(`/Bot/${botName}`, 'POST', { ...current, GamesPlayedWhileIdle: ids });
    // sync idle page state
    idleGamesState[botName] = ids;
    toast(`‚úÖ Idle –∏–≥—Ä—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è ${botName}: [${ids.join(', ')}]`, 't-ok');
  } catch(e) { toast('–û—à–∏–±–∫–∞: ' + e.message, 't-err'); }
}

async function saveConfig() {
  const val = document.getElementById('configBotSel')?.value;
  try {
    const data = JSON.parse(document.getElementById('configJson').value);
    await api(val === '__asf' ? '/ASF' : `/Bot/${val}`, 'POST', data);
    toast('üíæ –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω','t-ok');
  } catch(e) {
    toast(e instanceof SyntaxError ? '–û—à–∏–±–∫–∞ JSON: –ø—Ä–æ–≤–µ—Ä—å —Ñ–æ—Ä–º–∞—Ç' : '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è','t-err');
  }
}

// ‚ïê‚ïê COMMANDS ‚ïê‚ïê
function setCmd(c)      { document.getElementById('cmdInput').value = c; document.getElementById('cmdInput').focus(); }
function setQuickCmd(c) { document.getElementById('quickCmd').value = c; document.getElementById('quickCmd').focus(); }

async function sendCmd() {
  const bot = document.getElementById('cmdBotSel').value;
  const cmd = document.getElementById('cmdInput').value.trim();
  if (!cmd) return;
  const out = document.getElementById('cmdOut');
  const ts  = new Date().toLocaleTimeString();
  out.innerHTML += `<div class="log-line"><span class="log-time">${ts}</span><span class="log-warn"> [YOU‚Üí${bot||'SF'}]</span> ${esc(cmd)}</div>`;
  document.getElementById('cmdInput').value = '';
  try {
    const ep  = bot ? `/Bot/${bot}/Command` : '/Command';
    const res = await api(ep,'POST',{Command:cmd});
    const reply = esc(String(res?.Result ?? res?.Message ?? 'OK'));
    out.innerHTML += `<div class="log-line"><span class="log-time">${ts}</span><span class="log-ok"> [SF]</span> ${reply}</div>`;
  } catch {
    out.innerHTML += `<div class="log-line"><span class="log-time">${ts}</span><span class="log-err"> [ERR]</span> –ù–µ—Ç —Å–≤—è–∑–∏</div>`;
  }
  out.scrollTop = out.scrollHeight;
}

async function sendQuickCmd() {
  const cmd = document.getElementById('quickCmd').value.trim();
  if (!cmd) return;
  const out = document.getElementById('quickOut');
  const ts  = new Date().toLocaleTimeString();
  out.innerHTML += `<div class="log-line"><span class="log-time">${ts}</span><span class="log-warn"> ‚Ä∫</span> ${esc(cmd)}</div>`;
  document.getElementById('quickCmd').value = '';
  try {
    const res = await api('/Command','POST',{Command:cmd});
    const reply = esc(String(res?.Result ?? res?.Message ?? 'OK'));
    out.innerHTML += `<div class="log-line"><span class="log-time">${ts}</span><span class="log-ok"> ‚Äπ</span> ${reply}</div>`;
  } catch { out.innerHTML += `<div class="log-line"><span class="log-err"> [ERR]</span> –ù–µ—Ç —Å–≤—è–∑–∏</div>`; }
  out.scrollTop = out.scrollHeight;
}

// ‚ïê‚ïê LOGS ‚ïê‚ïê
async function loadLog() {
  try {
    const res = await api('/NLog');
    const lines = (res?.Result || []).slice(-200);
    const toHtml = lines => lines.map(l => {
      const t = esc(String(l));
      let cls = 'log-info';
      if (/error|exception|fail/i.test(t)) cls = 'log-err';
      else if (/warn/i.test(t)) cls = 'log-warn';
      else if (/success|card|add|redeem|farm/i.test(t)) cls = 'log-ok';
      return `<div class="log-line"><span class="${cls}">${t}</span></div>`;
    }).join('');
    const html = toHtml(lines) || '<div class="log-line" style="color:var(--text3);">–ù–µ—Ç –ª–æ–≥–æ–≤.</div>';
    document.getElementById('fullLog').innerHTML = html;
    document.getElementById('dashLog').innerHTML = toHtml(lines.slice(-50));
    scrollLog();
  } catch {}
}
function clearLog() { ['fullLog','dashLog'].forEach(id => { const el=document.getElementById(id); if(el) el.innerHTML=''; }); }
function scrollLog() { ['fullLog','dashLog'].forEach(id => { const el=document.getElementById(id); if(el) el.scrollTop=el.scrollHeight; }); }

// ‚ïê‚ïê SETTINGS ‚ïê‚ïê
function fillSettings() {
  document.getElementById('sHost').value = API_HOST;
  document.getElementById('sPort').value = API_PORT;
  document.getElementById('sPass').value = API_PASS;
}
function saveSettings() {
  API_HOST = document.getElementById('sHost').value.trim() || 'localhost';
  API_PORT = document.getElementById('sPort').value.trim() || '1242';
  API_PASS = document.getElementById('sPass').value;
  localStorage.setItem('sf_host', API_HOST);
  localStorage.setItem('sf_port', API_PORT);
  localStorage.setItem('sf_pass', API_PASS);
  toast('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ','t-ok');
  refreshAll();
}

// ‚ïê‚ïê SHUTDOWN / RESTART ‚ïê‚ïê
function confirmShutdown() { closeAllModals(); document.getElementById('modalShutdown').classList.add('open'); }
function restartASF()      { closeAllModals(); document.getElementById('modalRestart').classList.add('open'); }
async function doShutdown() { closeModal('modalShutdown'); try { await api('/ASF/Exit','POST'); toast('–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã‚Ä¶','t-inf'); } catch {} }
async function doRestart()  { closeModal('modalRestart');  try { await api('/ASF/Restart','POST'); toast('üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫‚Ä¶','t-warn'); } catch {} }

// ‚ïê‚ïê QUICK OPEN IDLE FOR BOT ‚ïê‚ïê
function openBotIdle(botName) {
  showPage('idle');
  // After page loads, scroll to that bot's card and focus its input
  setTimeout(() => {
    idleActiveBotInput = botName;
    const el = document.getElementById(`idlecard-${botName}`);
    if (el) { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); el.style.borderColor = 'rgba(245,158,11,.5)'; setTimeout(() => el.style.borderColor = '', 1500); }
    const inp = document.getElementById(`idleinput-${botName}`);
    if (inp) inp.focus();
  }, 400);
}

// ‚ïê‚ïê QUICK LOGIN FROM BOT CARD ‚ïê‚ïê
function quickLoginBot(botName) {
  const accounts = getAccounts();
  const idx = accounts.findIndex(a => a.bot === botName);
  if (idx === -1) {
    toast('–ù–µ—Ç –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è ' + botName, 't-warn');
    return;
  }
  startAccountLogin(idx);
}

// ‚ïê‚ïê ACCOUNTS ‚ïê‚ïê
const ACCOUNTS_KEY = 'sf_accounts';

function getAccounts() {
  try { return JSON.parse(localStorage.getItem(ACCOUNTS_KEY) || '[]'); } catch { return []; }
}
function saveAccounts(arr) {
  localStorage.setItem(ACCOUNTS_KEY, JSON.stringify(arr));
}

function loadAccountsPage() {
  const accounts = getAccounts();
  const bots = Object.keys(botsCache);
  const el = document.getElementById('accountsList');
  if (!el) return;

  if (!accounts.length) {
    el.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">üë§</div>
      <div class="empty-state-text">–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</div>
      <button class="btn btn-primary" style="margin-top:14px;" onclick="openAddAccount()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>`;
    return;
  }

  el.innerHTML = accounts.map((acc, idx) => {
    const botData  = botsCache[acc.bot];
    const botCls   = botData ? botClass(botData) : 'bc-offline';
    const online   = botCls === 'bc-online' || botCls === 'bc-farming';
    const statusBadge = botData ? botStatusBadge(botData) : '<span class="status-badge sb-offline">‚ö´ –ù–µ—Ç –±–æ—Ç–∞</span>';
    return `<div class="account-card">
      <div class="account-avatar">üßë‚Äçüíª</div>
      <div class="account-info">
        <div class="account-name">${esc(acc.label || acc.login || '–ê–∫–∫–∞—É–Ω—Ç')}</div>
        <div class="account-login">${esc(acc.login || '‚Äî')}</div>
        <div class="account-meta">
          ${acc.bot ? `<span class="account-tag tag-bot">ü§ñ ${esc(acc.bot)}</span>` : ''}
          ${acc.pass ? '<span class="account-tag tag-pass">üîë –ü–∞—Ä–æ–ª—å</span>' : '<span class="account-tag tag-nopass">‚ö† –ë–µ–∑ –ø–∞—Ä–æ–ª—è</span>'}
          ${acc.secret ? '<span class="account-tag tag-2fa">üîê –ê–≤—Ç–æ-2FA</span>' : '<span class="account-tag" style="background:rgba(148,163,184,.08);color:var(--text3);border:1px solid rgba(148,163,184,.15);">‚úã –†—É—á–Ω–æ–π 2FA</span>'}
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end;flex-shrink:0;">
        <div>${statusBadge}</div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-success btn-sm" onclick="startAccountLogin(${idx})" title="–í–æ–π—Ç–∏">‚ñ∂ –í–æ–π—Ç–∏</button>
          <button class="btn btn-ghost btn-sm" onclick="editAccount(${idx})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm" onclick="deleteAccount(${idx})" title="–£–¥–∞–ª–∏—Ç—å">üóë</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openAddAccount() {
  // Reset form
  ['acc-label','acc-login','acc-pass','acc-secret','acc-parental'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
  document.getElementById('acc-edit-idx').value = '';
  document.getElementById('addAccountTitle').textContent = 'üë§ –î–æ–±–∞–≤–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
  // Fill bot select
  const sel = document.getElementById('acc-bot');
  if (sel) {
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî</option>' + Object.keys(botsCache).map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  }
  closeAllModals();
  document.getElementById('modalAddAccount').classList.add('open');
}

function editAccount(idx) {
  const accounts = getAccounts();
  const acc = accounts[idx];
  if (!acc) return;
  document.getElementById('acc-label').value   = acc.label   || '';
  document.getElementById('acc-login').value   = acc.login   || '';
  document.getElementById('acc-pass').value    = acc.pass    || '';
  document.getElementById('acc-secret').value  = acc.secret  || '';
  document.getElementById('acc-parental').value= acc.parental|| '';
  document.getElementById('acc-edit-idx').value= String(idx);
  document.getElementById('addAccountTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
  const sel = document.getElementById('acc-bot');
  if (sel) {
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî</option>' + Object.keys(botsCache).map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
    sel.value = acc.bot || '';
  }
  closeAllModals();
  document.getElementById('modalAddAccount').classList.add('open');
}

function saveAccount() {
  const label    = document.getElementById('acc-label').value.trim();
  const bot      = document.getElementById('acc-bot').value;
  const login    = document.getElementById('acc-login').value.trim();
  const pass     = document.getElementById('acc-pass').value;
  const secret   = document.getElementById('acc-secret').value.trim();
  const parental = document.getElementById('acc-parental').value.trim();

  if (!label && !login) { toast('–ó–∞–ø–æ–ª–Ω–∏ –∏–º—è –∏–ª–∏ –ª–æ–≥–∏–Ω', 't-err'); return; }

  const accounts = getAccounts();
  const acc = { label, bot, login, pass, secret, parental };
  const editIdx = document.getElementById('acc-edit-idx').value;

  if (editIdx !== '') {
    accounts[parseInt(editIdx)] = acc;
    toast('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –æ–±–Ω–æ–≤–ª—ë–Ω', 't-ok');
  } else {
    accounts.push(acc);
    toast('‚úÖ –ê–∫–∫–∞—É–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 't-ok');
  }
  saveAccounts(accounts);
  closeModal('modalAddAccount');
  loadAccountsPage();
}

function deleteAccount(idx) {
  const accounts = getAccounts();
  const acc = accounts[idx];
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç "${acc.label || acc.login}"?`)) return;
  accounts.splice(idx, 1);
  saveAccounts(accounts);
  toast('üóë –£–¥–∞–ª—ë–Ω', 't-inf');
  loadAccountsPage();
}

function togglePassVis(inputId, btn) {
  const el = document.getElementById(inputId);
  if (!el) return;
  el.type = el.type === 'password' ? 'text' : 'password';
  btn.textContent = el.type === 'password' ? 'üëÅ' : 'üôà';
}

// ‚ïê‚ïê‚ïê LOGIN FLOW ‚ïê‚ïê‚ïê
let loginFlowRunning = false;
let loginFlowAccount = null;

function addFlowStep(icon, title, sub, cls='') {
  const el = document.getElementById('loginFlowSteps');
  const id = 'step-' + Date.now() + Math.random();
  el.innerHTML += `<div class="login-flow-step ${cls}" id="${id}">
    <div class="login-step-icon">${icon}</div>
    <div class="login-step-text">
      <div class="login-step-title">${esc(title)}</div>
      ${sub ? `<div class="login-step-sub">${esc(sub)}</div>` : ''}
    </div>
  </div>`;
  return id;
}

function updateFlowStep(id, icon, title, sub, cls) {
  const el = document.getElementById(id);
  if (!el) return;
  el.className = 'login-flow-step ' + cls;
  el.querySelector('.login-step-icon').textContent = icon;
  el.querySelector('.login-step-title').textContent = title;
  const subEl = el.querySelector('.login-step-sub');
  if (subEl) subEl.textContent = sub || '';
}

// Generate TOTP code from shared secret (HMAC-SHA1 based)
async function generateTOTP(secret) {
  try {
    // Decode base32 shared secret
    const base32Chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
    const clean = secret.toUpperCase().replace(/=+$/, '').replace(/[^A-Z2-7]/g, '');
    let bits = '';
    for (const c of clean) {
      const idx = base32Chars.indexOf(c);
      if (idx < 0) continue;
      bits += idx.toString(2).padStart(5, '0');
    }
    const bytes = new Uint8Array(Math.floor(bits.length / 8));
    for (let i = 0; i < bytes.length; i++) bytes[i] = parseInt(bits.slice(i*8, i*8+8), 2);

    const counter = Math.floor(Date.now() / 1000 / 30);
    const counterBytes = new Uint8Array(8);
    let c = counter;
    for (let i = 7; i >= 0; i--) { counterBytes[i] = c & 0xff; c = Math.floor(c / 256); }

    const key = await crypto.subtle.importKey('raw', bytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
    const sig = await crypto.subtle.sign('HMAC', key, counterBytes);
    const hash = new Uint8Array(sig);
    const offset = hash[19] & 0xf;
    const code = ((hash[offset] & 0x7f) << 24 | hash[offset+1] << 16 | hash[offset+2] << 8 | hash[offset+3]) % 1000000;
    return code.toString().padStart(6, '0');
  } catch(e) {
    console.warn('TOTP gen error:', e);
    return null;
  }
}

// Steam uses a custom base64 for shared_secret ‚Äî try both
async function generateSteam2FA(sharedSecret) {
  // Try standard base64 first
  try {
    const clean = sharedSecret.trim();
    // If it looks like base64 (contains +/= chars or long alphanumeric)
    if (/^[A-Za-z0-9+/]+=*$/.test(clean) && clean.length > 20) {
      const bytes = Uint8Array.from(atob(clean), c => c.charCodeAt(0));
      const counter = Math.floor(Date.now() / 1000 / 30);
      const counterBytes = new Uint8Array(8);
      let c = counter;
      for (let i = 7; i >= 0; i--) { counterBytes[i] = c & 0xff; c = Math.floor(c / 256); }
      const key = await crypto.subtle.importKey('raw', bytes, { name: 'HMAC', hash: 'SHA-1' }, false, ['sign']);
      const sig = await crypto.subtle.sign('HMAC', key, counterBytes);
      const hash = new Uint8Array(sig);
      const offset = hash[19] & 0xf;
      const fullCode = ((hash[offset] & 0x7f) << 24 | hash[offset+1] << 16 | hash[offset+2] << 8 | hash[offset+3]) % 100000;
      const chars = '23456789BCDFGHJKMNPQRTVWXY';
      let code = '';
      let rem = fullCode;
      for (let i = 0; i < 5; i++) { code += chars[rem % chars.length]; rem = Math.floor(rem / chars.length); }
      return code;
    }
  } catch {}
  // Fallback: try base32 TOTP
  return generateTOTP(sharedSecret);
}

async function startAccountLogin(idx) {
  const accounts = getAccounts();
  const acc = accounts[idx];
  if (!acc) return;

  loginFlowAccount = acc;
  loginFlowRunning = true;

  // Reset modal
  document.getElementById('loginFlowTitle').textContent = `üîê –í—Ö–æ–¥: ${acc.label || acc.login}`;
  document.getElementById('loginFlowSteps').innerHTML = '';
  document.getElementById('loginFlowManual2FA').style.display = 'none';
  document.getElementById('loginFlowDone').style.display = 'none';
  document.getElementById('loginFlow2FAInput').value = '';
  closeAllModals();
  document.getElementById('modalLoginFlow').classList.add('open');

  // Step 1: Check bot exists
  const s1 = addFlowStep('‚è≥', '–ü—Ä–æ–≤–µ—Ä–∫–∞ –±–æ—Ç–∞', `–ò—â–µ–º –±–æ—Ç "${acc.bot || '‚Äî'}" –≤ ASF‚Ä¶`, 'step-spin');
  await sleep(300);

  if (!acc.bot || !botsCache[acc.bot]) {
    updateFlowStep(s1, '‚ùå', '–ë–æ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', `–ë–æ—Ç "${acc.bot}" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ASF. –°–æ–∑–¥–∞–π –µ–≥–æ —Å–Ω–∞—á–∞–ª–∞.`, 'step-err');
    loginFlowRunning = false;
    document.getElementById('loginFlowDone').style.display = 'block';
    return;
  }
  updateFlowStep(s1, '‚úÖ', '–ë–æ—Ç –Ω–∞–π–¥–µ–Ω', `${acc.bot} ¬∑ ${botStatusBadge(botsCache[acc.bot]).replace(/<[^>]+>/g,'')}`, 'step-ok');

  // Step 2: Update credentials if provided
  if (acc.login || acc.pass) {
    const s2 = addFlowStep('‚è≥', '–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö', '–ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å –≤ –∫–æ–Ω—Ñ–∏–≥ –±–æ—Ç–∞‚Ä¶', 'step-spin');
    try {
      const body = {};
      if (acc.login) body.SteamLogin = acc.login;
      if (acc.pass)  body.SteamPassword = acc.pass;
      if (acc.parental) body.SteamParentalCode = acc.parental;
      await api(`/Bot/${acc.bot}`, 'POST', body);
      updateFlowStep(s2, '‚úÖ', '–î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', `–õ–æ–≥–∏–Ω: ${acc.login || '‚Äî'}`, 'step-ok');
    } catch(e) {
      updateFlowStep(s2, '‚ö†Ô∏è', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å', e.message, 'step-err');
    }
  }

  // Step 3: Resume bot
  const s3 = addFlowStep('‚è≥', '–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞', '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É Resume‚Ä¶', 'step-spin');
  try {
    await api(`/Bot/${acc.bot}/Resume`, 'POST');
    updateFlowStep(s3, '‚úÖ', '–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω', '–û–∂–∏–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Steam‚Ä¶', 'step-ok');
  } catch(e) {
    updateFlowStep(s3, '‚ö†Ô∏è', 'Resume –Ω–µ —É–¥–∞–ª—Å—è', e.message, 'step-err');
  }

  await sleep(2000);

  // Step 4: Handle 2FA
  const s4 = addFlowStep('‚è≥', '2FA –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', '–û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥‚Ä¶', 'step-spin');

  if (acc.secret) {
    // Auto-generate Steam 2FA
    updateFlowStep(s4, 'üîê', '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è 2FA –∫–æ–¥–∞', '–ò—Å–ø–æ–ª—å–∑—É–µ–º shared_secret‚Ä¶', 'step-spin');
    const code = await generateSteam2FA(acc.secret);
    if (code) {
      updateFlowStep(s4, 'üîê', '2FA –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω', `–ö–æ–¥: ${code} ¬∑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ ASF‚Ä¶`, 'step-spin');
      await sleep(500);
      try {
        const res = await api(`/Bot/${acc.bot}/Command`, 'POST', { Command: `2faok ${code}` });
        const reply = res?.Result || res?.Message || 'OK';
        updateFlowStep(s4, '‚úÖ', '2FA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', reply, 'step-ok');
      } catch(e) {
        updateFlowStep(s4, '‚ö†Ô∏è', '2FA –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å', e.message + ' (–∫–æ–¥: ' + code + ')', 'step-err');
      }
    } else {
      updateFlowStep(s4, '‚ùå', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å 2FA', '–ü—Ä–æ–≤–µ—Ä—å shared_secret –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∞–∫–∫–∞—É–Ω—Ç–∞.', 'step-err');
    }
    addFlowStep('üîÑ', '–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', '–ë–æ—Ç –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Steam‚Ä¶', '');
    await sleep(3000);
    await loadBots();
    addFlowStep('‚úÖ', '–ì–æ—Ç–æ–≤–æ!', '–ü—Ä–æ—Ü–µ—Å—Å –≤—Ö–æ–¥–∞ –∑–∞–≤–µ—Ä—à—ë–Ω. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞.', 'step-ok');
    loginFlowRunning = false;
    document.getElementById('loginFlowDone').style.display = 'block';

  } else {
    // Manual 2FA required
    updateFlowStep(s4, '‚úã', '–ù—É–∂–µ–Ω –∫–æ–¥ 2FA', 'Shared secret –Ω–µ —É–∫–∞–∑–∞–Ω ‚Äî –≤–≤–µ–¥–∏ –∫–æ–¥ –≤—Ä—É—á–Ω—É—é ‚Üì', 'step-spin');
    document.getElementById('loginFlowManual2FA').style.display = 'block';
    document.getElementById('loginFlow2FAInput').focus();
    // Start countdown hint
    let secs = 30;
    const hint = document.getElementById('loginFlow2FAHint');
    const timer = setInterval(() => {
      secs--;
      if (hint) hint.textContent = `–ö–æ–¥ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –µ—â—ë ~${Math.max(0,secs)}—Å`;
      if (secs <= 0) { clearInterval(timer); if(hint) hint.textContent = '–ö–æ–¥ –∏—Å—Ç—ë–∫ ‚Äî –ø–æ–ª—É—á–∏ –Ω–æ–≤—ã–π!'; hint.style.color = 'var(--accent)'; }
    }, 1000);
    window._loginFlowTimer = timer;
  }

  setTimeout(loadBots, 4000);
}

async function submitManual2FA() {
  const code = document.getElementById('loginFlow2FAInput').value.trim().toUpperCase();
  if (!code || code.length < 5) { toast('–í–≤–µ–¥–∏ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 't-err'); return; }
  if (window._loginFlowTimer) { clearInterval(window._loginFlowTimer); window._loginFlowTimer = null; }

  document.getElementById('loginFlowManual2FA').style.display = 'none';
  const acc = loginFlowAccount;
  const s = addFlowStep('‚è≥', '–û—Ç–ø—Ä–∞–≤–∫–∞ 2FA –∫–æ–¥–∞', `–ö–æ–¥: ${code}`, 'step-spin');

  try {
    const res = await api(`/Bot/${acc.bot}/Command`, 'POST', { Command: `2faok ${code}` });
    const reply = res?.Result || res?.Message || 'OK';
    updateFlowStep(s, '‚úÖ', '2FA –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω', reply, 'step-ok');
  } catch(e) {
    updateFlowStep(s, '‚ùå', '–û—à–∏–±–∫–∞ 2FA', e.message, 'step-err');
  }

  await sleep(2500);
  await loadBots();
  addFlowStep('‚úÖ', '–ì–æ—Ç–æ–≤–æ!', '–ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –ë–æ—Ç—ã.', 'step-ok');
  loginFlowRunning = false;
  document.getElementById('loginFlowDone').style.display = 'block';
  setTimeout(loadAccountsPage, 2000);
}

async function pasteClipboard2FA() {
  try {
    const text = (await navigator.clipboard.readText()).trim().replace(/\s/g, '').toUpperCase();
    if (/^[A-Z0-9]{5,8}$/.test(text)) {
      document.getElementById('loginFlow2FAInput').value = text;
      toast('üìã –ö–æ–¥ –≤—Å—Ç–∞–≤–ª–µ–Ω', 't-ok');
    } else { toast('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—É—Ñ–µ—Ä–µ', 't-warn'); }
  } catch { toast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É', 't-warn'); }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ‚ïê‚ïê IDLE PAGE ‚ïê‚ïê
// Known game names cache for display
const KNOWN_GAMES = {
  730:'CS2', 440:'TF2', 570:'Dota 2', 271590:'GTA V', 1091500:'Cyberpunk 2077',
  1172470:'Apex Legends', 578080:'PUBG', 252490:'Rust', 304930:'Unturned',
  346110:'ARK', 440900:'Trove', 753:'Steam'
};

// Per-bot selected game state (before saving)
let idleGamesState = {}; // { botName: [appid, ...] }
// Track which bot's input field we're focused on
let idleActiveBotInput = null;

async function loadIdlePage() {
  const el = document.getElementById('idleBotList');
  if (!el) return;
  const names = Object.keys(botsCache);
  if (!names.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üéÆ</div><div class="empty-state-text">–ù–µ—Ç –±–æ—Ç–æ–≤</div></div>';
    return;
  }

  // Load current config for each bot to get GamesPlayedWhileIdle
  el.innerHTML = '<div class="loading-state"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥–æ–≤‚Ä¶</div>';
  const configs = {};
  for (const name of names) {
    try {
      const res = await api(`/Bot/${name}`);
      configs[name] = res?.Result?.[name] || {};
    } catch { configs[name] = {}; }
  }

  // Init state from current config
  for (const name of names) {
    if (!idleGamesState[name]) {
      idleGamesState[name] = [...(configs[name].GamesPlayedWhileIdle || [])];
    }
  }

  el.innerHTML = names.map(name => {
    const bot = botsCache[name];
    const cls = botClass(bot);
    const games = idleGamesState[name] || [];
    const isRunning = cls !== 'bc-offline';
    const currentIdling = (configs[name]?.GamesPlayedWhileIdle || []).length > 0;

    return `<div class="idle-bot-card" id="idlecard-${esc(name)}">
      <div class="idle-bot-card-header">
        <div class="bot-avatar-sm" style="width:36px;height:36px;">
          ${isRunning ? `<div class="bot-ring-sm ${botRingClass(bot)}"></div>` : ''}
          <span style="position:relative;z-index:2;font-size:16px;">ü§ñ</span>
        </div>
        <div style="flex:1;min-width:0;">
          <div style="font-family:'Rajdhani',sans-serif;font-weight:700;font-size:15px;">${esc(name)}</div>
          <div style="font-size:11px;color:var(--text3);margin-top:1px;">
            ${botStatusBadge(bot)}
            ${currentIdling ? `<span style="margin-left:6px;font-size:10px;color:var(--gold);">‚è± –ö—Ä—É—Ç–∏—Ç ${configs[name].GamesPlayedWhileIdle.length} –∏–≥—Ä</span>` : '<span style="margin-left:6px;font-size:10px;color:var(--text3);">Idle –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>'}
          </div>
        </div>
        <div style="display:flex;gap:7px;">
          <button class="btn btn-ghost btn-sm" onclick="clearIdleGames('${esc(name)}')" title="–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
          <button class="btn btn-primary btn-sm" onclick="saveIdleGames('${esc(name)}')">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div style="padding:14px 16px;">
        <!-- Tag display -->
        <div id="idletags-${esc(name)}" style="display:flex;flex-wrap:wrap;gap:6px;min-height:32px;margin-bottom:12px;">
          ${renderIdleTags(name)}
        </div>
        <!-- Input row -->
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="form-input" id="idleinput-${esc(name)}"
            placeholder="AppID –∏–≥—Ä—ã (–Ω–∞–ø—Ä. 730) –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª/–∑–∞–ø—è—Ç—É—é"
            style="font-family:'JetBrains Mono',monospace;font-size:13px;"
            onfocus="idleActiveBotInput='${esc(name)}'"
            onkeydown="if(event.key==='Enter'){addIdleGamesFromInput('${esc(name)}');event.preventDefault();}">
          <button class="btn btn-gold" onclick="addIdleGamesFromInput('${esc(name)}')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
        ${games.length === 0 ? `<div style="font-size:11px;color:var(--text3);margin-top:8px;">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç ‚Äî –±–æ—Ç –Ω–µ –±—É–¥–µ—Ç –∫—Ä—É—Ç–∏—Ç—å —á–∞—Å—ã –≤ –ø—Ä–æ—Å—Ç–æ–µ</div>` : ''}
      </div>
    </div>`;
  }).join('');

  // Set focused bot to first one
  if (names.length) idleActiveBotInput = names[0];
}

function renderIdleTags(name) {
  const games = idleGamesState[name] || [];
  if (!games.length) return `<span style="color:var(--text3);font-size:12px;padding:4px 0;">–ò–≥—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</span>`;
  return games.map(id => {
    const gname = KNOWN_GAMES[id] || '';
    return `<span class="idle-game-tag">
      ${gname ? `<span>${gname}</span>` : ''}<code>${id}</code>
      <span class="remove-tag" onclick="removeIdleGame('${esc(name)}',${id})">√ó</span>
    </span>`;
  }).join('');
}

function refreshIdleTags(name) {
  const el = document.getElementById(`idletags-${esc(name)}`);
  if (el) el.innerHTML = renderIdleTags(name);
}

function addIdleGameQuick(appid, gameName) {
  // Add to the currently focused bot, or show selector
  const target = idleActiveBotInput || Object.keys(botsCache)[0];
  if (!target) { toast('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî –∫–ª–∏–∫–Ω–∏ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω—É–∂–Ω–æ–≥–æ –±–æ—Ç–∞', 't-warn'); return; }
  if (!idleGamesState[target]) idleGamesState[target] = [];
  if (!idleGamesState[target].includes(appid)) {
    idleGamesState[target].push(appid);
    if (gameName) KNOWN_GAMES[appid] = gameName;
    refreshIdleTags(target);
    toast(`üéÆ ${gameName} (${appid}) ‚Üí ${target}`, 't-ok');
  } else {
    toast(`${gameName} —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ ${target}`, 't-warn');
  }
}

function addIdleGamesFromInput(name) {
  const input = document.getElementById(`idleinput-${name}`);
  if (!input) return;
  const raw = input.value.trim();
  if (!raw) return;
  const ids = raw.split(/[\s,;]+/).map(s => parseInt(s)).filter(n => !isNaN(n) && n > 0);
  if (!ids.length) { toast('–í–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π AppID (—á–∏—Å–ª–æ)', 't-err'); return; }
  if (!idleGamesState[name]) idleGamesState[name] = [];
  let added = 0;
  for (const id of ids) {
    if (!idleGamesState[name].includes(id)) { idleGamesState[name].push(id); added++; }
  }
  input.value = '';
  refreshIdleTags(name);
  if (added) toast(`‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ ${added} –∏–≥—Ä`, 't-ok');
  else toast('–í—Å–µ —ç—Ç–∏ –∏–≥—Ä—ã —É–∂–µ –≤ —Å–ø–∏—Å–∫–µ', 't-warn');
}

function removeIdleGame(name, appid) {
  if (!idleGamesState[name]) return;
  idleGamesState[name] = idleGamesState[name].filter(id => id !== appid);
  refreshIdleTags(name);
}

function clearIdleGames(name) {
  idleGamesState[name] = [];
  refreshIdleTags(name);
  toast(`üóë –°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω –¥–ª—è ${name}`, 't-inf');
}

async function saveIdleGames(name) {
  const games = idleGamesState[name] || [];
  try {
    // Fetch current config first to merge
    const res = await api(`/Bot/${name}`);
    const current = res?.Result?.[name] || {};
    const updated = { ...current, GamesPlayedWhileIdle: games };
    await api(`/Bot/${name}`, 'POST', updated);
    const msg = games.length
      ? `‚úÖ ${name}: –±—É–¥–µ—Ç –∫—Ä—É—Ç–∏—Ç—å ${games.length} –∏–≥—Ä –≤ idle`
      : `‚úÖ ${name}: idle –æ—Ç–∫–ª—é—á—ë–Ω`;
    toast(msg, 't-ok');
    // Reload page to show updated state
    setTimeout(loadIdlePage, 800);
  } catch(e) {
    toast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + e.message, 't-err');
  }
}

async function saveAllIdleGames() {
  const names = Object.keys(botsCache);
  let ok = 0;
  for (const name of names) {
    try {
      const res = await api(`/Bot/${name}`);
      const current = res?.Result?.[name] || {};
      const games = idleGamesState[name] || [];
      await api(`/Bot/${name}`, 'POST', { ...current, GamesPlayedWhileIdle: games });
      ok++;
    } catch {}
  }
  toast(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –¥–ª—è ${ok}/${names.length} –±–æ—Ç–æ–≤`, 't-ok');
  setTimeout(loadIdlePage, 800);
}

// ‚ïê‚ïê LOOT PAGE ‚ïê‚ïê
function loadLootPage() {
  const el = document.getElementById('lootBotList');
  if (!el) return;
  const names = Object.keys(botsCache);
  if (!names.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üí∞</div><div class="empty-state-text">–ù–µ—Ç –±–æ—Ç–æ–≤</div></div>';
    return;
  }
  el.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px;">` + names.map(n => {
    const bot = botsCache[n];
    const cards = cardsRemaining(bot);
    const cls = botClass(bot);
    const online = cls !== 'bc-offline';
    return `<div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);border-radius:8px;">
      <div class="bot-avatar-sm">
        ${online ? `<div class="bot-ring-sm ${botRingClass(bot)}"></div>` : ''}
        <span style="position:relative;z-index:2;">ü§ñ</span>
      </div>
      <div style="flex:1;min-width:0;">
        <div style="font-family:'Rajdhani',sans-serif;font-weight:700;font-size:14px;">${esc(n)}</div>
        <div style="font-size:11px;color:var(--text3);">${botStatusBadge(bot)} &nbsp; üÉè ${cards} –∫–∞—Ä—Ç–æ—á–µ–∫</div>
      </div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;">
        <button class="btn btn-ghost btn-sm" onclick="lootBotGame('${esc(n)}','730')" ${!online?'disabled title="–ë–æ—Ç –æ—Ñ—Ñ–ª–∞–π–Ω"':''}>üî´ CS2</button>
        <button class="btn btn-ghost btn-sm" onclick="lootBotGame('${esc(n)}','440')" ${!online?'disabled':''}>üé© TF2</button>
        <button class="btn btn-ghost btn-sm" onclick="lootBotGame('${esc(n)}','570')" ${!online?'disabled':''}>‚öîÔ∏è Dota2</button>
        <button class="btn btn-cyan btn-sm" onclick="lootBotCards('${esc(n)}')" ${!online?'disabled':''}>üÉè –ö–∞—Ä—Ç–æ—á–∫–∏</button>
        <button class="btn btn-gold btn-sm" onclick="lootBot('${esc(n)}')" ${!online?'disabled':''}>üí∞ –í–µ—Å—å –ª—É—Ç</button>
      </div>
    </div>`;
  }).join('') + `</div>`;
}

async function lootBotGame(name, appid) {
  try {
    const cmd = `loot@${name} ${appid}`;
    await api(`/Bot/${name}/Command`, 'POST', { Command: `loot ${appid}` });
    toast(`üí∞ Loot AppID ${appid} ‚Üí ${name}`, 't-ok');
  } catch {
    // fallback: try generic loot
    try { await api(`/Bot/${name}/Loot`, 'POST'); toast(`üí∞ Loot ${name}`, 't-ok'); }
    catch { toast('–û—à–∏–±–∫–∞ loot', 't-err'); }
  }
}

async function lootBotCards(name) {
  try {
    await api(`/Bot/${name}/Command`, 'POST', { Command: `loot^ ${name}` });
    toast(`üÉè –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Üí ${name}`, 't-ok');
  } catch {
    try { await api(`/Bot/${name}/Loot`, 'POST'); toast(`üÉè Loot ${name}`, 't-ok'); }
    catch { toast('–û—à–∏–±–∫–∞', 't-err'); }
  }
}

async function sendLootGame(appid) {
  const targetId = document.getElementById('lootTargetId').value.trim();
  const botSel   = document.getElementById('lootSourceBot').value || 'ASF';
  if (!targetId) { toast('–£–∫–∞–∂–∏ SteamID –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 't-err'); return; }
  try {
    await api(`/Bot/${botSel}/Command`, 'POST', { Command: `transfer^ ${appid} ${targetId}` });
    toast(`üì§ –¢—Ä–µ–π–¥ App ${appid} ‚Üí ${targetId}`, 't-ok');
  } catch { toast('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏', 't-err'); }
}

async function sendLootCards() {
  const targetId = document.getElementById('lootTargetId').value.trim();
  const botSel   = document.getElementById('lootSourceBot').value || 'ASF';
  if (!targetId) { toast('–£–∫–∞–∂–∏ SteamID –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 't-err'); return; }
  try {
    await api(`/Bot/${botSel}/Command`, 'POST', { Command: `transfer^ 753 ${targetId}` });
    toast(`üÉè –ö–∞—Ä—Ç–æ—á–∫–∏ ‚Üí ${targetId}`, 't-ok');
  } catch { toast('–û—à–∏–±–∫–∞', 't-err'); }
}

async function sendLootAll() {
  const targetId = document.getElementById('lootTargetId').value.trim();
  const botSel   = document.getElementById('lootSourceBot').value || 'ASF';
  if (!targetId) { toast('–£–∫–∞–∂–∏ SteamID –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 't-err'); return; }
  try {
    await api(`/Bot/${botSel}/Command`, 'POST', { Command: `transfer ${targetId}` });
    toast(`üí∞ –í–µ—Å—å –ª—É—Ç ‚Üí ${targetId}`, 't-ok');
  } catch { toast('–û—à–∏–±–∫–∞', 't-err'); }
}

// ‚ïê‚ïê TRADE SEND (from Trades page) ‚ïê‚ïê
function tradeLog(msg, cls='log-ok') {
  const out = document.getElementById('tradeLog');
  if (!out) return;
  const ts = new Date().toLocaleTimeString();
  out.innerHTML += `<div class="log-line"><span class="log-time">${ts}</span><span class="${cls}"> ${esc(msg)}</span></div>`;
  out.scrollTop = out.scrollHeight;
}

async function sendTradeByGame(appid) {
  const toId    = document.getElementById('tradeToId').value.trim();
  const botSel  = document.getElementById('tradeFromBot').value || 'ASF';
  const token   = document.getElementById('tradeToken').value.trim();
  if (!toId) { toast('–£–∫–∞–∂–∏ SteamID –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 't-err'); return; }
  const cmd = token ? `transfer^ ${appid} ${toId} ${token}` : `transfer^ ${appid} ${toId}`;
  tradeLog(`üì§ –û—Ç–ø—Ä–∞–≤–ª—è—é App ${appid} ‚Üí ${toId} (–±–æ—Ç: ${botSel})`, 'log-warn');
  try {
    const res = await api(`/Bot/${botSel}/Command`, 'POST', { Command: cmd });
    const reply = res?.Result || res?.Message || 'OK';
    tradeLog(`‚úÖ ${reply}`, 'log-ok');
    toast(`üì§ –¢—Ä–µ–π–¥ App ${appid} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 't-ok');
  } catch(e) { tradeLog(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'log-err'); toast('–û—à–∏–±–∫–∞ —Ç—Ä–µ–π–¥–∞', 't-err'); }
}

async function sendTradeAll() {
  const toId   = document.getElementById('tradeToId').value.trim();
  const botSel = document.getElementById('tradeFromBot').value || 'ASF';
  const token  = document.getElementById('tradeToken').value.trim();
  if (!toId) { toast('–£–∫–∞–∂–∏ SteamID –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 't-err'); return; }
  const cmd = token ? `transfer ${toId} ${token}` : `transfer ${toId}`;
  tradeLog(`üí∞ –û—Ç–ø—Ä–∞–≤–ª—è—é –≤–µ—Å—å –ª—É—Ç ‚Üí ${toId} (–±–æ—Ç: ${botSel})`, 'log-warn');
  try {
    const res = await api(`/Bot/${botSel}/Command`, 'POST', { Command: cmd });
    const reply = res?.Result || res?.Message || 'OK';
    tradeLog(`‚úÖ ${reply}`, 'log-ok');
    toast(`üí∞ –í–µ—Å—å –ª—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Üí ${toId}`, 't-ok');
  } catch(e) { tradeLog(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'log-err'); toast('–û—à–∏–±–∫–∞', 't-err'); }
}

// ‚ïê‚ïê 2FA PAGE TABS ‚ïê‚ïê
function switch2FATab(tab, el) {
  document.querySelectorAll('[id^="twofa-tab-"]').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('twofa-panel-codes').style.display = tab === 'codes' ? '' : 'none';
  document.getElementById('twofa-panel-login').style.display = tab === 'login' ? '' : 'none';
  if (tab === 'codes') load2FA();
  if (tab === 'login') {
    // Populate loginBotSel
    const names = Object.keys(botsCache);
    const sel = document.getElementById('loginBotSel');
    if (sel) sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ ‚Äî</option>' + names.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');
  }
}

// Auto-fill 2FA from clipboard
async function autoFill2FACode() {
  try {
    const text = await navigator.clipboard.readText();
    const code = text.trim().replace(/\s/g,'');
    if (/^[A-Z0-9]{5}$/i.test(code)) {
      document.getElementById('login2FACode').value = code.toUpperCase();
      toast('üìã –ö–æ–¥ –≤—Å—Ç–∞–≤–ª–µ–Ω', 't-ok');
    } else {
      toast('–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±—É—Ñ–µ—Ä–µ', 't-warn');
    }
  } catch { toast('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –±—É—Ñ–µ—Ä—É', 't-warn'); }
}

// Show current 2FA code for selected bot on login page
document.addEventListener('change', async function(e) {
  if (e.target.id !== 'loginBotSel') return;
  const name = e.target.value;
  const el = document.getElementById('loginCurrentBotCode');
  if (!name || !el) { if(el) el.innerHTML = '–í—ã–±–µ—Ä–∏ –±–æ—Ç–∞ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –∫–æ–¥'; return; }
  el.innerHTML = '<div class="loading-state" style="padding:8px;"><div class="spinner"></div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–¥–∞‚Ä¶</div>';
  try {
    const res = await api(`/Bot/${name}/TwoFactorAuthentication/Token`);
    const data = res?.Result;
    if (data) {
      el.innerHTML = `
        <div class="twofa-code" style="font-size:28px;letter-spacing:6px;padding:14px;">${data.Token||'‚Äî'}</div>
        <div class="twofa-timer"><div class="twofa-timer-fill" style="width:${data.SteamTimeLeft!=null?data.SteamTimeLeft/30*100:0}%"></div></div>
        <div style="font-size:11px;color:var(--text3);margin-top:6px;">${data.SteamTimeLeft||''}—Å –¥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</div>
        <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="document.getElementById('login2FACode').value='${data.Token||''}';toast('‚úÖ –ö–æ–¥ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –ø–æ–ª–µ','t-ok')">üìã –í—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–æ–ª–µ</button>`;
    } else {
      el.textContent = '–ù–µ—Ç –∫–æ–¥–∞ (2FA –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω?)';
    }
  } catch { el.textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–¥–∞'; }
});

// Login with 2FA code
async function doLoginWith2FA() {
  const bot    = document.getElementById('loginBotSel').value;
  const login  = document.getElementById('loginUser').value.trim();
  const pass   = document.getElementById('loginPass').value;
  const code   = document.getElementById('login2FACode').value.trim().toUpperCase();
  const status = document.getElementById('loginStatus');

  if (!login || !pass) { toast('–í–≤–µ–¥–∏ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å', 't-err'); return; }
  if (!code || code.length < 5) { toast('–í–≤–µ–¥–∏ 5-–∑–Ω–∞—á–Ω—ã–π 2FA –∫–æ–¥', 't-err'); return; }

  status.innerHTML = '<div class="loading-state" style="padding:8px;"><div class="spinner"></div>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è‚Ä¶</div>';

  // Strategy: if bot selected ‚Äî update its credentials and resume
  // Otherwise use ASF command for login
  try {
    if (bot) {
      // Set credentials via config update
      await api(`/Bot/${bot}`, 'POST', {
        SteamLogin: login,
        SteamPassword: pass,
        SteamParentalCode: ''
      });
      // Send 2FA code via command
      const res = await api(`/Bot/${bot}/Command`, 'POST', { Command: `2faok ${code}` });
      const reply = res?.Result || res?.Message || '';
      status.innerHTML = `<div class="key-result key-ok">‚úÖ ${esc(reply || '–ö–æ–º–∞–Ω–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞')}. –ë–æ—Ç –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è‚Ä¶</div>`;
      toast(`üîê ${bot} –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω`, 't-ok');
      // Resume bot
      try { await api(`/Bot/${bot}/Resume`, 'POST'); } catch {}
    } else {
      // No bot selected: try global command
      const res = await api('/Command', 'POST', { Command: `2faok ${code}` });
      const reply = res?.Result || res?.Message || 'OK';
      status.innerHTML = `<div class="key-result key-ok">‚úÖ ${esc(reply)}</div>`;
      toast('üîê 2FA –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω', 't-ok');
    }
    setTimeout(loadBots, 2500);
  } catch(e) {
    status.innerHTML = `<div class="key-result key-err">‚ùå –û—à–∏–±–∫–∞: ${esc(e.message)}</div>`;
    toast('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 't-err');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê WEBSOCKET LIVE UPDATES ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let wsConn = null;
let wsReconnectTimer = null;
let wsEnabled = false;

function connectWebSocket() {
  if (wsConn && wsConn.readyState < 2) return;
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  const url = `${proto}://${API_HOST}:${API_PORT}/Api/NLog`;
  setWsStatus('wait');
  try {
    wsConn = new WebSocket(url);
    wsConn.onopen = () => { wsEnabled = true; setWsStatus('live'); clearInterval(wsReconnectTimer); };
    wsConn.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);
        // NLog message ‚Äî append to log areas
        const msg = data?.Message || data?.Data || String(e.data);
        appendLiveLog(msg);
        // If bot status changes detected, refresh bots
        if (/loggedon|disconnected|connected|farming|cards|started|stopped/i.test(msg)) {
          debounceRefreshBots();
        }
      } catch { appendLiveLog(String(e.data)); }
    };
    wsConn.onclose = () => {
      wsEnabled = false; setWsStatus('off');
      wsReconnectTimer = setTimeout(connectWebSocket, 8000);
    };
    wsConn.onerror = () => { wsEnabled = false; setWsStatus('off'); };
  } catch { setWsStatus('off'); }
}

function setWsStatus(state) {
  const dot = document.getElementById('wsDot');
  const lbl = document.getElementById('wsLabel');
  if (!dot || !lbl) return;
  dot.className = 'ws-dot' + (state === 'live' ? ' live' : state === 'wait' ? ' wait' : '');
  lbl.textContent = state === 'live' ? 'Live' : state === 'wait' ? '–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ‚Ä¶' : 'Polling';
}

function appendLiveLog(msg) {
  const t = esc(String(msg));
  let cls = 'log-info';
  if (/error|exception|fail/i.test(t)) cls = 'log-err';
  else if (/warn/i.test(t)) cls = 'log-warn';
  else if (/success|card|farm|redeem/i.test(t)) cls = 'log-ok';
  const line = `<div class="log-line"><span class="${cls}">${t}</span></div>`;
  ['fullLog','dashLog'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.innerHTML += line; el.scrollTop = el.scrollHeight; }
  });
}

let _refreshBotsTimer = null;
function debounceRefreshBots() {
  clearTimeout(_refreshBotsTimer);
  _refreshBotsTimer = setTimeout(loadBots, 1200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê FAVORITES ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FAV_KEY = 'sf_favorites';
function getFavorites() { try { return JSON.parse(localStorage.getItem(FAV_KEY) || '[]'); } catch { return []; } }
function saveFavorites(arr) { localStorage.setItem(FAV_KEY, JSON.stringify(arr)); }

function toggleFav(name) {
  const favs = getFavorites();
  const idx = favs.indexOf(name);
  if (idx === -1) { favs.push(name); toast(`‚≠ê ${name} –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–º`, 't-ok'); }
  else { favs.splice(idx, 1); toast(`${name} —É–±—Ä–∞–Ω –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ`, 't-inf'); }
  saveFavorites(favs);
  renderFilteredBots();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê AUTO-RESTART MONITOR ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AR_KEY = 'sf_autorestart';
function getAutoRestart() { try { return JSON.parse(localStorage.getItem(AR_KEY) || '[]'); } catch { return []; } }
function saveAutoRestart(arr) { localStorage.setItem(AR_KEY, JSON.stringify(arr)); }

function toggleAutoRestart(name) {
  const ar = getAutoRestart();
  const idx = ar.indexOf(name);
  if (idx === -1) { ar.push(name); toast(`‚ü≥ –ê–≤—Ç–æ-—Ä–µ—Å—Ç–∞—Ä—Ç –≤–∫–ª—é—á—ë–Ω –¥–ª—è ${name}`, 't-ok'); }
  else { ar.splice(idx, 1); toast(`–ê–≤—Ç–æ-—Ä–µ—Å—Ç–∞—Ä—Ç –≤—ã–∫–ª—é—á–µ–Ω –¥–ª—è ${name}`, 't-inf'); }
  saveAutoRestart(ar);
  renderFilteredBots();
}

// Called on each loadBots cycle ‚Äî check if AR bots are offline and restart
async function checkAutoRestart(names) {
  const ar = getAutoRestart();
  for (const name of ar) {
    const bot = botsCache[name];
    if (!bot) continue;
    const cls = botClass(bot);
    if (cls === 'bc-offline' || cls === 'bc-idle') {
      try {
        await api(`/Bot/${name}/Resume`, 'POST');
        showNotif('–ê–≤—Ç–æ-—Ä–µ—Å—Ç–∞—Ä—Ç', `–ë–æ—Ç ${name} –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω`, '‚ü≥');
      } catch {}
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê COMPACT MODE ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleCompact() {
  const on = document.body.classList.toggle('compact');
  localStorage.setItem('sf_compact', on ? '1' : '0');
  const btn = document.getElementById('compactToggle');
  if (btn) btn.textContent = on ? '‚äû' : '‚äü';
  btn.title = on ? '–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º' : '–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º';
}
function initCompact() {
  if (localStorage.getItem('sf_compact') === '1') {
    document.body.classList.add('compact');
    const btn = document.getElementById('compactToggle');
    if (btn) { btn.textContent = '‚äû'; btn.title = '–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º'; }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê MASS SELECT ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedBots = new Set();
let selectModeOn = false;

function toggleSelectMode() {
  selectModeOn = !selectModeOn;
  document.body.classList.toggle('select-mode', selectModeOn);
  const btn = document.getElementById('selectModeBtn');
  if (btn) { btn.textContent = selectModeOn ? '‚úï –í—ã—Ö–æ–¥' : '‚òë –í—ã–±—Ä–∞—Ç—å'; btn.className = selectModeOn ? 'btn btn-danger btn-sm' : 'btn btn-ghost btn-sm'; }
  if (!selectModeOn) { selectedBots.clear(); updateMassToolbar(); renderFilteredBots(); }
}

function exitSelectMode() {
  selectModeOn = false;
  selectedBots.clear();
  document.body.classList.remove('select-mode');
  const btn = document.getElementById('selectModeBtn');
  if (btn) { btn.textContent = '‚òë –í—ã–±—Ä–∞—Ç—å'; btn.className = 'btn btn-ghost btn-sm'; }
  updateMassToolbar();
  renderFilteredBots();
}

function isSelected(name) { return selectedBots.has(name); }

function toggleBotSelect(name, checked) {
  if (checked) selectedBots.add(name);
  else selectedBots.delete(name);
  const card = document.getElementById(`botcard-${name}`);
  if (card) card.classList.toggle('selected', checked);
  updateMassToolbar();
}

function updateMassToolbar() {
  const tb = document.getElementById('massToolbar');
  const cnt = document.getElementById('massCount');
  if (!tb || !cnt) return;
  const n = selectedBots.size;
  tb.classList.toggle('visible', n > 0 && selectModeOn);
  cnt.textContent = n;
}

async function massAction(action) {
  if (!selectedBots.size) return;
  const names = [...selectedBots];
  let ok = 0;
  for (const name of names) {
    try {
      if (action === 'start')  { await api(`/Bot/${name}/Resume`, 'POST'); ok++; }
      if (action === 'pause')  { await api(`/Bot/${name}/Pause`, 'POST', {Permanent:false}); ok++; }
      if (action === 'loot')   { await api(`/Bot/${name}/Loot`, 'POST'); ok++; }
      if (action === 'delete') { if (confirm(`–£–¥–∞–ª–∏—Ç—å ${names.length} –±–æ—Ç–æ–≤?`)) { await api(`/Bot/${name}`, 'DELETE'); ok++; } else break; }
      if (action === '2fa')    { await api(`/Bot/${name}/Command`, 'POST', {Command:'2fa'}); ok++; }
    } catch {}
  }
  const labels = { start:'‚ñ∂ –ó–∞–ø—É—â–µ–Ω–æ', pause:'‚è∏ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', loot:'üí∞ Loot', delete:'üóë –£–¥–∞–ª–µ–Ω–æ', '2fa':'üîê 2FA' };
  toast(`${labels[action] || action}: ${ok}/${names.length}`, 't-ok');
  setTimeout(() => { loadBots(); exitSelectMode(); }, 1500);
}

function massAssignGroup() {
  const groups = getGroups();
  if (!groups.length) { toast('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π –≥—Ä—É–ø–ø—É', 't-warn'); return; }
  const sel = document.getElementById('massGroupSel');
  if (sel) sel.innerHTML = groups.map(g => `<option value="${g.id}">${esc(g.name)}</option>`).join('');
  closeAllModals();
  document.getElementById('modalMassGroup').classList.add('open');
}

function doMassAssignGroup() {
  const gid = document.getElementById('massGroupSel').value;
  const groups = getGroups();
  const grp = groups.find(g => g.id === gid);
  if (!grp) return;
  selectedBots.forEach(name => { if (!grp.bots.includes(name)) grp.bots.push(name); });
  saveGroups(groups);
  toast(`üë• ${selectedBots.size} –±–æ—Ç–æ–≤ ‚Üí –≥—Ä—É–ø–ø–∞ "${grp.name}"`, 't-ok');
  closeModal('modalMassGroup');
  exitSelectMode();
  renderFilteredBots();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê GROUPS ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GROUPS_KEY = 'sf_groups';
function getGroups() { try { return JSON.parse(localStorage.getItem(GROUPS_KEY) || '[]'); } catch { return []; } }
function saveGroups(arr) { localStorage.setItem(GROUPS_KEY, JSON.stringify(arr)); }
function getBotGroup(name) { return getGroups().find(g => g.bots.includes(name)) || null; }

let selectedGroupColor = '#e63946';

function selectGroupColor(el, color) {
  selectedGroupColor = color;
  document.getElementById('grp-color').value = color;
  document.querySelectorAll('.grp-color').forEach(e => e.style.border = '2px solid transparent');
  el.style.border = `2px solid ${color}`;
}

function openAddGroup() {
  selectedGroupColor = '#e63946';
  document.getElementById('grp-name').value = '';
  document.getElementById('grp-edit-idx').value = '';
  document.getElementById('addGroupTitle').textContent = 'üë• –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É';
  // Reset color picker
  document.querySelectorAll('.grp-color').forEach(e => e.style.border = '2px solid transparent');
  document.querySelector('.grp-color[data-c="#e63946"]').style.border = '2px solid #e63946';
  // Bot checkboxes
  const cb = document.getElementById('grpBotCheckboxes');
  cb.innerHTML = Object.keys(botsCache).map(n =>
    `<label class="form-check"><input type="checkbox" class="grp-bot-chk" value="${esc(n)}"><span style="font-family:'Rajdhani',sans-serif;font-weight:600;">${esc(n)}</span></label>`
  ).join('');
  closeAllModals();
  document.getElementById('modalAddGroup').classList.add('open');
}

function editGroup(idx) {
  const groups = getGroups();
  const g = groups[idx];
  if (!g) return;
  selectedGroupColor = g.color || '#e63946';
  document.getElementById('grp-name').value = g.name;
  document.getElementById('grp-edit-idx').value = String(idx);
  document.getElementById('addGroupTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É';
  document.querySelectorAll('.grp-color').forEach(e => e.style.border = `2px solid ${e.dataset.c === g.color ? g.color : 'transparent'}`);
  const cb = document.getElementById('grpBotCheckboxes');
  cb.innerHTML = Object.keys(botsCache).map(n =>
    `<label class="form-check"><input type="checkbox" class="grp-bot-chk" value="${esc(n)}" ${g.bots.includes(n)?'checked':''}><span style="font-family:'Rajdhani',sans-serif;font-weight:600;">${esc(n)}</span></label>`
  ).join('');
  closeAllModals();
  document.getElementById('modalAddGroup').classList.add('open');
}

function saveGroup() {
  const name = document.getElementById('grp-name').value.trim();
  if (!name) { toast('–í–≤–µ–¥–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã', 't-err'); return; }
  const color = document.getElementById('grp-color').value || '#e63946';
  const bots = [...document.querySelectorAll('.grp-bot-chk:checked')].map(c => c.value);
  const groups = getGroups();
  const editIdx = document.getElementById('grp-edit-idx').value;
  const grp = { id: editIdx !== '' ? groups[parseInt(editIdx)].id : 'grp_' + Date.now(), name, color, bots };
  if (editIdx !== '') groups[parseInt(editIdx)] = grp;
  else groups.push(grp);
  saveGroups(groups);
  toast(`‚úÖ –ì—Ä—É–ø–ø–∞ "${name}" —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`, 't-ok');
  closeModal('modalAddGroup');
  loadGroupsPage();
  renderFilteredBots();
}

function deleteGroup(idx) {
  const groups = getGroups();
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É "${groups[idx]?.name}"?`)) return;
  groups.splice(idx, 1);
  saveGroups(groups);
  toast('üóë –ì—Ä—É–ø–ø–∞ —É–¥–∞–ª–µ–Ω–∞', 't-inf');
  loadGroupsPage();
  renderFilteredBots();
}

function filterByGroup(gid) {
  groupFilter = groupFilter === gid ? null : gid;
  showPage('bots');
  renderFilteredBots();
}

function renderGroupFilterChips() {
  const el = document.getElementById('groupFilterChips');
  if (!el) return;
  const groups = getGroups();
  el.innerHTML = groups.map(g =>
    `<span class="group-chip" style="background:${g.color}18;color:${g.color};border-color:${g.color}33;${groupFilter===g.id?`background:${g.color}33;`:''}" onclick="filterByGroup('${g.id}')">${esc(g.name)}</span>`
  ).join('');
}

async function loadGroupsPage() {
  const el = document.getElementById('groupsList');
  if (!el) return;
  const groups = getGroups();
  if (!groups.length) {
    el.innerHTML = `<div class="empty-state">
      <div class="empty-state-icon">üë•</div>
      <div class="empty-state-text">–ù–µ—Ç –≥—Ä—É–ø–ø ‚Äî —Å–æ–∑–¥–∞–π –ø–µ—Ä–≤—É—é</div>
      <button class="btn btn-primary" style="margin-top:14px;" onclick="openAddGroup()">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>`;
    return;
  }
  el.innerHTML = groups.map((g, idx) => {
    const bots = g.bots.filter(n => botsCache[n]);
    const online = bots.filter(n => botClass(botsCache[n]) !== 'bc-offline').length;
    const farming = bots.filter(n => botClass(botsCache[n]) === 'bc-farming').length;
    return `<div class="group-card">
      <div class="group-card-header">
        <div class="group-dot" style="background:${g.color};box-shadow:0 0 8px ${g.color}88;"></div>
        <div style="flex:1;">
          <div style="font-family:'Rajdhani',sans-serif;font-size:16px;font-weight:700;">${esc(g.name)}</div>
          <div style="font-size:11px;color:var(--text3);">${bots.length} –±–æ—Ç–æ–≤ ¬∑ ${online} –æ–Ω–ª–∞–π–Ω ¬∑ ${farming} —Ñ–∞—Ä–º–∏—Ç</div>
        </div>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-success btn-sm" onclick="groupAction('${g.id}','start')">‚ñ∂ –í—Å–µ</button>
          <button class="btn btn-ghost btn-sm" onclick="groupAction('${g.id}','pause')">‚è∏ –°—Ç–æ–ø</button>
          <button class="btn btn-gold btn-sm" onclick="groupAction('${g.id}','loot')">üí∞ Loot</button>
          <button class="btn btn-cyan btn-sm" onclick="filterByGroup('${g.id}')">üîç –°–º–æ—Ç—Ä–µ—Ç—å</button>
          <button class="btn btn-ghost btn-sm btn-icon" onclick="editGroup(${idx})">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-sm btn-icon" onclick="deleteGroup(${idx})">üóë</button>
        </div>
      </div>
      <div style="padding:12px 16px;display:flex;flex-wrap:wrap;gap:6px;">
        ${bots.length ? bots.map(n => {
          const bot = botsCache[n];
          const cls = botClass(bot);
          const colors = {'bc-online':'var(--green)','bc-farming':'var(--cyan)','bc-idle':'var(--gold)','bc-offline':'var(--text3)'};
          return `<span style="display:inline-flex;align-items:center;gap:4px;padding:3px 9px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:20px;font-size:11px;">
            <span style="width:5px;height:5px;border-radius:50%;background:${colors[cls]};flex-shrink:0;"></span>
            ${esc(n)}
          </span>`;
        }).join('') : '<span style="color:var(--text3);font-size:12px;">–ù–µ—Ç –±–æ—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ</span>'}
      </div>
    </div>`;
  }).join('');
}

async function groupAction(gid, action) {
  const g = getGroups().find(g => g.id === gid);
  if (!g) return;
  let ok = 0;
  for (const name of g.bots) {
    if (!botsCache[name]) continue;
    try {
      if (action === 'start') await api(`/Bot/${name}/Resume`, 'POST');
      if (action === 'pause') await api(`/Bot/${name}/Pause`, 'POST', {Permanent:false});
      if (action === 'loot')  await api(`/Bot/${name}/Loot`, 'POST');
      ok++;
    } catch {}
  }
  const labels = { start:'‚ñ∂ –ó–∞–ø—É—â–µ–Ω–æ', pause:'‚è∏ –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', loot:'üí∞ Loot' };
  toast(`${labels[action]}: ${ok}/${g.bots.length} (${g.name})`, 't-ok');
  setTimeout(loadBots, 1500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê HOURS SYSTEM ‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const HOURS_KEY = 'sf_bot_hours';

function getBotHours() {
  try { return JSON.parse(localStorage.getItem(HOURS_KEY) || '{}'); } catch { return {}; }
}
function saveBotHours(obj) { localStorage.setItem(HOURS_KEY, JSON.stringify(obj)); }

function getHourCategory(hours) {
  if (hours >= 1000) return { label: 'ü•á –í–µ—Ç–µ—Ä–∞–Ω—ã',  sub: '1000+ —á–∞—Å–æ–≤', key: 'veteran', hc: 'var(--green)', min: 1000, max: Infinity };
  if (hours >= 500)  return { label: 'ü•à –û–ø—ã—Ç–Ω—ã–µ',   sub: '500‚Äì999 —á–∞—Å–æ–≤', key: 'expert', hc: 'var(--cyan)', min: 500, max: 999 };
  if (hours >= 100)  return { label: 'ü•â –°—Ä–µ–¥–Ω–∏–µ',   sub: '100‚Äì499 —á–∞—Å–æ–≤', key: 'mid',    hc: 'var(--gold)', min: 100, max: 499 };
  return                     { label: 'üÜï –ù–æ–≤—ã–µ',    sub: '0‚Äì99 —á–∞—Å–æ–≤',   key: 'new',    hc: 'var(--accent)', min: 0, max: 99 };
}

// Progress to next threshold within current category
function hoursProgress(hours) {
  if (hours >= 1000) return 100;
  if (hours >= 500)  return Math.round(((hours - 500) / 500) * 100);
  if (hours >= 100)  return Math.round(((hours - 100) / 400) * 100);
  return Math.round((hours / 100) * 100);
}

function hoursNextThreshold(hours) {
  if (hours >= 1000) return null;
  if (hours >= 500)  return 1000;
  if (hours >= 100)  return 500;
  return 100;
}

function loadHoursPage() {
  const el = document.getElementById('hoursGrid');
  if (!el) return;

  const names  = Object.keys(botsCache);
  const hoursData = getBotHours();

  if (!names.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-state-icon">‚è∞</div><div class="empty-state-text">–ù–µ—Ç –±–æ—Ç–æ–≤</div></div>';
    return;
  }

  // Group by category
  const cats = {
    new:     { label: 'üÜï –ù–æ–≤—ã–µ',    sub: '0 ‚Äì 99 —á–∞—Å–æ–≤',    hc: 'var(--accent)', bots: [] },
    mid:     { label: 'ü•â –°—Ä–µ–¥–Ω–∏–µ',  sub: '100 ‚Äì 499 —á–∞—Å–æ–≤', hc: 'var(--gold)',   bots: [] },
    expert:  { label: 'ü•à –û–ø—ã—Ç–Ω—ã–µ',  sub: '500 ‚Äì 999 —á–∞—Å–æ–≤', hc: 'var(--cyan)',   bots: [] },
    veteran: { label: 'ü•á –í–µ—Ç–µ—Ä–∞–Ω—ã', sub: '1000+ —á–∞—Å–æ–≤',      hc: 'var(--green)', bots: [] },
  };

  names.forEach(name => {
    const hours = hoursData[name] || 0;
    const cat = getHourCategory(hours);
    cats[cat.key].bots.push({ name, hours });
  });

  // Sort each category by hours desc
  Object.values(cats).forEach(c => c.bots.sort((a, b) => b.hours - a.hours));

  el.innerHTML = Object.entries(cats).map(([key, cat]) => {
    const items = cat.bots.map(({ name, hours }) => {
      const bot = botsCache[name];
      const pct = hoursProgress(hours);
      const next = hoursNextThreshold(hours);
      const cls = botClass(bot);
      const dotColors = { 'bc-online': 'var(--green)', 'bc-farming': 'var(--cyan)', 'bc-idle': 'var(--gold)', 'bc-offline': 'var(--text3)' };
      return `<div class="hours-bot-item" style="--hc:${cat.hc};">
        <div style="width:7px;height:7px;border-radius:50%;background:${dotColors[cls]||'var(--text3)'};flex-shrink:0;"></div>
        <div style="flex:1;min-width:0;">
          <div class="hours-bot-name">${esc(name)}</div>
          <div class="hours-progress">
            <div class="hours-progress-fill" style="width:${pct}%;background:${cat.hc};"></div>
          </div>
        </div>
        <div style="text-align:right;">
          <div class="hours-bot-val">${hours}—á</div>
          ${next ? `<div style="font-size:9px;color:var(--text3);margin-top:2px;">‚Üí ${next}—á</div>` : '<div style="font-size:9px;color:var(--green);">MAX</div>'}
        </div>
        <button onclick="quickEditHours('${esc(name)}')" style="background:none;border:none;color:var(--text3);cursor:pointer;font-size:12px;padding:2px 4px;border-radius:4px;" title="–ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Å—ã">‚úèÔ∏è</button>
      </div>`;
    }).join('') || `<div style="padding:14px;text-align:center;color:var(--text3);font-size:12px;">–ù–µ—Ç –±–æ—Ç–æ–≤</div>`;

    return `<div class="hours-col" style="--hc:${cat.hc};">
      <div class="hours-col-header" style="--hc:${cat.hc};">
        <span class="hours-col-count" style="color:${cat.hc};">${cat.bots.length}</span>
        <div class="hours-col-title" style="color:${cat.hc};">${cat.label}</div>
        <div class="hours-col-sub">${cat.sub}</div>
      </div>
      <div class="hours-col-body">${items}</div>
    </div>`;
  }).join('');
}

function openHoursEditor() {
  const names = Object.keys(botsCache);
  const hoursData = getBotHours();
  const el = document.getElementById('hoursEditorList');
  if (!el) return;
  el.innerHTML = names.map(name => {
    const hours = hoursData[name] || 0;
    const cat = getHourCategory(hours);
    return `<div style="display:flex;align-items:center;gap:10px;padding:8px 12px;background:rgba(255,255,255,.03);border-radius:7px;border:1px solid rgba(255,255,255,.05);">
      <div style="flex:1;font-family:'Rajdhani',sans-serif;font-weight:700;">${esc(name)}</div>
      <div style="font-size:10px;color:${cat.hc};background:${cat.hc}18;padding:2px 8px;border-radius:10px;border:1px solid ${cat.hc}33;">${cat.label}</div>
      <input type="number" id="he-${esc(name)}" value="${hours}" min="0" step="1" style="width:90px;font-family:'JetBrains Mono',monospace;font-size:13px;text-align:right;" class="form-input" oninput="previewHoursCat('${esc(name)}',this.value)">
      <div style="font-size:11px;color:var(--text3);width:20px;">—á</div>
    </div>`;
  }).join('');
  closeAllModals();
  document.getElementById('modalHoursEditor').classList.add('open');
}

function previewHoursCat(name, val) {
  // Real-time category label update in editor
  const hours = parseInt(val) || 0;
  const cat = getHourCategory(hours);
  const row = document.getElementById(`he-${name}`)?.closest('div[style]');
  if (!row) return;
  const badge = row.querySelector('div[style*="border-radius:10px"]');
  if (badge) {
    badge.textContent = cat.label;
    badge.style.color = cat.hc;
    badge.style.background = cat.hc + '18';
    badge.style.borderColor = cat.hc + '33';
  }
}

function saveHoursAll() {
  const names = Object.keys(botsCache);
  const hoursData = getBotHours();
  names.forEach(name => {
    const input = document.getElementById(`he-${name}`);
    if (input) hoursData[name] = Math.max(0, parseInt(input.value) || 0);
  });
  saveBotHours(hoursData);
  toast('‚úÖ –ß–∞—Å—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 't-ok');
  closeModal('modalHoursEditor');
  loadHoursPage();
}

function quickEditHours(name) {
  const hoursData = getBotHours();
  const cur = hoursData[name] || 0;
  const val = prompt(`–ß–∞—Å–æ–≤ –¥–ª—è –±–æ—Ç–∞ "${name}":`, cur);
  if (val === null) return;
  const hours = Math.max(0, parseInt(val) || 0);
  hoursData[name] = hours;
  saveBotHours(hoursData);
  const cat = getHourCategory(hours);
  toast(`‚è∞ ${name}: ${hours}—á ‚Üí ${cat.label}`, 't-ok');
  loadHoursPage();
}

// Auto-track hours via idle config ‚Äî if bot has GamesPlayedWhileIdle,
// increment a per-bot session counter every minute while bot is online
let hoursTrackInterval = null;
function startHoursTracking() {
  if (hoursTrackInterval) return;
  hoursTrackInterval = setInterval(() => {
    const hoursData = getBotHours();
    let changed = false;
    Object.entries(botsCache).forEach(([name, bot]) => {
      const idleGames = idleGamesState[name] || [];
      const isIdling = idleGames.length > 0 && botClass(bot) !== 'bc-offline';
      const isFarming = botClass(bot) === 'bc-farming';
      if (isIdling || isFarming) {
        // +1 minute = 1/60 hour, accumulate
        const key = `sf_hours_min_${name}`;
        const mins = (parseInt(localStorage.getItem(key) || '0')) + 1;
        localStorage.setItem(key, String(mins));
        if (mins >= 60) {
          hoursData[name] = (hoursData[name] || 0) + 1;
          localStorage.setItem(key, '0');
          changed = true;
          // Check for threshold crossing
          const prev = (hoursData[name] || 1) - 1;
          const prevCat = getHourCategory(prev);
          const newCat  = getHourCategory(hoursData[name]);
          if (prevCat.key !== newCat.key) {
            showNotif('‚è∞ –ö–∞—Ç–µ–≥–æ—Ä–∏—è —á–∞—Å–æ–≤', `${name} –¥–æ—Å—Ç–∏–≥ ${hoursData[name]}—á ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ "${newCat.label}"`, 'üéâ');
          }
        }
      }
    });
    if (changed) { saveBotHours(hoursData); loadHoursPage(); }
  }, 60000); // every minute
}

// ‚ïê‚ïê UPTIME ‚ïê‚ïê
function updateUptime() {
  const s = Math.floor((Date.now()-startTs)/1000);
  const h = Math.floor(s/3600), m = Math.floor((s%3600)/60), sec = s%60;
  const t = h>0 ? `${h}—á ${m}–º` : m>0 ? `${m}–º ${sec}—Å` : `${sec}—Å`;
  const el = document.getElementById('st-uptime'); if(el) el.textContent = t;
  const el2 = document.getElementById('sTotal-uptime'); if(el2) el2.textContent = t;
  updateRefreshTime();
}

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function esc(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function closeModal(id) { document.getElementById(id)?.classList.remove('open'); }
function closeAllModals() { document.querySelectorAll('.modal-overlay').forEach(m=>m.classList.remove('open')); }
function toast(msg, cls='t-ok') {
  const el = Object.assign(document.createElement('div'), { className:'toast '+cls, textContent:msg });
  document.getElementById('toastWrap').appendChild(el);
  setTimeout(()=>el.remove(), 3500);
}

// ‚ïê‚ïê REFRESH ‚ïê‚ïê
async function refreshAll() {
  await Promise.all([loadBots(), loadVersion(), loadLog()]);
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
fillSettings();
requestNotifications();
initCompact();
refreshAll();
connectWebSocket();
startHoursTracking();
setInterval(refreshAll, 12000);
setInterval(updateUptime, 1000);</script>
</body>
</html>
