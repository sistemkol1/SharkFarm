name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build SharkFarm
        run: dotnet publish SharkFarm/SharkFarm.csproj -r win-x64 -o ./out/win-x64 --self-contained -c Release

      - name: Prepare release structure
        run: |
          New-Item -ItemType Directory -Path "./release/SharkFarm/config"        -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/logs"           -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/plugins"        -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/www"            -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/system/locales" -Force
          Copy-Item "./out/win-x64/*" "./release/SharkFarm/" -Recurse -Force

      - name: Hide locales
        run: |
          Get-ChildItem "./release/SharkFarm/" -Directory | Where-Object {
            $_.Name -match '^[a-z]{2}' -and $_.Name -notin @('config','logs','plugins','www','system')
          } | ForEach-Object {
            Move-Item $_.FullName "./release/SharkFarm/system/locales/"
          }

      - name: Hide system files
        run: |
          New-Item -ItemType Directory -Path "./release/SharkFarm/system/bin" -Force
          Get-ChildItem "./release/SharkFarm/" -File | Where-Object {
            $_.Name -notin @('SharkFarm.exe','LICENSE.txt')
          } | ForEach-Object {
            Move-Item $_.FullName "./release/SharkFarm/system/bin/"
          }

      - name: Copy UI
        run: |
          Copy-Item "www/index.html" "./release/SharkFarm/www/index.html" -Force
          Copy-Item "www/favicon.ico" "./release/SharkFarm/www/favicon.ico" -Force
          [System.IO.File]::WriteAllText("./release/SharkFarm/Open WebUI.url", "[InternetShortcut]`r`nURL=http://localhost:1242/")

      - name: Create ZIP
        run: Compress-Archive -Path "./release/SharkFarm" -DestinationPath "./SharkFarm-win-x64.zip"

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: SharkFarm-win-x64.zip
          name: SharkFarm ${{ github.ref_name }}
          body: |
            ## рџ¦€ SharkFarm ${{ github.ref_name }}

            ### РЈСЃС‚Р°РЅРѕРІРєР°
            1. РЎРєР°С‡Р°Р№ `SharkFarm-win-x64.zip`
            2. Р Р°СЃРїР°РєСѓР№ РІ Р»СЋР±СѓСЋ РїР°РїРєСѓ
            3. Р—Р°РїСѓСЃС‚Рё `SharkFarm.exe`
            4. РћС‚РєСЂРѕР№ Р±СЂР°СѓР·РµСЂ: `http://localhost:1242`

            ### РЎС‚СЂСѓРєС‚СѓСЂР° РїР°РїРѕРє
            - `config/` вЂ” СЃСЋРґР° РєР»Р°РґРё JSON С„Р°Р№Р»С‹ Р°РєРєР°СѓРЅС‚РѕРІ
            - `logs/` вЂ” Р»РѕРіРё СЂР°Р±РѕС‚С‹ РїСЂРѕРіСЂР°РјРјС‹
            - `plugins/` вЂ” РїР»Р°РіРёРЅС‹
            - `www/` вЂ” РІРµР±-РёРЅС‚РµСЂС„РµР№СЃ
            - `system/` вЂ” СЃРёСЃС‚РµРјРЅС‹Рµ С„Р°Р№Р»С‹ (РЅРµ С‚СЂРѕРіР°Р№)
