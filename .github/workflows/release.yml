name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Build SharkFarm
        run: dotnet publish SharkFarm/SharkFarm.csproj -r win-x64 -o ./out/win-x64 --self-contained -c Release

      - name: Prepare release structure
        run: |
          New-Item -ItemType Directory -Path "./release/SharkFarm/config"        -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/logs"           -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/plugins"        -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/www"            -Force
          New-Item -ItemType Directory -Path "./release/SharkFarm/system/locales" -Force
          Copy-Item "./out/win-x64/*" "./release/SharkFarm/" -Recurse -Force

      - name: Hide locales
        run: |
          Get-ChildItem "./release/SharkFarm/" -Directory | Where-Object {
            $_.Name -match '^[a-z]{2}' -and $_.Name -notin @('config','logs','plugins','www','system')
          } | ForEach-Object {
            Move-Item $_.FullName "./release/SharkFarm/system/locales/"
          }

      - name: Hide system files
        run: |
          New-Item -ItemType Directory -Path "./release/SharkFarm/system/bin" -Force
          Get-ChildItem "./release/SharkFarm/" -File | Where-Object {
            $_.Name -notin @('SharkFarm.exe','LICENSE.txt')
          } | ForEach-Object {
            Move-Item $_.FullName "./release/SharkFarm/system/bin/"
          }

      - name: Copy UI
        run: |
          Copy-Item "resources/SharkFarm_WebUI_desktop.html" "./release/SharkFarm/www/index.html" -Force

      - name: Create ZIP
        run: Compress-Archive -Path "./release/SharkFarm" -DestinationPath "./SharkFarm-win-x64.zip"

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          files: SharkFarm-win-x64.zip
          name: SharkFarm ${{ github.ref_name }}
          body: |
            ## ü¶à SharkFarm ${{ github.ref_name }}

            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞
            1. –°–∫–∞—á–∞–π `SharkFarm-win-x64.zip`
            2. –†–∞—Å–ø–∞–∫—É–π –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
            3. –ó–∞–ø—É—Å—Ç–∏ `SharkFarm.exe`
            4. –û—Ç–∫—Ä–æ–π –±—Ä–∞—É–∑–µ—Ä: `http://localhost:1242`

            ### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫
            - `config/` ‚Äî —Å—é–¥–∞ –∫–ª–∞–¥–∏ JSON —Ñ–∞–π–ª—ã –∞–∫–∫–∞—É–Ω—Ç–æ–≤
            - `logs/` ‚Äî –ª–æ–≥–∏ —Ä–∞–±–æ—Ç—ã –ø—Ä–æ–≥—Ä–∞–º–º—ã
            - `plugins/` ‚Äî –ø–ª–∞–≥–∏–Ω—ã
            - `www/` ‚Äî –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            - `system/` ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã (–Ω–µ —Ç—Ä–æ–≥–∞–π)
